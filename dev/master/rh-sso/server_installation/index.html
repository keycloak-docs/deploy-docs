<?xml version='1.0' encoding='UTF-8'?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" class="chrometwo"><head><title>Server Installation and Configuration Guide</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css"/><meta name="generator" content="publican v4.3.3"/><meta name="description" content="This guide consists of information to install and configure Red Hat Single Sign-On 7.2"/><link rel="next" href="#guide_overview" title="Chapter 1. Guide Overview"/><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><script type="text/javascript" src="Common_Content/scripts/jquery-1.7.1.min.js"> </script><script type="text/javascript" src="Common_Content/scripts/utils.js"> </script><script type="text/javascript" src="Common_Content/scripts/highlight.js/highlight.pack.js"> </script></head><body><div id="chrometwo"><div id="main"><div xml:lang="en-US" class="book" id="idm139625625290352"><div class="titlepage"><div><div class="producttitle"><span class="productname">Red Hat Single Sign-On</span> <span class="productnumber">7.2</span></div><div><h1 class="title">Server Installation and Configuration Guide</h1></div><div><h2 class="subtitle">For Use with Red Hat Single Sign-On 7.2</h2></div><div><div xml:lang="en-US" class="authorgroup"><span class="orgname">Red Hat Customer Content Services</span></div></div><div><a href="#idm139625632185056">Legal Notice</a></div><div><div class="abstract"><p class="title"><strong>Abstract</strong></p><div class="para">
				This guide consists of information to install and configure Red Hat Single Sign-On 7.2
			</div></div></div></div><hr/></div><div class="toc"><ul class="toc"><li><span class="chapter"><a href="#guide_overview">1. Guide Overview</a></span><ul><li><span class="section"><a href="#recommended_additional_external_documentation">1.1. Recommended Additional External Documentation</a></span></li></ul></li><li><span class="chapter"><a href="#installation">2. Installation</a></span><ul><li><span class="section"><a href="#system_requirements">2.1. System Requirements</a></span></li><li><span class="section"><a href="#installing_rh_sso_from_a_zip_file">2.2. Installing RH-SSO from a ZIP File</a></span></li><li><span class="section"><a href="#installing_rpm">2.3. Installing RH-SSO from an RPM</a></span><ul><li><span class="section"><a href="#subscribing_EAP_repo">2.3.1. Subscribing to the JBoss EAP 7.0 Repository</a></span></li><li><span class="section"><a href="#subscribing_to_the_rh_sso_7_1_repository_and_installing_rh_sso_7_1">2.3.2. Subscribing to the RH-SSO 7.1 Repository and Installing RH-SSO 7.1</a></span></li></ul></li><li><span class="section"><a href="#distribution_directory_structure">2.4. Distribution Directory Structure</a></span></li></ul></li><li><span class="chapter"><a href="#operating-mode">3. Choosing an Operating Mode</a></span><ul><li><span class="section"><a href="#standalone-mode">3.1. Standalone Mode</a></span><ul><li><span class="section"><a href="#standalone_boot_script">3.1.1. Standalone Boot Script</a></span></li><li><span class="section"><a href="#standalone_configuration">3.1.2. Standalone Configuration</a></span></li></ul></li><li><span class="section"><a href="#standalone-ha-mode">3.2. Standalone Clustered Mode</a></span><ul><li><span class="section"><a href="#standalone_clustered_configuration">3.2.1. Standalone Clustered Configuration</a></span></li><li><span class="section"><a href="#standalone_clustered_boot_script">3.2.2. Standalone Clustered Boot Script</a></span></li></ul></li><li><span class="section"><a href="#domain-mode">3.3. Domain Clustered Mode</a></span><ul><li><span class="section"><a href="#domain_configuration">3.3.1. Domain Configuration</a></span></li><li><span class="section"><a href="#host_controller_configuration">3.3.2. Host Controller Configuration</a></span></li><li><span class="section"><a href="#server_instance_working_directories">3.3.3. Server Instance Working Directories</a></span></li><li><span class="section"><a href="#domain_boot_script">3.3.4. Domain Boot Script</a></span></li><li><span class="section"><a href="#clustered-domain-example">3.3.5. Clustered Domain Example</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#manage_config">4. Manage Subsystem Configuration</a></span><ul><li><span class="section"><a href="#config_spi_providers">4.1. Configure SPI Providers</a></span></li><li><span class="section"><a href="#start_cli">4.2. Start the JBoss EAP CLI</a></span></li><li><span class="section"><a href="#cli_embedded_mode">4.3. CLI Embedded Mode</a></span></li><li><span class="section"><a href="#cli_gui_mode">4.4. CLI GUI Mode</a></span></li><li><span class="section"><a href="#cli_scripting">4.5. CLI Scripting</a></span></li><li><span class="section"><a href="#cli_recipes">4.6. CLI Recipes</a></span><ul><li><span class="section"><a href="#change_the_web_context_of_the_server">4.6.1. Change the web context of the server</a></span></li><li><span class="section"><a href="#set_the_global_default_theme">4.6.2. Set the global default theme</a></span></li><li><span class="section"><a href="#add_a_new_spi_and_a_provider">4.6.3. Add a new SPI and a provider</a></span></li><li><span class="section"><a href="#disable_a_provider">4.6.4. Disable a provider</a></span></li><li><span class="section"><a href="#change_the_default_provider_for_an_spi">4.6.5. Change the default provider for an SPI</a></span></li><li><span class="section"><a href="#configure_the_dblock_spi">4.6.6. Configure the dblock SPI</a></span></li><li><span class="section"><a href="#add_or_change_a_single_property_value_for_a_provider">4.6.7. Add or change a single property value for a provider</a></span></li><li><span class="section"><a href="#remove_a_single_property_from_a_provider">4.6.8. Remove a single property from a provider</a></span></li><li><span class="section"><a href="#set_values_on_a_provider_property_of_type_literal_list_literal">4.6.9. Set values on a provider property of type <code class="literal">List</code></a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#profiles">5. Profiles</a></span></li><li><span class="chapter"><a href="#database">6. Relational Database Setup</a></span><ul><li><span class="section"><a href="#rdbms-setup-checklist">6.1. RDBMS Setup Checklist</a></span></li><li><span class="section"><a href="#package_the_jdbc_driver">6.2. Package the JDBC Driver</a></span></li><li><span class="section"><a href="#declare_and_load_jdbc_driver">6.3. Declare and Load JDBC Driver</a></span></li><li><span class="section"><a href="#modify_the_red_hat_single_sign_on_datasource">6.4. Modify the Red Hat Single Sign-On Datasource</a></span></li><li><span class="section"><a href="#database_configuration">6.5. Database Configuration</a></span></li><li><span class="section"><a href="#unicode_considerations_for_databases">6.6. Unicode Considerations for Databases</a></span><ul><li><span class="section"><a href="#oracle_database">6.6.1. Oracle Database</a></span></li><li><span class="section"><a href="#microsoft_sql_server_database">6.6.2. Microsoft SQL Server Database</a></span></li><li><span class="section"><a href="#ibm_db2_database">6.6.3. IBM DB2 Database</a></span></li><li><span class="section"><a href="#mysql_database">6.6.4. MySQL Database</a></span></li><li><span class="section"><a href="#postgresql_database">6.6.5. PostgreSQL Database</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#network">7. Network Setup</a></span><ul><li><span class="section"><a href="#bind-address">7.1. Bind Addresses</a></span></li><li><span class="section"><a href="#ports">7.2. Socket Port Bindings</a></span></li><li><span class="section"><a href="#setting_up_https_ssl">7.3. Setting up HTTPS/SSL</a></span><ul><li><span class="section"><a href="#enabling_ssl_https_for_the_red_hat_single_sign_on_server">7.3.1. Enabling SSL/HTTPS for the Red Hat Single Sign-On Server</a></span></li></ul></li><li><span class="section"><a href="#outgoing_http_requests">7.4. Outgoing HTTP Requests</a></span><ul><li><span class="section"><a href="#truststore">7.4.1. Outgoing HTTPS Request Truststore</a></span></li></ul></li></ul></li><li><span class="chapter"><a href="#clustering">8. Clustering</a></span><ul><li><span class="section"><a href="#recommended_network_architecture">8.1. Recommended Network Architecture</a></span></li><li><span class="section"><a href="#clustering_example">8.2. Clustering Example</a></span></li><li><span class="section"><a href="#setting-up-a-load-balancer-or-proxy">8.3. Setting Up a Load Balancer or Proxy</a></span><ul><li><span class="section"><a href="#identifying_client_ip_addresses">8.3.1. Identifying Client IP Addresses</a></span></li><li><span class="section"><a href="#enable_https_ssl_with_a_reverse_proxy">8.3.2. Enable HTTPS/SSL with a Reverse Proxy</a></span></li><li><span class="section"><a href="#verify_configuration">8.3.3. Verify Configuration</a></span></li><li><span class="section"><a href="#using_the_built_in_load_balancer">8.3.4. Using the Built-In Load Balancer</a></span></li><li><span class="section"><a href="#configuring_other_load_balancers">8.3.5. Configuring Other Load Balancers</a></span></li></ul></li><li><span class="section"><a href="#sticky_sessions">8.4. Sticky sessions</a></span><ul><li><span class="section"><a href="#example_cluster_setup_with_mod_cluster">8.4.1. Example cluster setup with mod_cluster</a></span></li></ul></li><li><span class="section"><a href="#multicast_network_setup">8.5. Multicast Network Setup</a></span></li><li><span class="section"><a href="#securing_cluster_communication">8.6. Securing Cluster Communication</a></span></li><li><span class="section"><a href="#clustering_db_lock">8.7. Serialized Cluster Startup</a></span></li><li><span class="section"><a href="#booting_the_cluster">8.8. Booting the Cluster</a></span></li><li><span class="section"><a href="#troubleshooting">8.9. Troubleshooting</a></span></li></ul></li><li><span class="chapter"><a href="#server_cache_configuration">9. Server Cache Configuration</a></span><ul><li><span class="section"><a href="#eviction_and_expiration">9.1. Eviction and Expiration</a></span></li><li><span class="section"><a href="#replication_and_failover">9.2. Replication and Failover</a></span></li><li><span class="section"><a href="#disabling_caching">9.3. Disabling Caching</a></span></li><li><span class="section"><a href="#clearing_caches_at_runtime">9.4. Clearing Caches at Runtime</a></span></li></ul></li></ul></div><section class="chapter" id="guide_overview"><div class="titlepage"><div><div><h1 class="title">Chapter 1. Guide Overview</h1></div></div></div><p>
			The purpose of this guide is to walk through the steps that need to be completed prior to booting up the Red Hat Single Sign-On server for the first time. If you just want to test drive Red Hat Single Sign-On, it pretty much runs out of the box with its own embedded and local-only database. For actual deployments that are going to be run in production you’ll need to decide how you want to manage server configuration at runtime (standalone or domain mode), configure a shared database for Red Hat Single Sign-On storage, set up encryption and HTTPS, and finally set up Red Hat Single Sign-On to run in a cluster. This guide walks through each and every aspect of any pre-boot decisions and setup you must do prior to deploying the server.
		</p><p>
			One thing to particularly note is that Red Hat Single Sign-On is derived from the JBoss EAP Application Server. Many aspects of configuring Red Hat Single Sign-On revolve around JBoss EAP configuration elements. Often this guide will direct you to documentation outside of the manual if you want to dive into more detail.
		</p><section class="section" id="recommended_additional_external_documentation"><div class="titlepage"><div><div><h2 class="title">1.1. Recommended Additional External Documentation</h2></div></div></div><p>
				Red Hat Single Sign-On is built on top of the JBoss EAP application server and it’s sub-projects like Infinispan (for caching) and Hibernate (for persistence). This guide only covers basics for infrastructure-level configuration. It is highly recommended that you peruse the documentation for JBoss EAP and its sub projects. Here is the link to the documentation:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						<a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a>
					</li></ul></div></section></section><section class="chapter" id="installation"><div class="titlepage"><div><div><h1 class="title">Chapter 2. Installation</h1></div></div></div><p>
			You can install Red Hat Single Sign-On by downloading a ZIP file and unzipping it, or by using an RPM. This chapter reviews system requirements as well as the directory structure.
		</p><section class="section" id="system_requirements"><div class="titlepage"><div><div><h2 class="title">2.1. System Requirements</h2></div></div></div><p>
				These are the requirements to run the Red Hat Single Sign-On authentication server:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Can run on any operating system that runs Java
					</li><li class="listitem">
						Java 8 JDK
					</li><li class="listitem">
						zip or gzip and tar
					</li><li class="listitem">
						At least 512M of RAM
					</li><li class="listitem">
						At least 1G of diskspace
					</li><li class="listitem">
						A shared external database like Postgres, MySql, Oracle, etc. Red Hat Single Sign-On requires an external shared database if you want to run in a cluster. Please see the <a class="link" href="#database" title="Chapter 6. Relational Database Setup">database configuration</a> section of this guide for more information.
					</li><li class="listitem">
						Network multicast support on your machine if you want to run in a cluster. Red Hat Single Sign-On can be clustered without multicast, but this requires a bunch of configuration changes. Please see the <a class="link" href="#clustering" title="Chapter 8. Clustering">clustering</a> section of this guide for more information.
					</li><li class="listitem">
						On Linux, it is recommended to use <code class="literal">/dev/urandom</code> as a source of random data to prevent Red Hat Single Sign-On hanging due to lack of available entropy, unless <code class="literal">/dev/random</code> usage is mandated by your security policy. To achieve that on Oracle JDK 8 and OpenJDK 8, set the <code class="literal">java.security.egd</code> system property on startup to <code class="literal">file:/dev/urandom</code>.
					</li></ul></div></section><section class="section" id="installing_rh_sso_from_a_zip_file"><div class="titlepage"><div><div><h2 class="title">2.2. Installing RH-SSO from a ZIP File</h2></div></div></div><p>
				The Red Hat Single Sign-On Server is contained in one distribution file: rh-sso-7.2.0.DR4.zip.gz.
			</p><p>
				The rh-sso-7.2.0.DR4.zip.gz archive is the server-only distribution. It contains only the scripts and binaries to run Red Hat Single Sign-On Server.
			</p><p>
				To unpack these files, run the <code class="literal">unzip</code> or <code class="literal">gunzip</code> utility.
			</p></section><section class="section" id="installing_rpm"><div class="titlepage"><div><div><h2 class="title">2.3. Installing RH-SSO from an RPM</h2></div></div></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					With Red Hat Enterprise Linux 7, the term channel was replaced with the term repository. In these instructions only the term repository is used.
				</p></div></div><p>
				You must subscribe to both the JBoss EAP 7.0 and RH-SSO 7.1 repositories before you can install RH-SSO from an RPM.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					You cannot continue to receive upgrades to EAP 7.0 RPMs but stop receiving updates for RH-SSO.
				</p></div></div><section class="section" id="subscribing_EAP_repo"><div class="titlepage"><div><div><h3 class="title">2.3.1. Subscribing to the JBoss EAP 7.0 Repository</h3></div></div></div><div class="orderedlist"><p class="title"><strong>Prerequisites</strong></p><ol class="orderedlist" type="1"><li class="listitem">
							Ensure that your Red Hat Enterprise Linux system is registered to your account using Red Hat Subscription Manager. For more information see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index">Red Hat Subscription Management documentation</a>.
						</li><li class="listitem">
							If you are already subscribed to another JBoss EAP repository, you must unsubscribe from that repository first.
						</li></ol></div><p>
					Using Red Hat Subscription Manager, subscribe to the JBoss EAP 7.0 repository using the following command. Replace &lt;RHEL_VERSION&gt; with either 6 or 7 depending on your Red Hat Enterprise Linux version.
				</p><pre class="literallayout">subscription-manager repos --enable=jb-eap-7.0-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms</pre></section><section class="section" id="subscribing_to_the_rh_sso_7_1_repository_and_installing_rh_sso_7_1"><div class="titlepage"><div><div><h3 class="title">2.3.2. Subscribing to the RH-SSO 7.1 Repository and Installing RH-SSO 7.1</h3></div></div></div><div class="orderedlist"><p class="title"><strong>Prerequisites</strong></p><ol class="orderedlist" type="1"><li class="listitem">
							Ensure that your Red Hat Enterprise Linux system is registered to your account using Red Hat Subscription Manager. For more information see the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index">Red Hat Subscription Management documentation</a>.
						</li><li class="listitem">
							Ensure that you have already subscribed to the JBoss EAP 7.0 repository. For more information see <a class="link" href="#subscribing_EAP_repo" title="2.3.1. Subscribing to the JBoss EAP 7.0 Repository">Subscribing to the JBoss EAP 7.0 repository</a>.
						</li></ol></div><p>
					To subscribe to the RH-SSO 7.1 repository and install RH-SSO 7.1, complete the following steps:
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
							Using Red Hat Subscription Manager, subscribe to the RH-SSO 7.1 repository using the following command. Replace &lt;RHEL_VERSION&gt; with either 6 or 7 depending on your Red Hat Enterprise Linux version.
						</p><pre class="literallayout">subscription-manager repos --enable=rh-sso-7.1-for-rhel-&lt;RHEL-VERSION&gt;-server-rpms</pre></li><li class="listitem"><p class="simpara">
							Install RH-SSO from your subscribed RH-SSO 7.1 repository using the following command:
						</p><pre class="literallayout">yum groupinstall rh-sso7</pre></li></ol></div><p>
					Your installation is complete. The default RH-SSO_HOME path for the RPM installation is /opt/rh/rh-sso7/root/usr/share/keycloak.
				</p></section></section><section class="section" id="distribution_directory_structure"><div class="titlepage"><div><div><h2 class="title">2.4. Distribution Directory Structure</h2></div></div></div><p>
				This chapter walks you through the directory structure of the server distribution.
			</p><div class="formalpara"><p class="title"><strong>distribution directory structure</strong></p><p>
					<span class="inlinemediaobject"><img src="images/rhsso-images/files.png" alt="distribution"/></span>
				</p></div><p>
				Let’s examine the purpose of some of the directories:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term"><span class="emphasis"><em>bin/</em></span></span></dt><dd>
							This contains various scripts to either boot the server or perform some other management action on the server.
						</dd><dt><span class="term"><span class="emphasis"><em>domain/</em></span></span></dt><dd>
							This contains configuration files and working directory when running Red Hat Single Sign-On in <a class="link" href="#domain-mode" title="3.3. Domain Clustered Mode">domain mode</a>.
						</dd><dt><span class="term"><span class="emphasis"><em>modules/</em></span></span></dt><dd>
							These are all the Java libraries used by the server.
						</dd><dt><span class="term"><span class="emphasis"><em>standalone/</em></span></span></dt><dd>
							This contains configuration files and working directory when running Red Hat Single Sign-On in <a class="link" href="#standalone-mode" title="3.1. Standalone Mode">standalone mode</a>.
						</dd><dt><span class="term"><span class="emphasis"><em>themes/</em></span></span></dt><dd>
							This directory contains all the html, style sheets, javascript files, and images used to display any UI screen displayed by the server. Here you can modify an existing theme or create your own. See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.2/html-single/server_developer_guide/">Server Developer Guide</a> for more information on this.
						</dd></dl></div></section></section><section class="chapter" id="operating-mode"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Choosing an Operating Mode</h1></div></div></div><p>
			Before deploying Red Hat Single Sign-On in a production environment you need to decide which type of operating mode you are going to use. Will you run Red Hat Single Sign-On within a cluster? Do you want a centralized way to manage your server configurations? Your choice of operating mode effects how you configure databases, configure caching and even how you boot the server.
		</p><div class="admonition tip"><div class="admonition_header">Tip</div><div><p>
			The Red Hat Single Sign-On is built on top of the JBoss EAP Application Server. This guide will only go over the basics for deployment within a specific mode. If you want specific information on this, a better place to go would be the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a>.
		</p></div></div><section class="section" id="standalone-mode"><div class="titlepage"><div><div><h2 class="title">3.1. Standalone Mode</h2></div></div></div><p>
				Standalone operating mode is only useful when you want to run one, and only one Red Hat Single Sign-On server instance. It is not usable for clustered deployments and all caches are non-distributed and local-only. It is not recommended that you use standalone mode in production as you will have a single point of failure. If your standalone mode server goes down, users will not be able to log in. This mode is really only useful to test drive and play with the features of Red Hat Single Sign-On
			</p><section class="section" id="standalone_boot_script"><div class="titlepage"><div><div><h3 class="title">3.1.1. Standalone Boot Script</h3></div></div></div><p>
					When running the server in standalone mode, there is a specific script you need to run to boot the server depending on your operating system. These scripts live in the <span class="emphasis"><em>bin/</em></span> directory of the server distribution.
				</p><div class="formalpara"><p class="title"><strong>Standalone Boot Scripts</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/standalone-boot-files.png" alt="standalone boot files"/></span>
					</p></div><p>
					To boot the server:
				</p><div class="formalpara"><p class="title"><strong>Linux/Unix</strong></p><p>
						
<pre class="screen">$ .../bin/standalone.sh</pre>
					</p></div><div class="formalpara"><p class="title"><strong>Windows</strong></p><p>
						
<pre class="screen">&gt; ...\bin\standalone.bat</pre>
					</p></div></section><section class="section" id="standalone_configuration"><div class="titlepage"><div><div><h3 class="title">3.1.2. Standalone Configuration</h3></div></div></div><p>
					The bulk of this guide walks you through how to configure infrastructure level aspects of Red Hat Single Sign-On. These aspects are configured in a configuration file that is specific to the application server that Red Hat Single Sign-On is a derivative of. In the standalone operation mode, this file lives in <span class="emphasis"><em>…​/standalone/configuration/standalone.xml</em></span>. This file is also used to configure non-infrastructure level things that are specific to Red Hat Single Sign-On components.
				</p><div class="formalpara"><p class="title"><strong>Standalone Config File</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/standalone-config-file.png" alt="standalone config file"/></span>
					</p></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
						Any changes you make to this file while the server is running will not take effect and may even be overwritten by the server. Instead use the the command line scripting or the web console of JBoss EAP. See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a> for more information.
					</p></div></div></section></section><section class="section" id="standalone-ha-mode"><div class="titlepage"><div><div><h2 class="title">3.2. Standalone Clustered Mode</h2></div></div></div><p>
				Standalone clustered operation mode is for when you want to run Red Hat Single Sign-On within a cluster. This mode requires that you have a copy of the Red Hat Single Sign-On distribution on each machine you want to run a server instance. This mode can be very easy to deploy initially, but can become quite cumbersome. To make a configuration change you’ll have to modify each distribution on each machine. For a large cluster this can become time consuming and error prone.
			</p><section class="section" id="standalone_clustered_configuration"><div class="titlepage"><div><div><h3 class="title">3.2.1. Standalone Clustered Configuration</h3></div></div></div><p>
					The distribution has a mostly pre-configured app server configuration file for running within a cluster. It has all the specific infrastructure settings for networking, databases, caches, and discovery. This file resides in <span class="emphasis"><em>…​/standalone/configuration/standalone-ha.xml</em></span>. There’s a few things missing from this configuration. You can’t run Red Hat Single Sign-On in a cluster without a configuring a shared database connection. You also need to deploy some type of load balancer in front of the cluster. The <a class="link" href="#clustering" title="Chapter 8. Clustering">clustering</a> and <a class="link" href="#database" title="Chapter 6. Relational Database Setup">database</a> sections of this guide walk you though these things.
				</p><div class="formalpara"><p class="title"><strong>Standalone HA Config</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/standalone-ha-config-file.png" alt="standalone ha config file"/></span>
					</p></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
						Any changes you make to this file while the server is running will not take effect and may even be overwritten by the server. Instead use the the command line scripting or the web console of JBoss EAP. See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a> for more information.
					</p></div></div></section><section class="section" id="standalone_clustered_boot_script"><div class="titlepage"><div><div><h3 class="title">3.2.2. Standalone Clustered Boot Script</h3></div></div></div><p>
					You use the same boot scripts to start Red Hat Single Sign-On as you do in standalone mode. The difference is that you pass in an additional flag to point to the HA config file.
				</p><div class="formalpara"><p class="title"><strong>Standalone Clustered Boot Scripts</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/standalone-boot-files.png" alt="standalone boot files"/></span>
					</p></div><p>
					To boot the server:
				</p><div class="formalpara"><p class="title"><strong>Linux/Unix</strong></p><p>
						
<pre class="screen">$ .../bin/standalone.sh --server-config=standalone-ha.xml</pre>
					</p></div><div class="formalpara"><p class="title"><strong>Windows</strong></p><p>
						
<pre class="screen">&gt; ...\bin\standalone.bat --server-config=standalone-ha.xml</pre>
					</p></div></section></section><section class="section" id="domain-mode"><div class="titlepage"><div><div><h2 class="title">3.3. Domain Clustered Mode</h2></div></div></div><p>
				Domain mode is a way to centrally manage and publish the configuration for your servers.
			</p><p>
				Running a cluster in standard mode can quickly become aggravating as the cluster grows in size. Every time you need to make a configuration change, you have perform it on each node in the cluster. Domain mode solves this problem by providing a central place to store and publish configuration. It can be quite complex to set up, but it is worth it in the end. This capability is built into the JBoss EAP Application Server which Red Hat Single Sign-On derives from.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					The guide will go over the very basics of domain mode. Detailed steps on how to set up domain mode in a cluster should be obtained from the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a>.
				</p></div></div><p>
				Here are some of the basic concepts of running in domain mode.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">domain controller</span></dt><dd>
							The domain controller is a process that is responsible for storing, managing, and publishing the general configuration for each node in the cluster. This process is the central point from which nodes in a cluster obtain their configuration.
						</dd><dt><span class="term">host controller</span></dt><dd>
							The host controller is responsible for managing server instances on a specific machine. You configure it to run one or more server instances. The domain controller can also interact with the host controllers on each machine to manage the cluster. To reduce the number of running process, a domain controller also acts as a host controller on the machine it runs on.
						</dd><dt><span class="term">domain profile</span></dt><dd>
							A domain profile is a named set of configuration that can be used by a server to boot from. A domain controller can define multiple domain profiles that are consumed by different servers.
						</dd><dt><span class="term">server group</span></dt><dd>
							A server group is a collection of servers. They are managed and configured as one. You can assign a domain profile to a server group and every service in that group will use that domain profile as their configuration.
						</dd></dl></div><p>
				In domain mode, a domain controller is started on a master node. The configuration for the cluster resides in the domain controller. Next a host controller is started on each machine in the cluster. Each host controller deployment configuration specifies how many Red Hat Single Sign-On server instances will be started on that machine. When the host controller boots up, it starts as many Red Hat Single Sign-On server instances as it was configured to do. These server instances pull their configuration from the domain controller.
			</p><section class="section" id="domain_configuration"><div class="titlepage"><div><div><h3 class="title">3.3.1. Domain Configuration</h3></div></div></div><p>
					Various other chapters in this guide walk you through configuring various aspects like databases, HTTP network connections, caches, and other infrastructure related things. While standalone mode uses the <span class="emphasis"><em>standalone.xml</em></span> file to configure these things, domain mode uses the <span class="emphasis"><em>…​/domain/configuration/domain.xml</em></span> configuration file. This is where the domain profile and server group for the Red Hat Single Sign-On server are defined.
				</p><div class="formalpara"><p class="title"><strong>domain.xml</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/domain-file.png" alt="domain file"/></span>
					</p></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
						Any changes you make to this file while the domain controller is running will not take effect and may even be overwritten by the server. Instead use the the command line scripting or the web console of JBoss EAP. See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a> for more information.
					</p></div></div><p>
					Let’s look at some aspects of this <span class="emphasis"><em>domain.xml</em></span> file. The <code class="literal">auth-server-standalone</code> and <code class="literal">auth-server-clustered</code> <code class="literal">profile</code> XML blocks are where you are going to make the bulk of your configuration decisions. You’ll be configuring things here like network connections, caches, and database connections.
				</p><div class="formalpara"><p class="title"><strong>auth-server profile</strong></p><p>
						
<pre class="programlisting language-xml">    &lt;profiles&gt;
        &lt;profile name="auth-server-standalone"&gt;
            ...
         &lt;/profile&gt;
       &lt;profile name="auth-server-clustered"&gt;
           ...
        &lt;/profile&gt;</pre>
					</p></div><p>
					The <code class="literal">auth-server-standalone</code> profile is a non-clustered setup. The <code class="literal">auth-server-clustered</code> profile is the clustered setup.
				</p><p>
					If you scroll down further, you’ll see various <code class="literal">socket-binding-groups</code> defined.
				</p><div class="formalpara"><p class="title"><strong>socket-binding-groups</strong></p><p>
						
<pre class="programlisting language-xml">    &lt;socket-binding-groups&gt;
        &lt;socket-binding-group name="standard-sockets" default-interface="public"&gt;
           ...
        &lt;/socket-binding-group&gt;
        &lt;socket-binding-group name="ha-sockets" default-interface="public"&gt;
           ...
        &lt;/socket-binding-group&gt;
        &lt;!-- load-balancer-sockets should be removed in production systems and replaced with a better softare or hardare based one --&gt;
        &lt;socket-binding-group name="load-balancer-sockets" default-interface="public"&gt;
           ...
        &lt;/socket-binding-group&gt;
    &lt;/socket-binding-groups&gt;</pre>
					</p></div><p>
					This config defines the default port mappings for various connectors that are opened with each Red Hat Single Sign-On server instance. Any value that contains <code class="literal">${…​}</code> is a value that can be overriden on the command line with the <code class="literal">-D</code> switch, i.e.
				</p><pre class="screen">$ domain.sh -Djboss.http.port=80</pre><p>
					The definition of the server group for Red Hat Single Sign-On resides in the <code class="literal">server-groups</code> XML block. It specifies the domain profile that is used (<code class="literal">default</code>) and also some default boot arguments for the Java VM when the host controller boots an instance. It also binds a <code class="literal">socket-binding-group</code> to the server group.
				</p><div class="formalpara"><p class="title"><strong>server group</strong></p><p>
						
<pre class="programlisting language-xml">    &lt;server-groups&gt;
        &lt;!-- load-balancer-group should be removed in production systems and replaced with a better softare or hardare based one --&gt;
        &lt;server-group name="load-balancer-group" profile="load-balancer"&gt;
            &lt;jvm name="default"&gt;
                &lt;heap size="64m" max-size="512m"/&gt;
            &lt;/jvm&gt;
            &lt;socket-binding-group ref="load-balancer-sockets"/&gt;
        &lt;/server-group&gt;
        &lt;server-group name="auth-server-group" profile="auth-server-clustered"&gt;
            &lt;jvm name="default"&gt;
                &lt;heap size="64m" max-size="512m"/&gt;
            &lt;/jvm&gt;
            &lt;socket-binding-group ref="ha-sockets"/&gt;
        &lt;/server-group&gt;
    &lt;/server-groups&gt;</pre>
					</p></div></section><section class="section" id="host_controller_configuration"><div class="titlepage"><div><div><h3 class="title">3.3.2. Host Controller Configuration</h3></div></div></div><p>
					Red Hat Single Sign-On comes with two host controller configuration files that reside in the <span class="emphasis"><em>…​/domain/configuration/</em></span> directory: <span class="emphasis"><em>host-master.xml</em></span> and <span class="emphasis"><em>host-slave.xml</em></span>. <span class="emphasis"><em>host-master.xml</em></span> is configured to boot up a domain controller, a load balancer, and one Red Hat Single Sign-On server instance. <span class="emphasis"><em>host-slave.xml</em></span> is configured to talk to the domain controller and boot up one Red Hat Single Sign-On server instance.
				</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
						The load balancer is not a required service. It exists so that you can easily test drive clustering on your development machine. While usable in production, you have the option of replacing it if you have a different hardware or software based load balancer you want to use.
					</p></div></div><div class="formalpara"><p class="title"><strong>Host Controller Config</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/host-files.png" alt="host files"/></span>
					</p></div><p>
					To disable the load balancer server instance, edit <span class="emphasis"><em>host-master.xml</em></span> and comment out or remove the <code class="literal">"load-balancer"</code> entry.
				</p><pre class="programlisting language-xml">    &lt;servers&gt;
        &lt;!-- remove or comment out next line --&gt;
        &lt;server name="load-balancer" group="loadbalancer-group"/&gt;
        ...
    &lt;/servers&gt;</pre><p>
					Another interesting thing to note about this file is the declaration of the authentication server instance. It has a <code class="literal">port-offset</code> setting. Any network port defined in the <span class="emphasis"><em>domain.xml</em></span> <code class="literal">socket-binding-group</code> or the server group will have the value of <code class="literal">port-offset</code> added to it. For this example domain setup we do this so that ports opened by the load balancer server don’t conflict with the authentication server instance that is started.
				</p><pre class="programlisting language-xml">    &lt;servers&gt;
        ...
        &lt;server name="server-one" group="auth-server-group" auto-start="true"&gt;
             &lt;socket-bindings port-offset="150"/&gt;
        &lt;/server&gt;
    &lt;/servers&gt;</pre></section><section class="section" id="server_instance_working_directories"><div class="titlepage"><div><div><h3 class="title">3.3.3. Server Instance Working Directories</h3></div></div></div><p>
					Each Red Hat Single Sign-On server instance defined in your host files creates a working directory under <span class="emphasis"><em>…​/domain/servers/{SERVER NAME}</em></span>. Additional configuration can be put there, and any temporary, log, or data files the server instance needs or creates go there too. The structure of these per server directories ends up looking like any other JBoss EAP booted server.
				</p><div class="formalpara"><p class="title"><strong>Working Directories</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/domain-server-dir.png" alt="domain server dir"/></span>
					</p></div></section><section class="section" id="domain_boot_script"><div class="titlepage"><div><div><h3 class="title">3.3.4. Domain Boot Script</h3></div></div></div><p>
					When running the server in domain mode, there is a specific script you need to run to boot the server depending on your operating system. These scripts live in the <span class="emphasis"><em>bin/</em></span> directory of the server distribution.
				</p><div class="formalpara"><p class="title"><strong>Domain Boot Script</strong></p><p>
						<span class="inlinemediaobject"><img src="images/rhsso-images/domain-boot-files.png" alt="domain boot files"/></span>
					</p></div><p>
					To boot the server:
				</p><div class="formalpara"><p class="title"><strong>Linux/Unix</strong></p><p>
						
<pre class="screen">$ .../bin/domain.sh --host-config=host-master.xml</pre>
					</p></div><div class="formalpara"><p class="title"><strong>Windows</strong></p><p>
						
<pre class="screen">&gt; ...\bin\domain.bat --host-config=host-slave.xml</pre>
					</p></div><p>
					When running the boot script you will need pass in the host controlling configuration file you are going to use via the <code class="literal">--host-config</code> switch.
				</p></section><section class="section" id="clustered-domain-example"><div class="titlepage"><div><div><h3 class="title">3.3.5. Clustered Domain Example</h3></div></div></div><p>
					You can test drive clustering using the out-of-the-box <span class="emphasis"><em>domain.xml</em></span> configuration. This example domain is meant to run on one machine and boots up:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							a domain controller
						</li><li class="listitem">
							an HTTP load balancer
						</li><li class="listitem">
							2 Red Hat Single Sign-On server instances
						</li></ul></div><p>
					To simulate running a cluster on two machines, you’ll run the <code class="literal">domain.sh</code> script twice to start two separate host controllers. The first will be the master host controller which will start a domain controller, an HTTP load balancer, and one Red Hat Single Sign-On authentication server instance. The second will be a slave host controller that only starts up an authentication server instance.
				</p><section class="section" id="setup_slave_connection_to_domain_controller"><div class="titlepage"><div><div><h4 class="title">3.3.5.1. Setup Slave Connection to Domain Controller</h4></div></div></div><p>
						Before you can boot things up though, you have to configure the slave host controller so that it can talk securely to the domain controller. If you do not do this, then the slave host will not be able to obtain the centralized configuration from the domain controller. To set up a secure connection, you have to create a server admin user and a secret that will be shared between the master and the slave. You do this by running the <code class="literal">…​/bin/add-user.sh</code> script.
					</p><p>
						When you run the script select <code class="literal">Management User</code> and answer <code class="literal">yes</code> when it asks you if the new user is going to be used for one AS process to connect to another. This will generate a secret that you’ll need to cut and paste into the <span class="emphasis"><em>…​/domain/configuration/host-slave.xml</em></span> file.
					</p><div class="formalpara"><p class="title"><strong>Add App Server Admin</strong></p><p>
							
<pre class="screen">$ add-user.sh
 What type of user do you wish to add?
  a) Management User (mgmt-users.properties)
  b) Application User (application-users.properties)
 (a): a
 Enter the details of the new user to add.
 Using realm 'ManagementRealm' as discovered from the existing property files.
 Username : admin
 Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
  - The password should not be one of the following restricted values {root, admin, administrator}
  - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
  - The password should be different from the username
 Password :
 Re-enter Password :
 What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[ ]:
 About to add user 'admin' for realm 'ManagementRealm'
 Is this correct yes/no? yes
 Added user 'admin' to file '/.../standalone/configuration/mgmt-users.properties'
 Added user 'admin' to file '/.../domain/configuration/mgmt-users.properties'
 Added user 'admin' with groups to file '/.../standalone/configuration/mgmt-groups.properties'
 Added user 'admin' with groups to file '/.../domain/configuration/mgmt-groups.properties'
 Is this new user going to be used for one AS process to connect to another AS process?
 e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
 yes/no? yes
 To represent the user add the following to the server-identities definition &lt;secret value="bWdtdDEyMyE=" /&gt;</pre>
						</p></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
							The add-user.sh does not add user to Red Hat Single Sign-On server but to the underlying JBoss Enterprise Application Platform. The credentials used and generated in the above script are only for example purpose. Please use the ones generated on your system.
						</p></div></div><p>
						Now cut and paste the secret value into the <span class="emphasis"><em>…​/domain/configuration/host-slave.xml</em></span> file as follows:
					</p><pre class="programlisting language-xml">     &lt;management&gt;
         &lt;security-realms&gt;
             &lt;security-realm name="ManagementRealm"&gt;
                 &lt;server-identities&gt;
                     &lt;secret value="bWdtdDEyMyE="/&gt;
                 &lt;/server-identities&gt;</pre></section><section class="section" id="run_the_boot_scripts"><div class="titlepage"><div><div><h4 class="title">3.3.5.2. Run the Boot Scripts</h4></div></div></div><p>
						Since we’re simulating a two node cluster on one development machine, you’ll run the boot script twice:
					</p><div class="formalpara"><p class="title"><strong>Boot up master</strong></p><p>
							
<pre class="programlisting language-shell">$ domain.sh --host-config=host-master.xml</pre>
						</p></div><div class="formalpara"><p class="title"><strong>Boot up slave</strong></p><p>
							
<pre class="programlisting language-shell">$ domain.sh --host-config=host-slave.xml</pre>
						</p></div><p>
						To try it out, open your browser and go to <a class="link" href="http://localhost:8080/auth">http://localhost:8080/auth</a>
					</p></section></section></section></section><section class="chapter" id="manage_config"><div class="titlepage"><div><div><h1 class="title">Chapter 4. Manage Subsystem Configuration</h1></div></div></div><p>
			Low-level configuration of Red Hat Single Sign-On is done by editing the <code class="literal">standalone.xml</code>, <code class="literal">standalone-ha.xml</code>, or <code class="literal">domain.xml</code> file in your distribution. The location of this file depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>.
		</p><p>
			While there are endless settings you can configure here, this section will focus on configuration of the <span class="emphasis"><em>keycloak-server</em></span> subsystem. No matter which configuration file you are using, configuration of the <span class="emphasis"><em>keycloak-server</em></span> subsystem is the same.
		</p><p>
			The keycloak-server subsystem is typically declared toward the end of the file like this:
		</p><pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:keycloak-server:1.1"&gt;
   &lt;web-context&gt;auth&lt;/web-context&gt;
   ...
&lt;/subsystem&gt;</pre><p>
			Note that anything changed in this subsystem will not take effect until the server is rebooted.
		</p><section class="section" id="config_spi_providers"><div class="titlepage"><div><div><h2 class="title">4.1. Configure SPI Providers</h2></div></div></div><p>
				The specifics of each configuration setting is discussed elsewhere in context with that setting. However, it is useful to understand the format used to declare settings on SPI providers.
			</p><p>
				Red Hat Single Sign-On is a highly modular system that allows great flexibility. There are more than 50 service provider interfaces (SPIs), and you are allowed to swap out implementations of each SPI. An implementation of an SPI is known as a <span class="emphasis"><em>provider</em></span>.
			</p><p>
				All elements in an SPI declaration are optional, but a full SPI declaration looks like this:
			</p><pre class="programlisting language-xml">&lt;spi name="myspi"&gt;
    &lt;default-provider&gt;myprovider&lt;/default-provider&gt;
    &lt;provider name="myprovider" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="foo" value="bar"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
    &lt;provider name="mysecondprovider" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="foo" value="foo"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
&lt;/spi&gt;</pre><p>
				Here we have two providers defined for the SPI <code class="literal">myspi</code>. The <code class="literal">default-provider</code> is listed as <code class="literal">myprovider</code>. However it is up to the SPI to decide how it will treat this setting. Some SPIs allow more than one provider and some do not. So <code class="literal">default-provider</code> can help the SPI to choose.
			</p><p>
				Also notice that each provider defines its own set of configuration properties. The fact that both providers above have a property called <code class="literal">foo</code> is just a coincidence.
			</p><p>
				The type of each property value is interpreted by the provider. However, there is one exception. Consider the <code class="literal">jpa</code> provider for the <code class="literal">eventStore</code> API:
			</p><pre class="programlisting language-xml">&lt;spi name="eventsStore"&gt;
    &lt;provider name="jpa" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="exclude-events" value="[&amp;quot;EVENT1&amp;quot;,
                                                    &amp;quot;EVENT2&amp;quot;]"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
&lt;/spi&gt;</pre><p>
				We see that the value begins and ends with square brackets. That means that the value will be passed to the provider as a list. In this example, the system will pass the provider a list with two element values <span class="emphasis"><em>EVENT1</em></span> and <span class="emphasis"><em>EVENT2</em></span>. To add more values to the list, just separate each list element with a comma. Unfortunately, you do need to escape the quotes surrounding each list element with <code class="literal">&amp;quot;</code>.
			</p></section><section class="section" id="start_cli"><div class="titlepage"><div><div><h2 class="title">4.2. Start the JBoss EAP CLI</h2></div></div></div><p>
				Besides editing the configuration by hand, you also have the option of changing the configuration by issuing commands via the <span class="emphasis"><em>jboss-cli</em></span> tool. CLI allows you to configure servers locally or remotely. And it is especially useful when combined with scripting.
			</p><p>
				To start the JBoss EAP CLI, you need to run <code class="literal">jboss-cli</code>.
			</p><div class="formalpara"><p class="title"><strong>Linux/Unix</strong></p><p>
					
<pre class="screen">$ .../bin/jboss-cli.sh</pre>
				</p></div><div class="formalpara"><p class="title"><strong>Windows</strong></p><p>
					
<pre class="screen">&gt; ...\bin\jboss-cli.bat</pre>
				</p></div><p>
				This will bring you to a prompt like this:
			</p><div class="formalpara"><p class="title"><strong>Prompt</strong></p><p>
					
<pre class="screen">[disconnected /]</pre>
				</p></div><p>
				If you wish to execute commands on a running server, you will first execute the <code class="literal">connect</code> command.
			</p><div class="formalpara"><p class="title"><strong>connect</strong></p><p>
					
<pre class="screen">[disconnected /] connect
connect
[standalone@localhost:9990 /]</pre>
				</p></div><p>
				You may be thinking to yourself, "I didn’t enter in any username or password!". If you run <code class="literal">jboss-cli</code> on the same machine as your running standalone server or domain controller and your account has appropriate file permissions, you do not have to setup or enter in a admin username and password. See the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/"><span class="emphasis"><em>JBoss EAP Configuration Guide</em></span></a> for more details on how to make things more secure if you are uncomfortable with that setup.
			</p></section><section class="section" id="cli_embedded_mode"><div class="titlepage"><div><div><h2 class="title">4.3. CLI Embedded Mode</h2></div></div></div><p>
				If you do happen to be on the same machine as your standalone server and you want to issue commands while the server is not active, you can embed the server into CLI and make changes in a special mode that disallows incoming requests. To do this, first execute the <code class="literal">embed</code> command with the config file you wish to change.
			</p><div class="formalpara"><p class="title"><strong>embed</strong></p><p>
					
<pre class="screen">[disconnected /] embed-server --server-config=standalone.xml
[standalone@embedded /]</pre>
				</p></div></section><section class="section" id="cli_gui_mode"><div class="titlepage"><div><div><h2 class="title">4.4. CLI GUI Mode</h2></div></div></div><p>
				The CLI can also run in GUI mode. GUI mode launches a Swing application that allows you to graphically view and edit the entire management model of a <span class="emphasis"><em>running</em></span> server. GUI mode is especially useful when you need help formatting your CLI commands and learning about the options available. The GUI can also retrieve server logs from a local or remote server.
			</p><div class="formalpara"><p class="title"><strong>Start in GUI mode</strong></p><p>
					
<pre class="screen">$ .../bin/jboss-cli.sh --gui</pre>
				</p></div><p>
				<span class="emphasis"><em>Note: to connect to a remote server, you pass the <code class="literal">--connect</code> option as well. Use the --help option for more details.</em></span>
			</p><p>
				After launching GUI mode, you will probably want to scroll down to find the node, <code class="literal">subsystem=keycloak-server</code>. If you right-click on the node and click <code class="literal">Explore subsystem=keycloak-server</code>, you will get a new tab that shows only the keycloak-server subsystem.
			</p><p>
				<span class="inlinemediaobject"><img src="images/cli-gui.png" alt="cli gui"/></span>
			</p></section><section class="section" id="cli_scripting"><div class="titlepage"><div><div><h2 class="title">4.5. CLI Scripting</h2></div></div></div><p>
				The CLI has extensive scripting capabilities. A script is just a text file with CLI commands in it. Consider a simple script that turns off theme and template caching.
			</p><div class="formalpara"><p class="title"><strong>turn-off-caching.cli</strong></p><p>
					
<pre class="screen">/subsystem=keycloak-server/theme=defaults/:write-attribute(name=cacheThemes,value=false)
/subsystem=keycloak-server/theme=defaults/:write-attribute(name=cacheTemplates,value=false)</pre>
				</p></div><p>
				To execute the script, I can follow the <code class="literal">Scripts</code> menu in CLI GUI, or execute the script from the command line as follows:
			</p><pre class="screen">$ .../bin/jboss-cli.sh --file=turn-off-caching.cli</pre></section><section class="section" id="cli_recipes"><div class="titlepage"><div><div><h2 class="title">4.6. CLI Recipes</h2></div></div></div><p>
				Here are some configuration tasks and how to perform them with CLI commands. Note that in all but the first example, we use the wildcard path <code class="literal">**</code> to mean you should substitute or the path to the keycloak-server subsystem.
			</p><p>
				For standalone, this just means:
			</p><p>
				<code class="literal">**</code> = <code class="literal">/subsystem=keycloak-server</code>
			</p><p>
				For domain mode, this would mean something like:
			</p><p>
				<code class="literal">**</code> = <code class="literal">/profile=auth-server-clustered/subsystem=keycloak-server</code>
			</p><section class="section" id="change_the_web_context_of_the_server"><div class="titlepage"><div><div><h3 class="title">4.6.1. Change the web context of the server</h3></div></div></div><pre class="screen">/subsystem=keycloak-server/:write-attribute(name=web-context,value=myContext)</pre></section><section class="section" id="set_the_global_default_theme"><div class="titlepage"><div><div><h3 class="title">4.6.2. Set the global default theme</h3></div></div></div><pre class="screen">**/theme=defaults/:write-attribute(name=default,value=myTheme)</pre></section><section class="section" id="add_a_new_spi_and_a_provider"><div class="titlepage"><div><div><h3 class="title">4.6.3. Add a new SPI and a provider</h3></div></div></div><pre class="screen">**/spi=mySPI/:add
**/spi=mySPI/provider=myProvider/:add(enabled=true)</pre></section><section class="section" id="disable_a_provider"><div class="titlepage"><div><div><h3 class="title">4.6.4. Disable a provider</h3></div></div></div><pre class="screen">**/spi=mySPI/provider=myProvider/:write-attribute(name=enabled,value=false)</pre></section><section class="section" id="change_the_default_provider_for_an_spi"><div class="titlepage"><div><div><h3 class="title">4.6.5. Change the default provider for an SPI</h3></div></div></div><pre class="screen">**/spi=mySPI/:write-attribute(name=default-provider,value=myProvider)</pre></section><section class="section" id="configure_the_dblock_spi"><div class="titlepage"><div><div><h3 class="title">4.6.6. Configure the dblock SPI</h3></div></div></div><pre class="screen">**/spi=dblock/:add(default-provider=jpa)
**/spi=dblock/provider=jpa/:add(properties={lockWaitTimeout =&gt; "900"},enabled=true)</pre></section><section class="section" id="add_or_change_a_single_property_value_for_a_provider"><div class="titlepage"><div><div><h3 class="title">4.6.7. Add or change a single property value for a provider</h3></div></div></div><pre class="screen">**/spi=dblock/provider=jpa/:map-put(name=properties,key=lockWaitTimeout,value=3)</pre></section><section class="section" id="remove_a_single_property_from_a_provider"><div class="titlepage"><div><div><h3 class="title">4.6.8. Remove a single property from a provider</h3></div></div></div><pre class="screen">**/spi=dblock/provider=jpa/:map-remove(name=properties,key=lockRecheckTime)</pre></section><section class="section" id="set_values_on_a_provider_property_of_type_literal_list_literal"><div class="titlepage"><div><div><h3 class="title">4.6.9. Set values on a provider property of type <code class="literal">List</code></h3></div></div></div><pre class="screen">**/spi=eventsStore/provider=jpa/:map-put(name=properties,key=exclude-events,value=[EVENT1,EVENT2])</pre></section></section></section><section class="chapter" id="profiles"><div class="titlepage"><div><div><h1 class="title">Chapter 5. Profiles</h1></div></div></div><p>
			Red Hat Single Sign-On has two profiles, product and preview. The product profile is enabled by default, which disables some tech preview features. To enable the features you can either switch to the preview profile or enable individual features.
		</p><p>
			To enable the preview profile start the server with:
		</p><pre class="screen">bin/standalone.sh|bat -Dkeycloak.profile=preview</pre><p>
			You can set this permanently by creating the file <code class="literal">standalone/configuration/profile.properties</code> (or <code class="literal">domain/servers/server-one/configuration/profile.properties</code> for <code class="literal">server-one</code> in domain mode). Add the following to the file:
		</p><pre class="screen">profile=preview</pre><p>
			The features that can be enabled and disabled are:
		</p><div class="informaltable"><table class="lt-4-cols lt-7-rows"><colgroup><col style="width: 33%; " class="col_1"/><col style="width: 33%; " class="col_2"/><col style="width: 33%; " class="col_3"/></colgroup><thead><tr><th style="text-align: left; vertical-align: top; ">Name</th><th style="text-align: left; vertical-align: top; ">Description</th><th style="text-align: left; vertical-align: top; ">Enabled by default</th></tr></thead><tbody><tr><td style="text-align: left; vertical-align: top; ">
						<p>
							authorization
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							Authorization Services
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							No
						</p>
						</td></tr><tr><td style="text-align: left; vertical-align: top; ">
						<p>
							docker
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							Docker Registry protocol
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							No
						</p>
						</td></tr><tr><td style="text-align: left; vertical-align: top; ">
						<p>
							impersonation
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							Ability for admins to impersonate users
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							Yes
						</p>
						</td></tr><tr><td style="text-align: left; vertical-align: top; ">
						<p>
							script
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							Write custom authenticators using JavaScript
						</p>
						</td><td style="text-align: left; vertical-align: top; ">
						<p>
							No
						</p>
						</td></tr></tbody></table></div><p>
			To enable a specific feature start the server with:
		</p><pre class="screen">bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=disabled</pre><p>
			For example to enable Docker use <code class="literal">-Dkeycloak.profile.feature.docker=enabled</code>.
		</p><p>
			To disable a specific feature start the server with:
		</p><pre class="screen">bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=disabled</pre><p>
			For example to disable Impersonation use <code class="literal">-Dkeycloak.profile.feature.impersonation=disabled</code>.
		</p><p>
			You can set this permanently in the <code class="literal">profile.properties</code> file by adding:
		</p><pre class="screen">feature.impersonation=disabled</pre><p>
			To enable a specific feature without enabling the full preview profile you can start the server with:
		</p><pre class="screen">bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=enabled`</pre><p>
			For example to enable Authorization Services use <code class="literal">-Dkeycloak.profile.feature.authorization=enabled</code>.
		</p><p>
			You can set this permanently in the <code class="literal">profile.properties</code> file by adding:
		</p><pre class="screen">feature.authorization=enabled</pre></section><section class="chapter" id="database"><div class="titlepage"><div><div><h1 class="title">Chapter 6. Relational Database Setup</h1></div></div></div><p>
			Red Hat Single Sign-On comes with its own embedded Java-based relational database called H2. This is the default database that Red Hat Single Sign-On will use to persist data and really only exists so that you can run the authentication server out of the box. We highly recommend that you replace it with a more production ready external database. The H2 database is not very viable in high concurrency situations and should not be used in a cluster either. The purpose of this chapter is to show you how to connect Red Hat Single Sign-On to a more mature database.
		</p><p>
			Red Hat Single Sign-On uses two layered technologies to persist its relational data. The bottom layered technology is JDBC. JDBC is a Java API that is used to connect to a RDBMS. There are different JDBC drivers per database type that are provided by your database vendor. This chapter discusses how to configure Red Hat Single Sign-On to use one of these vendor-specific drivers.
		</p><p>
			The top layered technology for persistence is Hibernate JPA. This is a object to relational mapping API that maps Java Objects to relational data. Most deployments of Red Hat Single Sign-On will never have to touch the configuration aspects of Hibernate, but we will discuss how that is done if you run into that rare circumstance.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				Datasource configuration is covered much more thoroughly in <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#datasource_management">the datasource configuration chapter</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
			</p></div></div><section class="section" id="rdbms-setup-checklist"><div class="titlepage"><div><div><h2 class="title">6.1. RDBMS Setup Checklist</h2></div></div></div><p>
				These are the steps you will need to perform to get an RDBMS configured for Red Hat Single Sign-On.
			</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
						Locate and download a JDBC driver for your database
					</li><li class="listitem">
						Package the driver JAR into a module and install this module into the server
					</li><li class="listitem">
						Declare the JDBC driver in the configuration profile of the server
					</li><li class="listitem">
						Modify the datasource configuration to use your database’s JDBC driver
					</li><li class="listitem">
						Modify the datasource configuration to define the connection parameters to your database
					</li></ol></div><p>
				This chapter will use PostgresSQL for all its examples. Other databases follow the same steps for installation.
			</p></section><section class="section" id="package_the_jdbc_driver"><div class="titlepage"><div><div><h2 class="title">6.2. Package the JDBC Driver</h2></div></div></div><p>
				Find and download the JDBC driver JAR for your RDBMS. Before you can use this driver, you must package it up into a module and install it into the server. Modules define JARs that are loaded into the Red Hat Single Sign-On classpath and the dependencies those JARs have on other modules. They are pretty simple to set up.
			</p><p>
				Within the <span class="emphasis"><em>…​/modules/</em></span> directory of your Red Hat Single Sign-On distribution, you need to create a directory structure to hold your module definition. The convention is use the Java package name of the JDBC driver for the name of the directory structure. For PostgreSQL, create the directory <span class="emphasis"><em>org/postgresql/main</em></span>. Copy your database driver JAR into this directory and create an empty <span class="emphasis"><em>module.xml</em></span> file within it too.
			</p><div class="formalpara"><p class="title"><strong>Module Directory</strong></p><p>
					<span class="inlinemediaobject"><img src="images/rhsso-images/db-module.png" alt="db module"/></span>
				</p></div><p>
				After you have done this, open up the <span class="emphasis"><em>module.xml</em></span> file and create the following XML:
			</p><div class="formalpara"><p class="title"><strong>Module XML</strong></p><p>
					
<pre class="programlisting language-xml">&lt;?xml version="1.0" ?&gt;
&lt;module xmlns="urn:jboss:module:1.3" name="org.postgresql"&gt;

    &lt;resources&gt;
        &lt;resource-root path="postgresql-9.4.1212.jar"/&gt;
    &lt;/resources&gt;

    &lt;dependencies&gt;
        &lt;module name="javax.api"/&gt;
        &lt;module name="javax.transaction.api"/&gt;
    &lt;/dependencies&gt;
&lt;/module&gt;</pre>
				</p></div><p>
				The module name should match the directory structure of your module. So, <span class="emphasis"><em>org/postgresql</em></span> maps to <code class="literal">org.postgresql</code>. The <code class="literal">resource-root path</code> attribute should specify the JAR filename of the driver. The rest are just the normal dependencies that any JDBC driver JAR would have.
			</p></section><section class="section" id="declare_and_load_jdbc_driver"><div class="titlepage"><div><div><h2 class="title">6.3. Declare and Load JDBC Driver</h2></div></div></div><p>
				The next thing you have to do is declare your newly packaged JDBC driver into your deployment profile so that it loads and becomes available when the server boots up. Where you perform this action depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>. If you’re deploying in standard mode, edit <span class="emphasis"><em>…​/standalone/configuration/standalone.xml</em></span>. If you’re deploying in standard clustering mode, edit <span class="emphasis"><em>…​/standalone/configuration/standalone-ha.xml</em></span>. If you’re deploying in domain mode, edit <span class="emphasis"><em>…​/domain/configuration/domain.xml</em></span>. In domain mode, you’ll need to make sure you edit the profile you are using: either <code class="literal">auth-server-standalone</code> or <code class="literal">auth-server-clustered</code>
			</p><p>
				Within the profile, search for the <code class="literal">drivers</code> XML block within the <code class="literal">datasources</code> subsystem. You should see a pre-defined driver declared for the H2 JDBC driver. This is where you’ll declare the JDBC driver for your external database.
			</p><div class="formalpara"><p class="title"><strong>JDBC Drivers</strong></p><p>
					
<pre class="programlisting language-xml">  &lt;subsystem xmlns="urn:jboss:domain:datasources:4.0"&gt;
     &lt;datasources&gt;
       ...
       &lt;drivers&gt;
          &lt;driver name="h2" module="com.h2database.h2"&gt;
              &lt;xa-datasource-class&gt;org.h2.jdbcx.JdbcDataSource&lt;/xa-datasource-class&gt;
          &lt;/driver&gt;
       &lt;/drivers&gt;
     &lt;/datasources&gt;
  &lt;/subsystem&gt;</pre>
				</p></div><p>
				Within the <code class="literal">drivers</code> XML block you’ll need to declare an additional JDBC driver. It needs to have a <code class="literal">name</code> which you can choose to be anything you want. You specify the <code class="literal">module</code> attribute which points to the <code class="literal">module</code> package you created earlier for the driver JAR. Finally you have to specify the driver’s Java class. Here’s an example of installing PostgreSQL driver that lives in the module example defined earlier in this chapter.
			</p><div class="formalpara"><p class="title"><strong>Declare Your JDBC Drivers</strong></p><p>
					
<pre class="programlisting language-xml">  &lt;subsystem xmlns="urn:jboss:domain:datasources:4.0"&gt;
     &lt;datasources&gt;
       ...
       &lt;drivers&gt;
          &lt;driver name="postgresql" module="org.postgresql"&gt;
              &lt;xa-datasource-class&gt;org.postgresql.xa.PGXADataSource&lt;/xa-datasource-class&gt;
          &lt;/driver&gt;
          &lt;driver name="h2" module="com.h2database.h2"&gt;
              &lt;xa-datasource-class&gt;org.h2.jdbcx.JdbcDataSource&lt;/xa-datasource-class&gt;
          &lt;/driver&gt;
       &lt;/drivers&gt;
     &lt;/datasources&gt;
  &lt;/subsystem&gt;</pre>
				</p></div></section><section class="section" id="modify_the_red_hat_single_sign_on_datasource"><div class="titlepage"><div><div><h2 class="title">6.4. Modify the Red Hat Single Sign-On Datasource</h2></div></div></div><p>
				After declaring your JDBC driver, you have to modify the existing datasource configuration that Red Hat Single Sign-On uses to connect it to your new external database. You’ll do this within the same configuration file and XML block that you registered your JDBC driver in. Here’s an example that sets up the connection to your new database:
			</p><div class="formalpara"><p class="title"><strong>Declare Your JDBC Drivers</strong></p><p>
					
<pre class="programlisting language-xml">  &lt;subsystem xmlns="urn:jboss:domain:datasources:4.0"&gt;
     &lt;datasources&gt;
       ...
       &lt;datasource jndi-name="java:jboss/datasources/KeycloakDS" pool-name="KeycloakDS" enabled="true" use-java-context="true"&gt;
           &lt;connection-url&gt;jdbc:postgresql://localhost/keycloak&lt;/connection-url&gt;
           &lt;driver&gt;postgresql&lt;/driver&gt;
           &lt;pool&gt;
               &lt;max-pool-size&gt;20&lt;/max-pool-size&gt;
           &lt;/pool&gt;
           &lt;security&gt;
               &lt;user-name&gt;William&lt;/user-name&gt;
               &lt;password&gt;password&lt;/password&gt;
           &lt;/security&gt;
       &lt;/datasource&gt;
        ...
     &lt;/datasources&gt;
  &lt;/subsystem&gt;</pre>
				</p></div><p>
				Search for the <code class="literal">datasource</code> definition for <code class="literal">KeycloakDS</code>. You’ll first need to modify the <code class="literal">connection-url</code>. The documentation for your vendor’s JDBC implementation should specify the format for this connection URL value.
			</p><p>
				Next define the <code class="literal">driver</code> you will use. This is the logical name of the JDBC driver you declared in the previous section of this chapter.
			</p><p>
				It is expensive to open a new connection to a database every time you want to perform a transaction. To compensate, the datasource implementation maintains a pool of open connections. The <code class="literal">max-pool-size</code> specifies the maximum number of connections it will pool. You may want to change the value of this depending on the load of your system.
			</p><p>
				Finally, with PostgreSQL at least, you need to define the database username and password that is needed to connect to the database. You may be worried that this is in clear text in the example. There are methods to obfuscate this, but this is beyond the scope of this guide.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					For more information about datasource features, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#datasource_management">the datasource configuration chapter</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
				</p></div></div></section><section class="section" id="database_configuration"><div class="titlepage"><div><div><h2 class="title">6.5. Database Configuration</h2></div></div></div><p>
				The configuration for this component is found in the <code class="literal">standalone.xml</code>, <code class="literal">standalone-ha.xml</code>, or <code class="literal">domain.xml</code> file in your distribution. The location of this file depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>.
			</p><div class="formalpara"><p class="title"><strong>Database Config</strong></p><p>
					
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:keycloak-server:1.1"&gt;
    ...
    &lt;spi name="connectionsJpa"&gt;
     &lt;provider name="default" enabled="true"&gt;
         &lt;properties&gt;
             &lt;property name="dataSource" value="java:jboss/datasources/KeycloakDS"/&gt;
             &lt;property name="initializeEmpty" value="false"/&gt;
             &lt;property name="migrationStrategy" value="manual"/&gt;
             &lt;property name="migrationExport" value="${jboss.home.dir}/keycloak-database-update.sql"/&gt;
         &lt;/properties&gt;
     &lt;/provider&gt;
    &lt;/spi&gt;
    ...
&lt;/subsystem&gt;</pre>
				</p></div><p>
				Possible configuration options are:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">dataSource</span></dt><dd>
							JNDI name of the dataSource
						</dd><dt><span class="term">jta</span></dt><dd>
							boolean property to specify if datasource is JTA capable
						</dd><dt><span class="term">driverDialect</span></dt><dd>
							Value of database dialect. In most cases you don’t need to specify this property as dialect will be autodetected by Hibernate.
						</dd><dt><span class="term">initializeEmpty</span></dt><dd>
							Initialize database if empty. If set to false the database has to be manually initialized. If you want to manually initialize the database set migrationStrategy to <code class="literal">manual</code> which will create a file with SQL commands to initialize the database. Defaults to true.
						</dd><dt><span class="term">migrationStrategy</span></dt><dd>
							Strategy to use to migrate database. Valid values are <code class="literal">update</code>, <code class="literal">manual</code> and <code class="literal">validate</code>. Update will automatically migrate the database schema. Manual will export the required changes to a file with SQL commands that you can manually execute on the database. Validate will simply check if the database is up-to-date.
						</dd><dt><span class="term">migrationExport</span></dt><dd>
							Path for where to write manual database initialization/migration file.
						</dd><dt><span class="term">showSql</span></dt><dd>
							Specify whether Hibernate should show all SQL commands in the console (false by default). This is very verbose!
						</dd><dt><span class="term">formatSql</span></dt><dd>
							Specify whether Hibernate should format SQL commands (true by default)
						</dd><dt><span class="term">globalStatsInterval</span></dt><dd>
							Will log global statistics from Hibernate about executed DB queries and other things. Statistics are always reported to server log at specified interval (in seconds) and are cleared after each report.
						</dd><dt><span class="term">schema</span></dt><dd>
							Specify the database schema to use
						</dd></dl></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					These configuration switches and more are described in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/development_guide/#java_persistence_api_jpa"><span class="emphasis"><em>JBoss EAP Development Guide</em></span></a>.
				</p></div></div></section><section class="section" id="unicode_considerations_for_databases"><div class="titlepage"><div><div><h2 class="title">6.6. Unicode Considerations for Databases</h2></div></div></div><p>
				Database schema in Red Hat Single Sign-On only accounts for Unicode strings in the following special fields:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						Realms: display name, HTML display name
					</li><li class="listitem">
						Federation Providers: display name
					</li><li class="listitem">
						Users: username, given name, last name, attribute names and values
					</li><li class="listitem">
						Groups: name, attribute names and values
					</li><li class="listitem">
						Roles: name
					</li><li class="listitem">
						Descriptions of objects
					</li></ul></div><p>
				Otherwise, characters are limited to those contained in database encoding which is often 8-bit. However, for some database systems, it is possible to enable UTF-8 encoding of Unicode characters and use full Unicode character set in all text fields. Often, this is counterbalanced by shorter maximum length of the strings than in case of 8-bit encodings.
			</p><p>
				Some of the databases require special settings to database and/or JDBC driver to be able to handle Unicode characters. Please find the settings for your database below. Note that if a database is listed here, it can still work properly provided it handles UTF-8 encoding properly both on the level of database and JDBC driver.
			</p><p>
				Technically, the key criterion for Unicode support for all fields is whether the database allows setting of Unicode character set for <code class="literal">VARCHAR</code> and <code class="literal">CHAR</code> fields. If yes, there is a high chance that Unicode will be plausible, usually at the expense of field length. If it only supports Unicode in <code class="literal">NVARCHAR</code> and <code class="literal">NCHAR</code> fields, Unicode support for all text fields is unlikely as Keycloak schema uses <code class="literal">VARCHAR</code> and <code class="literal">CHAR</code> fields extensively.
			</p><section class="section" id="oracle_database"><div class="titlepage"><div><div><h3 class="title">6.6.1. Oracle Database</h3></div></div></div><p>
					Unicode characters are properly handled provided the database was created with Unicode support in <code class="literal">VARCHAR</code> and <code class="literal">CHAR</code> fields (e.g. by using <code class="literal">AL32UTF8</code> character set as the database character set). No special settings is needed for JDBC driver.
				</p><p>
					If the database character set is not Unicode, then to use Unicode characters in the special fields, the JDBC driver needs to be configured with the connection property <code class="literal">oracle.jdbc.defaultNChar</code> set to <code class="literal">true</code>. It might be wise, though not strictly necessary, to also set the <code class="literal">oracle.jdbc.convertNcharLiterals</code> connection property to <code class="literal">true</code>. These properties can be set either as system properties or as connection properties. Please note that setting <code class="literal">oracle.jdbc.defaultNChar</code> may have negative impact on performance. For details, please refer to Oracle JDBC driver configuration documentation.
				</p></section><section class="section" id="microsoft_sql_server_database"><div class="titlepage"><div><div><h3 class="title">6.6.2. Microsoft SQL Server Database</h3></div></div></div><p>
					Unicode characters are properly handled only for the special fields. No special settings of JDBC driver or database is necessary.
				</p></section><section class="section" id="ibm_db2_database"><div class="titlepage"><div><div><h3 class="title">6.6.3. IBM DB2 Database</h3></div></div></div><p>
					Unicode characters are properly handled for all fields, length reduction applies to non-special fields. No special settings of JDBC driver or database is necessary.
				</p></section><section class="section" id="mysql_database"><div class="titlepage"><div><div><h3 class="title">6.6.4. MySQL Database</h3></div></div></div><p>
					Unicode characters are properly handled provided the database was created with Unicode support in <code class="literal">VARCHAR</code> and <code class="literal">CHAR</code> fields in the <code class="literal">CREATE DATABASE</code> command (e.g. by using <code class="literal">utf8</code> character set as the default database character set in MySQL 5.5. Please note that <code class="literal">utf8mb4</code> character set does not work due to different storage requirements to <code class="literal">utf8</code> character set <a href="#ftn.idm139625632398960" class="footnote"><sup class="footnote" id="idm139625632398960">[1]</sup></a>). Note that in this case, length restriction to non-special fields does not apply because columns are created to accomodate given amount of characters, not bytes. If the database default character set does not allow storing Unicode, only the special fields allow storing Unicode values.
				</p><p>
					At the side of JDBC driver settings, it is necessary to add a connection property <code class="literal">characterEncoding=UTF-8</code> to the JDBC connection settings.
				</p></section><section class="section" id="postgresql_database"><div class="titlepage"><div><div><h3 class="title">6.6.5. PostgreSQL Database</h3></div></div></div><p>
					Unicode is supported when the database character set is <code class="literal">UTF8</code>. In that case, Unicode characters can be used in any field, there is no reduction of field length for non-special fields. No special settings of JDBC driver is necessary.
				</p></section><div class="footnotes"><br/><hr width="100" align="left"/><div id="ftn.idm139625632398960" class="footnote"><div class="para"><a href="#idm139625632398960" class="simpara"><sup class="simpara">[1] </sup></a>
						Tracked as <a class="link" href="https://issues.jboss.org/browse/KEYCLOAK-3873">https://issues.jboss.org/browse/KEYCLOAK-3873</a>
					</div></div></div></section></section><section class="chapter" id="network"><div class="titlepage"><div><div><h1 class="title">Chapter 7. Network Setup</h1></div></div></div><p>
			Red Hat Single Sign-On can run out of the box with some networking limitations. For one, all network endpoints bind to <code class="literal">localhost</code> so the auth server is really only usable on one local machine. For HTTP based connections, it does not use default ports like 80 and 443. HTTPS/SSL is not configured out of the box and without it, Red Hat Single Sign-On has many security vulnerabilities. Finally, Red Hat Single Sign-On may often need to make secure SSL and HTTPS connections to external servers and thus need a trust store set up so that endpoints can be validated correctly. This chapter discusses all of these things.
		</p><section class="section" id="bind-address"><div class="titlepage"><div><div><h2 class="title">7.1. Bind Addresses</h2></div></div></div><p>
				By default Red Hat Single Sign-On binds to the localhost loopback address <code class="literal">127.0.0.1</code>. That’s not a very useful default if you want the authentication server available on your network. Generally, what we recommend is that you deploy a reverse proxy or load balancer on a public network and route traffic to individual Red Hat Single Sign-On server instances on a private network. In either case though, you still need to set up your network interfaces to bind to something other than <code class="literal">localhost</code>.
			</p><p>
				Setting the bind address is quite easy and can be done on the command line with either the <span class="emphasis"><em>standalone.sh</em></span> or <span class="emphasis"><em>domain.sh</em></span> boot scripts discussed in the <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">Choosing an Operating Mode</a> chapter.
			</p><pre class="screen">$ standalone.sh -b 192.168.0.5</pre><p>
				The <code class="literal">-b</code> switch sets the IP bind address for any public interfaces.
			</p><p>
				Alternatively, if you don’t want to set the bind address at the command line, you can edit the profile configuration of your deployment. Open up the profile configuration file (<span class="emphasis"><em>standalone.xml</em></span> or <span class="emphasis"><em>domain.xml</em></span> depending on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>) and look for the <code class="literal">interfaces</code> XML block.
			</p><pre class="programlisting language-xml">    &lt;interfaces&gt;
        &lt;interface name="management"&gt;
            &lt;inet-address value="${jboss.bind.address.management:127.0.0.1}"/&gt;
        &lt;/interface&gt;
        &lt;interface name="public"&gt;
            &lt;inet-address value="${jboss.bind.address:127.0.0.1}"/&gt;
        &lt;/interface&gt;
    &lt;/interfaces&gt;</pre><p>
				The <code class="literal">public</code> interface corresponds to subsystems creating sockets that are available publicly. An example of one of these subsystems is the web layer which serves up the authentication endpoints of Red Hat Single Sign-On. The <code class="literal">management</code> interface corresponds to sockets opened up by the management layer of the JBoss EAP. Specifically the sockets which allow you to use the <code class="literal">jboss-cli.sh</code> command line interface and the JBoss EAP web console.
			</p><p>
				In looking at the <code class="literal">public</code> interface you see that it has a special string <code class="literal">${jboss.bind.address:127.0.0.1}</code>. This string denotes a value <code class="literal">127.0.0.1</code> that can be overriden on the command line by setting a Java system property, i.e.:
			</p><pre class="screen">$ domain.sh -Djboss.bind.address=192.168.0.5</pre><p>
				The <code class="literal">-b</code> is just a shorthand notation for this command. So, you can either change the bind address value directly in the profile config, or change it on the command line when you boot up.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					There are many more options available when setting up <code class="literal">interface</code> definitions. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#network_and_port_configuration">the network interface</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
				</p></div></div></section><section class="section" id="ports"><div class="titlepage"><div><div><h2 class="title">7.2. Socket Port Bindings</h2></div></div></div><p>
				The ports opened for each socket have a pre-defined default that can be overriden at the command line or within configuration. To illustrate this configuration, let’s pretend you are running in <a class="link" href="#standalone-mode" title="3.1. Standalone Mode">standalone mode</a> and open up the <span class="emphasis"><em>…​/standalone/configuration/standalone.xml</em></span>. Search for <code class="literal">socket-binding-group</code>.
			</p><pre class="programlisting language-xml">    &lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}"&gt;
        &lt;socket-binding name="management-http" interface="management" port="${jboss.management.http.port:9990}"/&gt;
        &lt;socket-binding name="management-https" interface="management" port="${jboss.management.https.port:9993}"/&gt;
        &lt;socket-binding name="ajp" port="${jboss.ajp.port:8009}"/&gt;
        &lt;socket-binding name="http" port="${jboss.http.port:8080}"/&gt;
        &lt;socket-binding name="https" port="${jboss.https.port:8443}"/&gt;
        &lt;socket-binding name="txn-recovery-environment" port="4712"/&gt;
        &lt;socket-binding name="txn-status-manager" port="4713"/&gt;
        &lt;outbound-socket-binding name="mail-smtp"&gt;
            &lt;remote-destination host="localhost" port="25"/&gt;
        &lt;/outbound-socket-binding&gt;
    &lt;/socket-binding-group&gt;</pre><p>
				<code class="literal">socket-bindings</code> define socket connections that will be opened by the server. These bindings specify the <code class="literal">interface</code> (bind address) they use as well as what port number they will open. The ones you will be most interested in are:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">http</span></dt><dd>
							Defines the port used for Red Hat Single Sign-On HTTP connections
						</dd><dt><span class="term">https</span></dt><dd>
							Defines the port used for Red Hat Single Sign-On HTTPS connections
						</dd><dt><span class="term">ajp</span></dt><dd>
							This socket binding defines the port used for the AJP protocol. This protocol is used by Apache HTTPD server in conjunction <code class="literal">mod-cluster</code> when you are using Apache HTTPD as a load balancer.
						</dd><dt><span class="term">management-http</span></dt><dd>
							Defines the HTTP connection used by JBoss EAP CLI and web console.
						</dd></dl></div><p>
				When running in <a class="link" href="#domain-mode" title="3.3. Domain Clustered Mode">domain mode</a> setting the socket configurations is a bit trickier as the example <span class="emphasis"><em>domain.xml</em></span> file has multiple <code class="literal">socket-binding-groups</code> defined. If you scroll down to the <code class="literal">server-group</code> definitions you can see what <code class="literal">socket-binding-group</code> is used for each <code class="literal">server-group</code>.
			</p><div class="formalpara"><p class="title"><strong>domain socket bindings</strong></p><p>
					
<pre class="programlisting language-xml">    &lt;server-groups&gt;
        &lt;server-group name="load-balancer-group" profile="load-balancer"&gt;
            ...
            &lt;socket-binding-group ref="load-balancer-sockets"/&gt;
        &lt;/server-group&gt;
        &lt;server-group name="auth-server-group" profile="auth-server-clustered"&gt;
            ...
            &lt;socket-binding-group ref="ha-sockets"/&gt;
        &lt;/server-group&gt;
    &lt;/server-groups&gt;</pre>
				</p></div><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					There are many more options available when setting up <code class="literal">socket-binding-group</code> definitions. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#network_and_port_configuration">the socket binding group</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
				</p></div></div></section><section class="section" id="setting_up_https_ssl"><div class="titlepage"><div><div><h2 class="title">7.3. Setting up HTTPS/SSL</h2></div></div></div><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
					Red Hat Single Sign-On is not set up by default to handle SSL/HTTPS. It is highly recommended that you either enable SSL on the Red Hat Single Sign-On server itself or on a reverse proxy in front of the Red Hat Single Sign-On server.
				</p></div></div><p>
				This default behavior is defined by the SSL/HTTPS mode of each Red Hat Single Sign-On realm. This is discussed in more detail in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.2/html-single/server_administration_guide/">Server Administration Guide</a>, but let’s give some context and a brief overview of these modes.
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">external requests</span></dt><dd>
							Red Hat Single Sign-On can run out of the box without SSL so long as you stick to private IP addresses like <code class="literal">localhost</code>, <code class="literal">127.0.0.1</code>, <code class="literal">10.0.x.x</code>, <code class="literal">192.168.x.x</code>, and <code class="literal">172..16.x.x</code>. If you don’t have SSL/HTTPS configured on the server or you try to access Red Hat Single Sign-On over HTTP from a non-private IP adress you will get an error.
						</dd><dt><span class="term">none</span></dt><dd>
							Red Hat Single Sign-On does not require SSL. This should really only be used in development when you are playing around with things.
						</dd><dt><span class="term">all requests</span></dt><dd>
							Red Hat Single Sign-On requires SSL for all IP addresses.
						</dd></dl></div><p>
				The SSL mode for each realm can be configured in the Red Hat Single Sign-On admin console.
			</p><section class="section" id="enabling_ssl_https_for_the_red_hat_single_sign_on_server"><div class="titlepage"><div><div><h3 class="title">7.3.1. Enabling SSL/HTTPS for the Red Hat Single Sign-On Server</h3></div></div></div><p>
					If you are not using a reverse proxy or load balancer to handle HTTPS traffic for you, you’ll need to enable HTTPS for the Red Hat Single Sign-On server. This involves
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							Obtaining or generating a keystore that contains the private key and certificate for SSL/HTTP traffic
						</li><li class="listitem">
							Configuring the Red Hat Single Sign-On server to use this keypair and certificate.
						</li></ol></div><section class="section" id="creating_the_certificate_and_java_keystore"><div class="titlepage"><div><div><h4 class="title">7.3.1.1. Creating the Certificate and Java Keystore</h4></div></div></div><p>
						In order to allow HTTPS connections, you need to obtain a self signed or third-party signed certificate and import it into a Java keystore before you can enable HTTPS in the web container you are deploying the Red Hat Single Sign-On Server to.
					</p><section class="section" id="self_signed_certificate"><div class="titlepage"><div><div><h5 class="title">7.3.1.1.1. Self Signed Certificate</h5></div></div></div><p>
							In development, you will probably not have a third party signed certificate available to test a Red Hat Single Sign-On deployment so you’ll need to generate a self-signed one using the <code class="literal">keytool</code> utility that comes with the Java JDK.
						</p><pre class="screen">$ keytool -genkey -alias localhost -keyalg RSA -keystore keycloak.jks -validity 10950
    Enter keystore password: secret
    Re-enter new password: secret
    What is your first and last name?
    [Unknown]:  localhost
    What is the name of your organizational unit?
    [Unknown]:  Keycloak
    What is the name of your organization?
    [Unknown]:  Red Hat
    What is the name of your City or Locality?
    [Unknown]:  Westford
    What is the name of your State or Province?
    [Unknown]:  MA
    What is the two-letter country code for this unit?
    [Unknown]:  US
    Is CN=localhost, OU=Keycloak, O=Test, L=Westford, ST=MA, C=US correct?
    [no]:  yes</pre><p>
							You should answer <code class="literal">What is your first and last name ?</code> question with the DNS name of the machine you’re installing the server on. For testing purposes, <code class="literal">localhost</code> should be used. After executing this command, the <code class="literal">keycloak.jks</code> file will be generated in the same directory as you executed the <code class="literal">keytool</code> command in.
						</p><p>
							If you want a third-party signed certificate, but don’t have one, you can obtain one for free at <a class="link" href="http://www.cacert.org">cacert.org</a>. You’ll have to do a little set up first before doing this though.
						</p><p>
							The first thing to do is generate a Certificate Request:
						</p><pre class="screen">$ keytool -certreq -alias yourdomain -keystore keycloak.jks &gt; keycloak.careq</pre><p>
							Where <code class="literal">yourdomain</code> is a DNS name for which this certificate is generated for. Keytool generates the request:
						</p><pre class="screen">-----BEGIN NEW CERTIFICATE REQUEST-----
MIIC2jCCAcICAQAwZTELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAk1BMREwDwYDVQQHEwhXZXN0Zm9y
ZDEQMA4GA1UEChMHUmVkIEhhdDEQMA4GA1UECxMHUmVkIEhhdDESMBAGA1UEAxMJbG9jYWxob3N0
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAr7kck2TaavlEOGbcpi9c0rncY4HhdzmY
Ax2nZfq1eZEaIPqI5aTxwQZzzLDK9qbeAd8Ji79HzSqnRDxNYaZu7mAYhFKHgixsolE3o5Yfzbw1
29RvyeUVe+WZxv5oo9wolVVpdSINIMEL2LaFhtX/c1dqiqYVpfnvFshZQaIg2nL8juzZcBjj4as
H98gIS7khql/dkZKsw9NLvyxgJvp7PaXurX29fNf3ihG+oFrL22oFyV54BWWxXCKU/GPn61EGZGw
Ft2qSIGLdctpMD1aJR2bcnlhEjZKDksjQZoQ5YMXaAGkcYkG6QkgrocDE2YXDbi7GIdf9MegVJ35
2DQMpwIDAQABoDAwLgYJKoZIhvcNAQkOMSEwHzAdBgNVHQ4EFgQUQwlZJBA+fjiDdiVzaO9vrE/i
n2swDQYJKoZIhvcNAQELBQADggEBAC5FRvMkhal3q86tHPBYWBuTtmcSjs4qUm6V6f63frhveWHf
PzRrI1xH272XUIeBk0gtzWo0nNZnf0mMCtUBbHhhDcG82xolikfqibZijoQZCiGiedVjHJFtniDQ
9bMDUOXEMQ7gHZg5q6mJfNG9MbMpQaUVEEFvfGEQQxbiFK7hRWU8S23/d80e8nExgQxdJWJ6vd0X
MzzFK6j4Dj55bJVuM7GFmfdNC52pNOD5vYe47Aqh8oajHX9XTycVtPXl45rrWAH33ftbrS8SrZ2S
vqIFQeuLL3BaHwpl3t7j2lMWcK1p80laAxEASib/fAwrRHpLHBXRcq6uALUOZl4Alt8=
-----END NEW CERTIFICATE REQUEST-----</pre><p>
							Send this ca request to your CA. The CA will issue you a signed certificate and send it to you. Before you import your new cert, you must obtain and import the root certificate of the CA. You can download the cert from CA (ie.: root.crt) and import as follows:
						</p><pre class="screen">$ keytool -import -keystore keycloak.jks -file root.crt -alias root</pre><p>
							Last step is to import your new CA generated certificate to your keystore:
						</p><pre class="screen">$ keytool -import -alias yourdomain -keystore keycloak.jks -file your-certificate.cer</pre></section></section><section class="section" id="configure_red_hat_single_sign_on_to_use_the_keystore"><div class="titlepage"><div><div><h4 class="title">7.3.1.2. Configure Red Hat Single Sign-On to Use the Keystore</h4></div></div></div><p>
						Now that you have a Java keystore with the appropriate certificates, you need to configure your Red Hat Single Sign-On installation to use it. First step is to move the keystore file to the <span class="emphasis"><em>configuration/</em></span> directory of your deployment and to edit the <span class="emphasis"><em>standalone.xml</em></span>, <span class="emphasis"><em>standalone-ha.xml</em></span> or <span class="emphasis"><em>domain.xml</em></span> file to use the keystore and enable HTTPS. (See <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>).
					</p><p>
						In the standalone or domain configuration file, search for the <code class="literal">security-realms</code> element and add:
					</p><pre class="programlisting language-xml">&lt;security-realm name="UndertowRealm"&gt;
    &lt;server-identities&gt;
        &lt;ssl&gt;
            &lt;keystore path="keycloak.jks" relative-to="jboss.server.config.dir" keystore-password="secret" /&gt;
        &lt;/ssl&gt;
    &lt;/server-identities&gt;
&lt;/security-realm&gt;</pre><p>
						Find the element <code class="literal">server name="default-server"</code> (it’s a child element of <code class="literal">subsystem xmlns="urn:jboss:domain:undertow:3.1"</code>) and add:
					</p><pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:3.1"&gt;
   &lt;buffer-cache name="default"/&gt;
   &lt;server name="default-server"&gt;
      &lt;https-listener name="https" socket-binding="https" security-realm="UndertowRealm"/&gt;
   ...
&lt;/subsystem&gt;</pre></section></section></section><section class="section" id="outgoing_http_requests"><div class="titlepage"><div><div><h2 class="title">7.4. Outgoing HTTP Requests</h2></div></div></div><p>
				The Red Hat Single Sign-On server often needs to make non-browser HTTP requests to the applications and services it secures. The auth server manages these outgoing connections by maintaining an HTTP client connection pool. There are some things you’ll need to configure in <code class="literal">standalone.xml</code>, <code class="literal">standalone-ha.xml</code>, or <code class="literal">domain.xml</code>. The location of this file depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>.
			</p><div class="formalpara"><p class="title"><strong>HTTP client Config example</strong></p><p>
					
<pre class="programlisting language-xml">&lt;spi name="connectionsHttpClient"&gt;
    &lt;provider name="default" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="connection-pool-size" value="256"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
&lt;/spi&gt;</pre>
				</p></div><p>
				Possible configuration options are:
			</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">establish-connection-timeout-millis</span></dt><dd>
							Timeout for establishing a socket connection.
						</dd><dt><span class="term">socket-timeout-millis</span></dt><dd>
							If an outgoing request does not receive data for this amount of time, timeout the connection.
						</dd><dt><span class="term">connection-pool-size</span></dt><dd>
							How many connections can be in the pool (128 by default).
						</dd><dt><span class="term">max-pooled-per-route</span></dt><dd>
							How many connections can be pooled per host (64 by default).
						</dd><dt><span class="term">connection-ttl-millis</span></dt><dd>
							Maximum connection time to live in milliseconds. Not set by default.
						</dd><dt><span class="term">max-connection-idle-time-millis</span></dt><dd>
							Maximum time the connection might stay idle in the connection pool (900 seconds by default). Will start background cleaner thread of Apache HTTP client. Set to -<code class="literal">1</code> to disable this checking and the background thread.
						</dd><dt><span class="term">disable-cookies</span></dt><dd>
							<code class="literal">true</code> by default. When set to true, this will disable any cookie caching.
						</dd><dt><span class="term">client-keystore</span></dt><dd>
							This is the file path to a Java keystore file. This keystore contains client certificate for two-way SSL.
						</dd><dt><span class="term">client-keystore-password</span></dt><dd>
							Password for the client keystore. This is <span class="emphasis"><em>REQUIRED</em></span> if <code class="literal">client-keystore</code> is set.
						</dd><dt><span class="term">client-key-password</span></dt><dd>
							Password for the client’s key. This is <span class="emphasis"><em>REQUIRED</em></span> if <code class="literal">client-keystore</code> is set.
						</dd></dl></div><section class="section" id="truststore"><div class="titlepage"><div><div><h3 class="title">7.4.1. Outgoing HTTPS Request Truststore</h3></div></div></div><p>
					When Red Hat Single Sign-On invokes on remote HTTPS endpoints, it has to validate the remote server’s certificate in order to ensure it is connecting to a trusted server. This is necessary in order to prevent man-in-the-middle attacks. The certificates of these remote server’s or the CA that signed these certificates must be put in a truststore. This truststore is managed by the Red Hat Single Sign-On server.
				</p><p>
					The truststore is used when connecting securely to identity brokers, LDAP identity providers, when sending emails, and for backchannel communication with client applications.
				</p><div class="admonition warning"><div class="admonition_header">Warning</div><div><p>
						By default, a truststore provider is not configured, and any https connections fall back to standard java truststore configuration as described in <a class="link" href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html">Java’s JSSE Reference Guide</a>. If there is no trust establised, then these outgoing HTTPS requests will fail.
					</p></div></div><p>
					You can use <span class="emphasis"><em>keytool</em></span> to create a new truststore file or add trusted host certificates to an existing one:
				</p><pre class="screen">$ keytool -import -alias HOSTDOMAIN -keystore truststore.jks -file host-certificate.cer</pre><p>
					The truststore is configured within the <code class="literal">standalone.xml</code>, <code class="literal">standalone-ha.xml</code>, or <code class="literal">domain.xml</code> file in your distribution. The location of this file depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>. You can add your truststore configuration by using the following template:
				</p><pre class="programlisting language-xml">&lt;spi name="truststore"&gt;
    &lt;provider name="file" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="file" value="path to your .jks file containing public certificates"/&gt;
            &lt;property name="password" value="password"/&gt;
            &lt;property name="hostname-verification-policy" value="WILDCARD"/&gt;
            &lt;property name="disabled" value="false"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
&lt;/spi&gt;</pre><p>
					Possible configuration options for this setting are:
				</p><div class="variablelist"><dl class="variablelist"><dt><span class="term">file</span></dt><dd>
								The path to a Java keystore file. HTTPS requests need a way to verify the host of the server they are talking to. This is what the trustore does. The keystore contains one or more trusted host certificates or certificate authorities. This truststore file should only contain public certificates of your secured hosts. This is <span class="emphasis"><em>REQUIRED</em></span> if <code class="literal">disabled</code> is not true.
							</dd><dt><span class="term">password</span></dt><dd>
								Password for the truststore. This is <span class="emphasis"><em>REQUIRED</em></span> if <code class="literal">disabled</code> is not true.
							</dd><dt><span class="term">hostname-verification-policy</span></dt><dd>
								<code class="literal">WILDCARD</code> by default. For HTTPS requests, this verifies the hostname of the server’s certificate. <code class="literal">ANY</code> means that the hostname is not verified. <code class="literal">WILDCARD</code> Allows wildcards in subdomain names i.e. *.foo.com. <code class="literal">STRICT</code> CN must match hostname exactly.
							</dd><dt><span class="term">disabled</span></dt><dd>
								If true (default value), truststore configuration will be ignored, and certificate checking will fall back to JSSE configuration as described. If set to false, you must configure <code class="literal">file</code>, and <code class="literal">password</code> for the truststore.
							</dd></dl></div></section></section></section><section class="chapter" id="clustering"><div class="titlepage"><div><div><h1 class="title">Chapter 8. Clustering</h1></div></div></div><p>
			This section covers configuring Red Hat Single Sign-On to run in a cluster. There’s a number of things you have to do when setting up a cluster, specifically:
		</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
					<a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">Pick an operation mode</a>
				</li><li class="listitem">
					<a class="link" href="#database" title="Chapter 6. Relational Database Setup">Configure a shared external database</a>
				</li><li class="listitem">
					Set up a load balancer
				</li><li class="listitem">
					Supplying a private network that supports IP multicast
				</li></ul></div><p>
			Picking an operation mode and configuring a shared database have been discussed earlier in this guide. In this chapter we’ll discuss setting up a load balancer and supplying a private network. We’ll also discuss some issues that you need to be aware of when booting up a host in the cluster.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				It is possible to cluster Red Hat Single Sign-On without IP Multicast, but this topic is beyond the scope of this guide. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#cluster_communication_jgroups">JGroups</a> chapter of the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
			</p></div></div><section class="section" id="recommended_network_architecture"><div class="titlepage"><div><div><h2 class="title">8.1. Recommended Network Architecture</h2></div></div></div><p>
				The recommended network architecture for deploying Red Hat Single Sign-On is to set up an HTTP/HTTPS load balancer on a public IP address that routes requests to Red Hat Single Sign-On servers sitting on a private network. This isolates all clustering connections and provides a nice means of protecting the servers.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					By default, there is nothing to prevent unauthorized nodes from joining the cluster and broadcasting multicast messages. This is why cluster nodes should be in a private network, with a firewall protecting them from outside attacks.
				</p></div></div></section><section class="section" id="clustering_example"><div class="titlepage"><div><div><h2 class="title">8.2. Clustering Example</h2></div></div></div><p>
				Red Hat Single Sign-On does come with an out of the box clustering demo that leverages domain mode. Review the <a class="link" href="#clustered-domain-example" title="3.3.5. Clustered Domain Example">Clustered Domain Example</a> chapter for more details.
			</p></section><section class="section" id="setting-up-a-load-balancer-or-proxy"><div class="titlepage"><div><div><h2 class="title">8.3. Setting Up a Load Balancer or Proxy</h2></div></div></div><p>
				This section discusses a number of things you need to configure before you can put a reverse proxy or load balancer in front of your clustered Red Hat Single Sign-On deployment. It also covers configuring the built in load balancer that was <a class="link" href="#clustered-domain-example" title="3.3.5. Clustered Domain Example">Clustered Domain Example</a>.
			</p><section class="section" id="identifying_client_ip_addresses"><div class="titlepage"><div><div><h3 class="title">8.3.1. Identifying Client IP Addresses</h3></div></div></div><p>
					A few features in Red Hat Single Sign-On rely on the fact that the remote address of the HTTP client connecting to the authentication server is the real IP address of the client machine. Examples include:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Event logs - a failed login attempt would be logged with the wrong source IP address
						</li><li class="listitem">
							SSL required - if the SSL required is set to external (the default) it should require SSL for all external requests
						</li><li class="listitem">
							Authentication flows - a custom authentication flow that uses the IP address to for example show OTP only for external requests
						</li><li class="listitem">
							Dynamic Client Registration
						</li></ul></div><p>
					This can be problematic when you have a reverse proxy or loadbalancer in front of your Red Hat Single Sign-On authentication server. The usual setup is that you have a frontend proxy sitting on a public network that load balances and forwards requests to backend Red Hat Single Sign-On server instances located in a private network. There is some extra configuration you have to do in this scenario so that the actual client IP address is forwarded to and processed by the Red Hat Single Sign-On server instances. Specifically:
				</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
							Configure your reverse proxy or loadbalancer to properly set <code class="literal">X-Forwarded-For</code> and <code class="literal">X-Forwarded-Proto</code> HTTP headers.
						</li><li class="listitem">
							Configure your reverse proxy or loadbalancer to preserve the original 'Host' HTTP header.
						</li><li class="listitem">
							Configure the authentication server to read the client’s IP address from <code class="literal">X-Forwarded-For header</code>.
						</li></ul></div><p>
					Configuring your proxy to generate the <code class="literal">X-Forwarded-For</code> and <code class="literal">X-Forwarded-Proto</code> HTTP headers and preserving the original <code class="literal">Host</code> HTTP header is beyond the scope of this guide. Take extra precautions to ensure that the <code class="literal">X-Forwared-For</code> header is set by your proxy. If your proxy isn’t configured correctly, then <span class="emphasis"><em>rogue</em></span> clients can set this header themselves and trick Red Hat Single Sign-On into thinking the client is connecting from a different IP address than it actually is. This becomes really important if you are doing any black or white listing of IP addresses.
				</p><p>
					Beyond the proxy itself, there are a few things you need to configure on the Red Hat Single Sign-On side of things. If your proxy is forwarding requests via the HTTP protocol, then you need to configure Red Hat Single Sign-On to pull the client’s IP address from the <code class="literal">X-Forwarded-For</code> header rather than from the network packet. To do this, open up the profile configuration file (<span class="emphasis"><em>standalone.xml</em></span>, <span class="emphasis"><em>standalone-ha.xml</em></span>, or <span class="emphasis"><em>domain.xml</em></span> depending on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>) and look for the <code class="literal">urn:jboss:domain:undertow:3.1</code> XML block.
				</p><div class="formalpara"><p class="title"><strong><code class="literal">X-Forwarded-For</code> HTTP Config</strong></p><p>
						
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:3.1"&gt;
   &lt;buffer-cache name="default"/&gt;
   &lt;server name="default-server"&gt;
      &lt;ajp-listener name="ajp" socket-binding="ajp"/&gt;
      &lt;http-listener name="default" socket-binding="http" redirect-socket="https"
          proxy-address-forwarding="true"/&gt;
      ...
   &lt;/server&gt;
   ...
&lt;/subsystem&gt;</pre>
					</p></div><p>
					Add the <code class="literal">proxy-address-forwarding</code> attribute to the <code class="literal">http-listener</code> element. Set the value to <code class="literal">true</code>.
				</p><p>
					If your proxy is using the AJP protocol instead of HTTP to forward requests (i.e. Apache HTTPD + mod-cluster), then you have to configure things a little differently. Instead of modifying the <code class="literal">http-listener</code>, you need to add a filter to pull this information from the AJP packets.
				</p><div class="formalpara"><p class="title"><strong><code class="literal">X-Forwarded-For</code> AJP Config</strong></p><p>
						
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:3.1"&gt;
     &lt;buffer-cache name="default"/&gt;
     &lt;server name="default-server"&gt;
         &lt;ajp-listener name="ajp" socket-binding="ajp"/&gt;
         &lt;http-listener name="default" socket-binding="http" redirect-socket="https"/&gt;
         &lt;host name="default-host" alias="localhost"&gt;
             ...
             &lt;filter-ref name="proxy-peer"/&gt;
         &lt;/host&gt;
     &lt;/server&gt;
        ...
     &lt;filters&gt;
         ...
         &lt;filter name="proxy-peer"
                 class-name="io.undertow.server.handlers.ProxyPeerAddressHandler"
                 module="io.undertow.core" /&gt;
     &lt;/filters&gt;
 &lt;/subsystem&gt;</pre>
					</p></div></section><section class="section" id="enable_https_ssl_with_a_reverse_proxy"><div class="titlepage"><div><div><h3 class="title">8.3.2. Enable HTTPS/SSL with a Reverse Proxy</h3></div></div></div><p>
					Assuming that your reverse proxy doesn’t use port 8443 for SSL you also need to configure what port HTTPS traffic is redirected to.
				</p><pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:3.1"&gt;
    ...
    &lt;http-listener name="default" socket-binding="http"
        proxy-address-forwarding="true" redirect-socket="proxy-https"/&gt;
    ...
&lt;/subsystem&gt;</pre><p>
					Add the <code class="literal">redirect-socket</code> attribute to the <code class="literal">http-listener</code> element. The value should be <code class="literal">proxy-https</code> which points to a socket binding you also need to define.
				</p><p>
					Then add a new <code class="literal">socket-binding</code> element to the <code class="literal">socket-binding-group</code> element:
				</p><pre class="programlisting language-xml">&lt;socket-binding-group name="standard-sockets" default-interface="public"
    port-offset="${jboss.socket.binding.port-offset:0}"&gt;
    ...
    &lt;socket-binding name="proxy-https" port="443"/&gt;
    ...
&lt;/socket-binding-group&gt;</pre></section><section class="section" id="verify_configuration"><div class="titlepage"><div><div><h3 class="title">8.3.3. Verify Configuration</h3></div></div></div><p>
					You can verify the reverse proxy or load balancer configuration by opening the path <code class="literal">/auth/realms/master/.well-known/openid-configuration</code> through the reverse proxy. For example if the reverse proxy address is <code class="literal">https://acme.com/</code> then open the URL <code class="literal">https://acme.com/auth/realms/master/.well-known/openid-configuration</code>. This will show a JSON document listing a number of endpoints for Red Hat Single Sign-On. Make sure the endpoints starts with the address (scheme, domain and port) of your reverse proxy or load balancer. By doing this you make sure that Red Hat Single Sign-On is using the correct endpoint.
				</p><p>
					You should also verify that Red Hat Single Sign-On sees the correct source IP address for requests. Do check this you can try to login to the admin console with an invalid username and/or password. This should show a warning in the server log something like this:
				</p><pre class="screen">08:14:21,287 WARN  XNIO-1 task-45 [org.keycloak.events] type=LOGIN_ERROR, realmId=master, clientId=security-admin-console, userId=8f20d7ba-4974-4811-a695-242c8fbd1bf8, ipAddress=X.X.X.X, error=invalid_user_credentials, auth_method=openid-connect, auth_type=code, redirect_uri=http://localhost:8080/auth/admin/master/console/?redirect_fragment=%2Frealms%2Fmaster%2Fevents-settings, code_id=a3d48b67-a439-4546-b992-e93311d6493e, username=admin</pre><p>
					Check that the value of <code class="literal">ipAddress</code> is the IP address of the machine you tried to login with and not the IP address of the reverse proxy or load balancer.
				</p></section><section class="section" id="using_the_built_in_load_balancer"><div class="titlepage"><div><div><h3 class="title">8.3.4. Using the Built-In Load Balancer</h3></div></div></div><p>
					This section covers configuring the built in load balancer that is discussed in the <a class="link" href="#clustered-domain-example" title="3.3.5. Clustered Domain Example">Clustered Domain Example</a>.
				</p><p>
					The <a class="link" href="#clustered-domain-example" title="3.3.5. Clustered Domain Example">Clustered Domain Example</a> is only designed to run on one machine. To bring up a slave on another host, you’ll need to
				</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
							Edit the <span class="emphasis"><em>domain.xml</em></span> file to point to your new host slave
						</li><li class="listitem">
							Copy the server distribution. You don’t need the <span class="emphasis"><em>domain.xml</em></span>, <span class="emphasis"><em>host.xml</em></span>, or <span class="emphasis"><em>host-master.xml</em></span> files. Nor do you need the <span class="emphasis"><em>standalone/</em></span> directory.
						</li><li class="listitem">
							Edit the <span class="emphasis"><em>host-slave.xml</em></span> file to change the bind addresses used or override them on the command line
						</li></ol></div><section class="section" id="register_a_new_host_with_load_balancer"><div class="titlepage"><div><div><h4 class="title">8.3.4.1. Register a New Host With Load Balancer</h4></div></div></div><p>
						Let’s look first at registering the new host slave with the load balancer configuration in <span class="emphasis"><em>domain.xml</em></span>. Open this file and go to the undertow configuration in the <code class="literal">load-balancer</code> profile. Add a new <code class="literal">host</code> definition called <code class="literal">remote-host3</code> within the <code class="literal">reverse-proxy</code> XML block.
					</p><div class="formalpara"><p class="title"><strong>domain.xml reverse-proxy config</strong></p><p>
							
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:3.1"&gt;
  ...
  &lt;handlers&gt;
      &lt;reverse-proxy name="lb-handler"&gt;
         &lt;host name="host1" outbound-socket-binding="remote-host1" scheme="ajp" path="/" instance-id="myroute1"/&gt;
         &lt;host name="host2" outbound-socket-binding="remote-host2" scheme="ajp" path="/" instance-id="myroute2"/&gt;
         &lt;host name="remote-host3" outbound-socket-binding="remote-host3" scheme="ajp" path="/" instance-id="myroute3"/&gt;
      &lt;/reverse-proxy&gt;
  &lt;/handlers&gt;
  ...
&lt;/subsystem&gt;</pre>
						</p></div><p>
						The <code class="literal">output-socket-binding</code> is a logical name pointing to a <code class="literal">socket-binding</code> configured later in the <span class="emphasis"><em>domain.xml</em></span> file. the <code class="literal">instance-id</code> attribute must also be unique to the new host as this value is used by a cookie to enable sticky sessions when load balancing.
					</p><p>
						Next go down to the <code class="literal">load-balancer-sockets</code> <code class="literal">socket-binding-group</code> and add the <code class="literal">outbound-socket-binding</code> for <code class="literal">remote-host3</code>. This new binding needs to point to the host and port of the new host.
					</p><div class="formalpara"><p class="title"><strong>domain.xml outbound-socket-binding</strong></p><p>
							
<pre class="programlisting language-xml">&lt;socket-binding-group name="load-balancer-sockets" default-interface="public"&gt;
    ...
    &lt;outbound-socket-binding name="remote-host1"&gt;
        &lt;remote-destination host="localhost" port="8159"/&gt;
    &lt;/outbound-socket-binding&gt;
    &lt;outbound-socket-binding name="remote-host2"&gt;
        &lt;remote-destination host="localhost" port="8259"/&gt;
    &lt;/outbound-socket-binding&gt;
    &lt;outbound-socket-binding name="remote-host3"&gt;
        &lt;remote-destination host="192.168.0.5" port="8259"/&gt;
    &lt;/outbound-socket-binding&gt;
&lt;/socket-binding-group&gt;</pre>
						</p></div></section><section class="section" id="master_bind_addresses"><div class="titlepage"><div><div><h4 class="title">8.3.4.2. Master Bind Addresses</h4></div></div></div><p>
						Next thing you’ll have to do is to change the <code class="literal">public</code> and <code class="literal">management</code> bind addresses for the master host. Either edit the <span class="emphasis"><em>domain.xml</em></span> file as discussed in the <a class="link" href="#bind-address" title="7.1. Bind Addresses">Bind Addresses</a> chapter or specify these bind addresses on the command line as follows:
					</p><pre class="screen">$ domain.sh --host-config=host-master.xml -Djboss.bind.address=192.168.0.2 -Djboss.bind.address.management=192.168.0.2</pre></section><section class="section" id="host_slave_bind_addresses"><div class="titlepage"><div><div><h4 class="title">8.3.4.3. Host Slave Bind Addresses</h4></div></div></div><p>
						Next you’ll have to change the <code class="literal">public</code>, <code class="literal">management</code>, and domain controller bind addresses (<code class="literal">jboss.domain.master-address</code>). Either edit the <span class="emphasis"><em>host-slave.xml</em></span> file or specify them on the command line as follows:
					</p><pre class="screen">$ domain.sh --host-config=host-slave.xml
     -Djboss.bind.address=192.168.0.5
      -Djboss.bind.address.management=192.168.0.5
       -Djboss.domain.master.address=192.168.0.2</pre><p>
						The values of <code class="literal">jboss.bind.address</code> and <code class="literal">jboss.bind.addres.management</code> pertain to the host slave’s IP address. The value of <code class="literal">jboss.domain.master.address</code> need to be the IP address of the domain controller which is the management address of the master host.
					</p></section></section><section class="section" id="configuring_other_load_balancers"><div class="titlepage"><div><div><h3 class="title">8.3.5. Configuring Other Load Balancers</h3></div></div></div><p>
					See <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#configuring_high_availability">the load balancing</a> section in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span> for information how to use other software-based load balancers.
				</p></section></section><section class="section" id="sticky_sessions"><div class="titlepage"><div><div><h2 class="title">8.4. Sticky sessions</h2></div></div></div><p>
				Typical cluster deployment consists of the load balancer (reverse proxy) and 2 or more Red Hat Single Sign-On servers on private network. For performance purposes, it may be useful if load balancer forwards all requests related to particular browser session to the same Red Hat Single Sign-On backend node.
			</p><p>
				The reason is, that Red Hat Single Sign-On is using infinispan distributed cache under the covers for save data related to current authentication session and user session. The Infinispan distributed caches are configured with one owner by default. That means that particular session is saved just on one cluster node and the other nodes need to lookup the session remotely if they want to access it.
			</p><p>
				For example if authentication session with ID <code class="literal">123</code> is saved in the infinispan cache on <code class="literal">node1</code>, and then <code class="literal">node2</code> needs to lookup this session, it needs to send the request to <code class="literal">node1</code> over the network to return the particular session entity.
			</p><p>
				It is beneficial if particular session entity is always available locally, which can be done with the help of sticky sessions. The workflow in the cluster environment with the public frontend load balancer and two backend Red Hat Single Sign-On nodes can be like this:
			</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
						User sends initial request to see the Red Hat Single Sign-On login screen
					</li><li class="listitem">
						This request is served by the frontend load balancer, which forwards it to some random node (eg. node1). Strictly said, the node doesn’t need to be random, but can be chosen according to some other criterias (client IP address etc). It all depends on the implementation and configuration of underlying load balancer (reverse proxy).
					</li><li class="listitem">
						Red Hat Single Sign-On creates authentication session with random ID (eg. 123) and saves it to the Infinispan cache.
					</li><li class="listitem">
						Infinispan distributed cache assigns the primary owner of the session based on the hash of session ID. See <a class="link" href="http://infinispan.org/docs/8.2.x/user_guide/user_guide.html#distribution_mode">Infinispan documentation</a> for more details around this. Let’s assume that infinispan assigned <code class="literal">node2</code> to be the owner of this session.
					</li><li class="listitem">
						Red Hat Single Sign-On creates the cookie <code class="literal">AUTH_SESSION_ID</code> with the format like <code class="literal">&lt;session-id&gt;.&lt;owner-node-id&gt;</code> . In our example case, it will be <code class="literal">123.node2</code> .
					</li><li class="listitem">
						Response is returned to the user with the Red Hat Single Sign-On login screen and the AUTH_SESSION_ID cookie in the browser
					</li></ul></div><p>
				From this point, it is beneficial if load balancer forwards all the next requests to the <code class="literal">node2</code> as this is the node, who is owner of the authentication session with ID <code class="literal">123</code> and hence Infinispan can lookup this session locally. After authentication is finished, the authentication session is converted to user session, which will be also saved on <code class="literal">node2</code> because it has same ID <code class="literal">123</code> .
			</p><p>
				The sticky session is not mandatory for the cluster setup, however it is good for performance for the reasons mentioned above. You need to configure your loadbalancer to sticky over the <code class="literal">AUTH_SESSION_ID</code> cookie. How exactly do this is dependent on your loadbalancer.
			</p><p>
				Some loadbalancers can be configured to add the route information by themselves instead of rely on the backend Red Hat Single Sign-On node. However adding the route by the Red Hat Single Sign-On is more clever as Red Hat Single Sign-On knows, who is the owner of particular session entity and can route it to that node, which is not necessarily the local node. We plan to support the setup where the route info won’t be added to AUTH_SESSION_ID cookie by the Red Hat Single Sign-On server, but instead by the load balancer. However adding the cookie by Red Hat Single Sign-On would be still the preferred option.
			</p><section class="section" id="example_cluster_setup_with_mod_cluster"><div class="titlepage"><div><div><h3 class="title">8.4.1. Example cluster setup with mod_cluster</h3></div></div></div><p>
					In the example, we will use <a class="link" href="http://mod-cluster.jboss.org/">Mod Cluster</a> as load balancer. One of the key features of mod cluster is, that there is not much configuration on the load balancer side. Instead it requires support on the backend node side. Backend nodes communicate with the load balancer through the dedicated protocol called MCMP and they notify loadbalancer about various events (eg. node joined or left cluster, new application was deployed etc).
				</p><p>
					Example setup will consist of the one JBoss EAP 7.0 load balancer node and two Red Hat Single Sign-On nodes.
				</p><p>
					Clustering example require MULTICAST to be enabled on machine’s loopback network interface. This can be done by running the following commands under root privileges (on linux):
				</p><pre class="screen">route add -net 224.0.0.0 netmask 240.0.0.0 dev lo
ifconfig lo multicast</pre><section class="section" id="load_balancer_configuration"><div class="titlepage"><div><div><h4 class="title">8.4.1.1. Load Balancer Configuration</h4></div></div></div><p>
						Unzip the JBoss EAP 7.0 server somewhere. Assumption is location <code class="literal">EAP_LB</code>
					</p><p>
						Edit <code class="literal">EAP_LB/standalone/configuration/standalone.xml</code> file. In the undertow subsystem add the mod_cluster configuration under filters like this:
					</p><pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:undertow:4.0"&gt;
 ...
 &lt;filters&gt;
  ...
  &lt;mod-cluster name="modcluster" advertise-socket-binding="modcluster"
      advertise-frequency="${modcluster.advertise-frequency:2000}"
      management-socket-binding="http" enable-http2="true"/&gt;
 &lt;/filters&gt;</pre><p>
						and <code class="literal">filter-ref</code> under <code class="literal">default-host</code> like this:
					</p><pre class="programlisting language-xml">&lt;host name="default-host" alias="localhost"&gt;
    ...
    &lt;filter-ref name="modcluster"/&gt;
&lt;/host&gt;</pre><p>
						Then under <code class="literal">socket-binding-group</code> add this group:
					</p><pre class="programlisting language-xml">&lt;socket-binding name="modcluster" port="0"
    multicast-address="${jboss.modcluster.multicast.address:224.0.1.105}"
    multicast-port="23364"/&gt;</pre><p>
						Save the file and run the server:
					</p><pre class="screen">cd $WILDFLY_LB/bin
./standalone.sh</pre></section><section class="section" id="backend_node_configuration"><div class="titlepage"><div><div><h4 class="title">8.4.1.2. Backend node configuration</h4></div></div></div><p>
						Unzip the Red Hat Single Sign-On server distribution to some location. Assuming location is <code class="literal">RHSSO_NODE1</code> .
					</p><p>
						Edit <code class="literal">RHSSO_NODE1/standalone/configuration/standalone-ha.xml</code> and configure datasource against the shared database. See <a class="link" href="#rdbms-setup-checklist" title="6.1. RDBMS Setup Checklist">Database chapter</a> for more details.
					</p><p>
						In the undertow subsystem, add the <code class="literal">session-config</code> under the <code class="literal">servlet-container</code> element:
					</p><pre class="programlisting language-xml">&lt;servlet-container name="default"&gt;
    &lt;session-cookie name="AUTH_SESSION_ID" http-only="true" /&gt;
    ...
&lt;/servlet-container&gt;</pre><p>
						Then you can configure <code class="literal">proxy-address-forwarding</code> as described in the chapter <a class="link" href="#setting-up-a-load-balancer-or-proxy" title="8.3. Setting Up a Load Balancer or Proxy">Load Balancer</a> . Note that mod_cluster uses AJP connector by default, so you need to configure that one.
					</p><p>
						That’s all as mod_cluster is already configured.
					</p><p>
						The node name of the Red Hat Single Sign-On can be detected automatically based on the hostname of current server. However for more fine grained control, it is recommended to use system property <code class="literal">jboss.node.name</code> to specify the node name directly. It is especially useful in case that you test with 2 backend nodes on same physical server etc. So you can run the startup command like this:
					</p><pre class="screen">cd $RHSSO_NODE1
./standalone.sh -c standalone-ha.xml -Djboss.socket.binding.port-offset=100 -Djboss.node.name=node1</pre><p>
						Configure the second backend server in same way and run with different port offset and node name.
					</p><pre class="screen">cd $RHSSO_NODE2
./standalone.sh -c standalone-ha.xml -Djboss.socket.binding.port-offset=200 -Djboss.node.name=node2</pre><p>
						Access the server on <code class="literal"><a class="link" href="http://localhost:8080/auth">http://localhost:8080/auth</a></code> . Creation of admin user is possible just from local address and without load balancer (proxy) access, so you first need to access backend node directly on <code class="literal"><a class="link" href="http://localhost:8180/auth">http://localhost:8180/auth</a></code> to create admin user.
					</p></section></section></section><section class="section" id="multicast_network_setup"><div class="titlepage"><div><div><h2 class="title">8.5. Multicast Network Setup</h2></div></div></div><p>
				Out of the box clustering support needs IP Multicast. Multicast is a network broadcast protocol. This protocol is used at boot time to discover and join the cluster. It is also used to broadcast messages for the replication and invalidation of distributed caches used by Red Hat Single Sign-On.
			</p><p>
				The clustering subsystem for Red Hat Single Sign-On runs on the JGroups stack. Out of the box, the bind addresses for clustering are bound to a private network interface with 127.0.0.1 as default IP address. You have to edit your the <span class="emphasis"><em>standalone-ha.xml</em></span> or <span class="emphasis"><em>domain.xml</em></span> sections discussed in the <a class="link" href="#bind-address" title="7.1. Bind Addresses">Bind Address</a> chapter.
			</p><div class="formalpara"><p class="title"><strong>private network config</strong></p><p>
					
<pre class="programlisting language-xml">    &lt;interfaces&gt;
        ...
        &lt;interface name="private"&gt;
            &lt;inet-address value="${jboss.bind.address.private:127.0.0.1}"/&gt;
        &lt;/interface&gt;
    &lt;/interfaces&gt;
    &lt;socket-binding-group name="standard-sockets" default-interface="public" port-offset="${jboss.socket.binding.port-offset:0}"&gt;
        ...
        &lt;socket-binding name="jgroups-mping" interface="private" port="0" multicast-address="${jboss.default.multicast.address:230.0.0.4}" multicast-port="45700"/&gt;
        &lt;socket-binding name="jgroups-tcp" interface="private" port="7600"/&gt;
        &lt;socket-binding name="jgroups-tcp-fd" interface="private" port="57600"/&gt;
        &lt;socket-binding name="jgroups-udp" interface="private" port="55200" multicast-address="${jboss.default.multicast.address:230.0.0.4}" multicast-port="45688"/&gt;
        &lt;socket-binding name="jgroups-udp-fd" interface="private" port="54200"/&gt;
        &lt;socket-binding name="modcluster" port="0" multicast-address="224.0.1.105" multicast-port="23364"/&gt;
        ...
    &lt;/socket-binding-group&gt;</pre>
				</p></div><p>
				Things you’ll want to configure are the <code class="literal">jboss.bind.address.private</code> and <code class="literal">jboss.default.multicast.address</code> as well as the ports of the services on the clustering stack.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					It is possible to cluster Red Hat Single Sign-On without IP Multicast, but this topic is beyond the scope of this guide. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#cluster_communication_jgroups">JGroups</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
				</p></div></div></section><section class="section" id="securing_cluster_communication"><div class="titlepage"><div><div><h2 class="title">8.6. Securing Cluster Communication</h2></div></div></div><p>
				When cluster nodes are isolated on a private network it requires access to the private network to be able to join a cluster or to view communication in the cluster. In addition you can also enable authentication and encryption for cluster communication. As long as your private network is secure it is not necessary to enable authentication and encryption. Red Hat Single Sign-On does not send very sensitive information on the cluster in either case.
			</p><p>
				If you want to enable authentication and encryption for clustering communication see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/configuration_guide/configuring_high_availability#securing_cluster">Securing a Cluster</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
			</p></section><section class="section" id="clustering_db_lock"><div class="titlepage"><div><div><h2 class="title">8.7. Serialized Cluster Startup</h2></div></div></div><p>
				Red Hat Single Sign-On cluster nodes are allowed to boot concurrenty. When Red Hat Single Sign-On server instance boots up it may do some database migration, importing, or first time initializations. A DB lock is used to prevent start actions from conflicting with one another when cluster nodes boot up concurrently.
			</p><p>
				By default, the maximum timeout for this lock is 900 seconds. If a node is waiting on this lock for more than the timeout it will fail to boot. Typically you won’t need to increase/decrease the default value, but just in case it’s possible to configure it in <code class="literal">standalone.xml</code>, <code class="literal">standalone-ha.xml</code>, or <code class="literal">domain.xml</code> file in your distribution. The location of this file depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>.
			</p><pre class="programlisting language-xml">&lt;spi name="dblock"&gt;
    &lt;provider name="jpa" enabled="true"&gt;
        &lt;properties&gt;
            &lt;property name="lockWaitTimeout" value="900"/&gt;
        &lt;/properties&gt;
    &lt;/provider&gt;
&lt;/spi&gt;</pre></section><section class="section" id="booting_the_cluster"><div class="titlepage"><div><div><h2 class="title">8.8. Booting the Cluster</h2></div></div></div><p>
				Booting Red Hat Single Sign-On in a cluster depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>
			</p><div class="formalpara"><p class="title"><strong>Standalone Mode</strong></p><p>
					
<pre class="screen">$ bin/standalone.sh --server-config=standalone-ha.xml</pre>
				</p></div><div class="formalpara"><p class="title"><strong>Domain Mode</strong></p><p>
					
<pre class="screen">$ bin/domain.sh --host-config=host-master.xml
$ bin/domain.sh --host-config=host-slave.xml</pre>
				</p></div></section><section class="section" id="troubleshooting"><div class="titlepage"><div><div><h2 class="title">8.9. Troubleshooting</h2></div></div></div><p>
				Note that when you run cluster, you should see message similar to this in the log of both cluster nodes:
			</p><pre class="screen">INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-10,shared=udp)
ISPN000094: Received new cluster view: [node1/keycloak|1] (2) [node1/keycloak, node2/keycloak]</pre><p>
				If you see just one node mentioned, it’s possible that your cluster hosts are not joined together.
			</p><p>
				Usually it’s best practice to have your cluster nodes on private network without firewall for communication among them. Firewall could be enabled just on public access point to your network instead. If for some reason you still need to have firewall enabled on cluster nodes, you will need to open some ports. Default values are UDP port 55200 and multicast port 45688 with multicast address 230.0.0.4. Note that you may need more ports opened if you want to enable additional features like diagnostics for your JGroups stack. Red Hat Single Sign-On delegates most of the clustering work to Infinispan/JGroups. For more information, see <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#cluster_communication_jgroups">JGroups</a> in the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
			</p></section></section><section class="chapter" id="server_cache_configuration"><div class="titlepage"><div><div><h1 class="title">Chapter 9. Server Cache Configuration</h1></div></div></div><p>
			Red Hat Single Sign-On has two types of caches. One type of cache sits in front of the database to decrease load on the DB and to increase overall response times by keeping data in memory. Realm, client, role, and user metadata is kept in this type of cache. This cache is a local cache. Local caches do not use replication even if you are in the cluster with more Red Hat Single Sign-On servers. Instead, they only keep copies locally and if the entry is updated an invalidation message is sent to the rest of the cluster and the entry is evicted. There is separate replicated cache <code class="literal">work</code>, which task is to send the invalidation messages to the whole cluster about what entries should be evicted from local caches. This greatly reduces network traffic, makes things efficient, and avoids transmitting sensitive metadata over the wire.
		</p><p>
			The second type of cache handles managing user sessions, offline tokens, and keeping track of login failures so that the server can detect password phishing and other attacks. The data held in these caches is temporary, in memory only, but is possibly replicated across the cluster.
		</p><p>
			This chapter discusses some configuration options for these caches for both clustered a non-clustered deployments.
		</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
				More advanced configuration of these caches can be found in the <a class="link" href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html-single/configuration_guide/#infinispan">Infinispan</a> section of the <span class="emphasis"><em>JBoss EAP Configuration Guide</em></span>.
			</p></div></div><section class="section" id="eviction_and_expiration"><div class="titlepage"><div><div><h2 class="title">9.1. Eviction and Expiration</h2></div></div></div><p>
				There are multiple different caches configured for Red Hat Single Sign-On. There is a realm cache that holds information about secured applications, general security data, and configuration options. There is also a user cache that contains user metadata. Both caches default to a maximum of 10000 entries and use a least recently used eviction strategy. Each of them is also tied to an object revisions cache that controls eviction in a clustered setup. This cache is created implicitely and has twice the configured size. There are also separate caches for user sessions, offline tokens, and login failures. These caches are unbounded in size as well.
			</p><p>
				The eviction policy and max entries for these caches can be configured in the <span class="emphasis"><em>standalone.xml</em></span>, <span class="emphasis"><em>standalone-ha.xml</em></span>, or <span class="emphasis"><em>domain.xml</em></span> depending on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>.
			</p><div class="formalpara"><p class="title"><strong>non-clustered</strong></p><p>
					
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:infinispan:4.0"&gt;
    &lt;cache-container name="keycloak" jndi-name="infinispan/Keycloak"&gt;
        &lt;local-cache name="realms"&gt;
            &lt;eviction max-entries="10000" strategy="LRU"/&gt;
        &lt;/local-cache&gt;
        &lt;local-cache name="users"&gt;
            &lt;eviction max-entries="10000" strategy="LRU"/&gt;
        &lt;/local-cache&gt;
        &lt;local-cache name="sessions"/&gt;
        &lt;local-cache name="offlineSessions"/&gt;
        &lt;local-cache name="loginFailures"/&gt;
        &lt;local-cache name="work"/&gt;
        &lt;local-cache name="authorization"&gt;
           &lt;eviction strategy="LRU" max-entries="100"/&gt;
        &lt;/local-cache&gt;
        &lt;local-cache name="keys"&gt;
            &lt;eviction strategy="LRU" max-entries="1000"/&gt;
            &lt;expiration max-idle="3600000"/&gt;
        &lt;/local-cache&gt;
    &lt;/cache-container&gt;</pre>
				</p></div><div class="formalpara"><p class="title"><strong>clustered</strong></p><p>
					
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:infinispan:4.0"&gt;
    &lt;cache-container name="keycloak" jndi-name="infinispan/Keycloak"&gt;
        &lt;transport lock-timeout="60000"/&gt;
        &lt;local-cache name="realms"&gt;
            &lt;eviction max-entries="10000" strategy="LRU"/&gt;
        &lt;/local-cache&gt;
        &lt;local-cache name="users"&gt;
            &lt;eviction max-entries="10000" strategy="LRU"/&gt;
        &lt;/local-cache&gt;
        &lt;distributed-cache name="sessions" mode="SYNC" owners="1"/&gt;
        &lt;distributed-cache name="offlineSessions" mode="SYNC" owners="1"/&gt;
        &lt;distributed-cache name="loginFailures" mode="SYNC" owners="1"/&gt;
        &lt;distributed-cache name="authorization" mode="SYNC" owners="1"/&gt;
        &lt;replicated-cache name="work" mode="SYNC"/&gt;
        &lt;local-cache name="keys"&gt;
            &lt;eviction max-entries="1000" strategy="LRU"/&gt;
            &lt;expiration max-idle="3600000"/&gt;
        &lt;/local-cache&gt;
    &lt;/cache-container&gt;</pre>
				</p></div><p>
				To limit or expand the number of allowed entries simply add or edit the <code class="literal">eviction</code> element or the <code class="literal">expiration</code> element of particular cache configuration.
			</p></section><section class="section" id="replication_and_failover"><div class="titlepage"><div><div><h2 class="title">9.2. Replication and Failover</h2></div></div></div><p>
				The <code class="literal">sessions</code>, <code class="literal">authenticationSessions</code>, <code class="literal">offlineSessions</code> and <code class="literal">loginFailures</code> caches are the only caches that may perform replication. Entries are not replicated to every single node, but instead one or more nodes is chosen as an owner of that data. If a node is not the owner of a specific cache entry it queries the cluster to obtain it. What this means for failover is that if all the nodes that own a piece of data go down, that data is lost forever. By default, Red Hat Single Sign-On only specifies one owner for data. So if that one node goes down that data is lost. This usually means that users will be logged out and will have to login again.
			</p><p>
				You can change the number of nodes that replicate a piece of data by change the <code class="literal">owners</code> attribute in the <code class="literal">distributed-cache</code> declaration.
			</p><div class="formalpara"><p class="title"><strong>owners</strong></p><p>
					
<pre class="programlisting language-xml">&lt;subsystem xmlns="urn:jboss:domain:infinispan:4.0"&gt;
   &lt;cache-container name="keycloak" jndi-name="infinispan/Keycloak"&gt;
       &lt;distributed-cache name="sessions" mode="SYNC" owners="2"/&gt;
...</pre>
				</p></div><p>
				Here we’ve changed it so at least two nodes will replicate one specific user login session.
			</p><div class="admonition tip"><div class="admonition_header">Tip</div><div><p>
				The number of owners recommended is really dependent on your deployment. If you do not care if users are logged out when a node goes down, then one owner is good enough and you will avoid replication.
			</p></div></div></section><section class="section" id="disabling_caching"><div class="titlepage"><div><div><h2 class="title">9.3. Disabling Caching</h2></div></div></div><p>
				To disable the realm or user cache, you must edit the <code class="literal">standalone.xml</code>, <code class="literal">standalone-ha.xml</code>, or <code class="literal">domain.xml</code> file in your distribution. The location of this file depends on your <a class="link" href="#operating-mode" title="Chapter 3. Choosing an Operating Mode">operating mode</a>. Here’s what the config looks like initially.
			</p><pre class="programlisting language-xml">    &lt;spi name="userCache"&gt;
        &lt;provider name="default" enabled="true"/&gt;
    &lt;/spi&gt;

    &lt;spi name="realmCache"&gt;
        &lt;provider name="default" enabled="true"/&gt;
    &lt;/spi&gt;</pre><p>
				To disable the cache set the <code class="literal">enabled</code> attribute to false for the cache you want to disable. You must reboot your server for this change to take effect.
			</p></section><section class="section" id="clearing_caches_at_runtime"><div class="titlepage"><div><div><h2 class="title">9.4. Clearing Caches at Runtime</h2></div></div></div><p>
				To clear the realm or user cache, go to the Red Hat Single Sign-On admin console Realm Settings→Cache Config page. On this page you can clear the realm cache, the user cache or cache of external public keys.
			</p><div class="admonition note"><div class="admonition_header">Note</div><div><p>
					The cache will be cleared for all realms!
				</p></div></div></section></section><div><div xml:lang="en-US" class="legalnotice" id="idm139625632185056"><h1 class="legalnotice">Legal Notice</h1><div class="para">
				Copyright <span class="trademark"/>© 2016 Red Hat, Inc.
			</div><div class="para">
				Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at
			</div><div class="para">
				<a class="ulink" href="http://www.apache.org/licenses/LICENSE-2.0"> http://www.apache.org/licenses/LICENSE-2.0</a>
			</div><div class="para">
				Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
			</div></div></div></div></div></div><script type="text/javascript">
                        jQuery(document).ready(function() {
                            initSwitchery();
                            jQuery('pre[class*="language-"]').each(function(i, block){hljs.highlightBlock(block);});
                        });
                    </script></body></html>