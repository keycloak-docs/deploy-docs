<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5">
<title>Guide Overview</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
*:not(pre)>code.nobreak{word-wrap:normal}
*:not(pre)>code.nowrap{white-space:nowrap}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
/*pre.CodeRay {background-color:#f7f7f8;}*/
.CodeRay .line-numbers{border-right:1px solid #d8d8d8;padding:0 0.5em 0 .25em}
.CodeRay span.line-numbers{display:inline-block;margin-right:.5em;color:rgba(0,0,0,.3)}
.CodeRay .line-numbers strong{color:rgba(0,0,0,.4)}
table.CodeRay{border-collapse:separate;border-spacing:0;margin-bottom:0;border:0;background:none}
table.CodeRay td{vertical-align: top;line-height:1.45}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.line-numbers>pre{padding:0;color:rgba(0,0,0,.3)}
table.CodeRay td.code{padding:0 0 0 .5em}
table.CodeRay td.code>pre{padding:0}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
<style>
/* Global Navbar */

ul#globalnav {
    background-color: #ededed;

    list-style: none;
    width: 100%;
    margin: 0;
    padding: 0;

    overflow: hidden;
    position: fixed;
    left: 0px;
    top: 0px;
    font-size: 0.6em;
    height: 30px;
}

ul#globalnav::after {
    content: "";
    display: block;
    clear: both;
}

ul#globalnav li {
    float: left;
}

ul#globalnav li a {
    display: inline-block;
    color: #004670;
    text-align: center;
    padding: 0.75em;
    text-decoration: none;
}

ul#globalnav li a:hover {
    color: #428bca;
}

#toc.toc2 {
    top: 30px;
    bottom: 0px;
    height: unset;
}

body.toc2 {
    padding-top: 30px;
}

@media only screen and (min-width:768px) {
    ul#globalnav {
        font-size: 0.75em;
        height: 40px;
    }

    #toc.toc2 {
        top: 40px;
    }

    body.toc2 {
        padding-top: 40px;
    }
}

@media only screen and (min-width:1280px) {
    ul#globalnav {
        font-size: 1em;
        height: 48px;
    }

    #toc.toc2 {
        top: 48px;
    }

    body.toc2 {
        padding-top: 48px;
    }
}

</style>

<style>
/* General Changes */

h1, h2, h3, #toctitle, .sidebarblock>.content>.title, h4, h5, h6 {
    color: #444444;
    font-weight: 500;
}

a {
    color: #004670;
    text-decoration: none;
}

a:hover {
    color: #7da1dc;
}

body {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    color: #444444;
}

.subheader, .admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    color: #444444;
}

.admonitionblock td.content>.title, .audioblock>.title, .exampleblock>.title, .imageblock>.title, .listingblock>.title, .literalblock>.title, .stemblock>.title, .openblock>.title, .paragraph>.title, .quoteblock>.title, table.tableblock>.title, .verseblock>.title, .videoblock>.title, .dlist>.title, .olist>.title, .ulist>.title, .qlist>.title, .hdlist>.title {
    font-family: "Open Sans","DejaVu Sans",sans-serif;
    font-style: normal;
}

span.image img {
    border:1px solid #ccc;
    -webkit-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    -moz-box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
    box-shadow: 3px 3px 15px 0px rgba(0,0,0,0.5);
}

</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#guide-overview">1. Guide Overview</a>
<ul class="sectlevel2">
<li><a href="#recommended-additional-external-documentation">1.1. Recommended Additional External Documentation</a></li>
</ul>
</li>
<li><a href="#installation">2. Installation</a>
<ul class="sectlevel2">
<li><a href="#system-requirements">2.1. System Requirements</a></li>
<li><a href="#installing-distribution-files">2.2. Installing Distribution Files</a></li>
<li><a href="#distribution-directory-structure">2.3. Distribution Directory Structure</a></li>
</ul>
</li>
<li><a href="#_operating-mode">3. Choosing an Operating Mode</a>
<ul class="sectlevel2">
<li><a href="#_standalone-mode">3.1. Standalone Mode</a>
<ul class="sectlevel3">
<li><a href="#standalone-boot-script">3.1.1. Standalone Boot Script</a></li>
<li><a href="#standalone-configuration">3.1.2. Standalone Configuration</a></li>
</ul>
</li>
<li><a href="#_standalone-ha-mode">3.2. Standalone Clustered Mode</a>
<ul class="sectlevel3">
<li><a href="#standalone-clustered-configuration">3.2.1. Standalone Clustered Configuration</a></li>
<li><a href="#standalone-clustered-boot-script">3.2.2. Standalone Clustered Boot Script</a></li>
</ul>
</li>
<li><a href="#_domain-mode">3.3. Domain Clustered Mode</a>
<ul class="sectlevel3">
<li><a href="#domain-configuration">3.3.1. Domain Configuration</a></li>
<li><a href="#host-controller-configuration">3.3.2. Host Controller Configuration</a></li>
<li><a href="#server-instance-working-directories">3.3.3. Server Instance Working Directories</a></li>
<li><a href="#domain-boot-script">3.3.4. Domain Boot Script</a></li>
<li><a href="#_clustered-domain-example">3.3.5. Clustered Domain Example</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_manage_config">4. Manage Subsystem Configuration</a>
<ul class="sectlevel2">
<li><a href="#_config_spi_providers">4.1. Configure SPI Providers</a></li>
<li><a href="#_start_cli">4.2. Start the WildFly CLI</a></li>
<li><a href="#cli-embedded-mode">4.3. CLI Embedded Mode</a></li>
<li><a href="#cli-gui-mode">4.4. CLI GUI Mode</a></li>
<li><a href="#cli-scripting">4.5. CLI Scripting</a></li>
<li><a href="#_cli_recipes">4.6. CLI Recipes</a>
<ul class="sectlevel3">
<li><a href="#change-the-web-context-of-the-server">4.6.1. Change the web context of the server</a></li>
<li><a href="#set-the-global-default-theme">4.6.2. Set the global default theme</a></li>
<li><a href="#add-a-new-spi-and-a-provider">4.6.3. Add a new SPI and a provider</a></li>
<li><a href="#disable-a-provider">4.6.4. Disable a provider</a></li>
<li><a href="#change-the-default-provider-for-an-spi">4.6.5. Change the default provider for an SPI</a></li>
<li><a href="#configure-the-dblock-spi">4.6.6. Configure the dblock SPI</a></li>
<li><a href="#add-or-change-a-single-property-value-for-a-provider">4.6.7. Add or change a single property value for a provider</a></li>
<li><a href="#remove-a-single-property-from-a-provider">4.6.8. Remove a single property from a provider</a></li>
<li><a href="#set-values-on-a-provider-property-of-type-code-list-code">4.6.9. Set values on a provider property of type <code>List</code></a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_profiles">5. Profiles</a></li>
<li><a href="#_database">6. Relational Database Setup</a>
<ul class="sectlevel2">
<li><a href="#_rdbms-setup-checklist">6.1. RDBMS Setup Checklist</a></li>
<li><a href="#package-the-jdbc-driver">6.2. Package the JDBC Driver</a></li>
<li><a href="#declare-and-load-jdbc-driver">6.3. Declare and Load JDBC Driver</a></li>
<li><a href="#modify-the-keycloak-datasource">6.4. Modify the Keycloak Datasource</a></li>
<li><a href="#database-configuration">6.5. Database Configuration</a></li>
<li><a href="#unicode-considerations-for-databases">6.6. Unicode Considerations for Databases</a>
<ul class="sectlevel3">
<li><a href="#oracle-database">6.6.1. Oracle Database</a></li>
<li><a href="#microsoft-sql-server-database">6.6.2. Microsoft SQL Server Database</a></li>
<li><a href="#ibm-db2-database">6.6.3. IBM DB2 Database</a></li>
<li><a href="#mysql-database">6.6.4. MySQL Database</a></li>
<li><a href="#postgresql-database">6.6.5. PostgreSQL Database</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_network">7. Network Setup</a>
<ul class="sectlevel2">
<li><a href="#_bind-address">7.1. Bind Addresses</a></li>
<li><a href="#_ports">7.2. Socket Port Bindings</a></li>
<li><a href="#setting-up-https-ssl">7.3. Setting up HTTPS/SSL</a>
<ul class="sectlevel3">
<li><a href="#enabling-ssl-https-for-the-keycloak-server">7.3.1. Enabling SSL/HTTPS for the Keycloak Server</a></li>
</ul>
</li>
<li><a href="#outgoing-http-requests">7.4. Outgoing HTTP Requests</a>
<ul class="sectlevel3">
<li><a href="#_truststore">7.4.1. Outgoing HTTPS Request Truststore</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_clustering">8. Clustering</a>
<ul class="sectlevel2">
<li><a href="#recommended-network-architecture">8.1. Recommended Network Architecture</a></li>
<li><a href="#clustering-example">8.2. Clustering Example</a></li>
<li><a href="#_setting-up-a-load-balancer-or-proxy">8.3. Setting Up a Load Balancer or Proxy</a>
<ul class="sectlevel3">
<li><a href="#identifying-client-ip-addresses">8.3.1. Identifying Client IP Addresses</a></li>
<li><a href="#enable-https-ssl-with-a-reverse-proxy">8.3.2. Enable HTTPS/SSL with a Reverse Proxy</a></li>
<li><a href="#verify-configuration">8.3.3. Verify Configuration</a></li>
<li><a href="#using-the-built-in-load-balancer">8.3.4. Using the Built-In Load Balancer</a></li>
<li><a href="#configuring-other-load-balancers">8.3.5. Configuring Other Load Balancers</a></li>
</ul>
</li>
<li><a href="#sticky-sessions">8.4. Sticky sessions</a>
<ul class="sectlevel3">
<li><a href="#example-cluster-setup-with-mod_cluster">8.4.1. Example cluster setup with mod_cluster</a></li>
</ul>
</li>
<li><a href="#multicast-network-setup">8.5. Multicast Network Setup</a></li>
<li><a href="#securing-cluster-communication">8.6. Securing Cluster Communication</a></li>
<li><a href="#_clustering_db_lock">8.7. Serialized Cluster Startup</a></li>
<li><a href="#booting-the-cluster">8.8. Booting the Cluster</a></li>
<li><a href="#troubleshooting">8.9. Troubleshooting</a></li>
</ul>
</li>
<li><a href="#server-cache-configuration">9. Server Cache Configuration</a>
<ul class="sectlevel2">
<li><a href="#eviction-and-expiration">9.1. Eviction and Expiration</a></li>
<li><a href="#replication-and-failover">9.2. Replication and Failover</a></li>
<li><a href="#disabling-caching">9.3. Disabling Caching</a></li>
<li><a href="#clearing-caches-at-runtime">9.4. Clearing Caches at Runtime</a></li>
</ul>
</li>
<li><a href="#_proxy">10. Keycloak Security Proxy</a>
<ul class="sectlevel2">
<li><a href="#proxy-install-and-run">10.1. Proxy Install and Run</a></li>
<li><a href="#proxy-configuration">10.2. Proxy Configuration</a>
<ul class="sectlevel3">
<li><a href="#basic-config">10.2.1. Basic Config</a></li>
</ul>
</li>
<li><a href="#application-config">10.3. Application Config</a>
<ul class="sectlevel3">
<li><a href="#constraint-config">10.3.1. Constraint Config</a></li>
<li><a href="#header-names-config">10.3.2. Header Names Config</a></li>
</ul>
</li>
<li><a href="#keycloak-identity-headers">10.4. Keycloak Identity Headers</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="guide-overview"><a class="anchor" href="#guide-overview"></a>1. Guide Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The purpose of this guide is to walk through the steps that need to be completed prior to booting up the
Keycloak server for the first time.  If you just want to test drive Keycloak, it pretty much runs out of the box with its
own embedded and local-only database.  For
 actual deployments that are going to be run in production you&#8217;ll need to decide how you want to manage server configuration
 at runtime (standalone or domain mode), configure a shared database for Keycloak storage, set up encryption and HTTPS,
 and finally set up Keycloak to run in a cluster.  This guide walks through each and every aspect of any pre-boot
 decisions and setup you must do prior to deploying the server.</p>
</div>
<div class="paragraph">
<p>One thing to particularly note is that Keycloak is derived from the WildFly Application Server.
Many aspects of configuring Keycloak revolve around WildFly configuration elements.  Often
this guide will direct you to documentation outside of the manual if you want to dive into more detail.</p>
</div>
<div class="sect2">
<h3 id="recommended-additional-external-documentation"><a class="anchor" href="#recommended-additional-external-documentation"></a>1.1. Recommended Additional External Documentation</h3>
<div class="paragraph">
<p>Keycloak is built on top of the WildFly application server and it&#8217;s sub-projects like Infinispan (for caching) and Hibernate (for persistence).
This guide only covers basics for infrastructure-level configuration.  It is highly recommended that you peruse the documentation
for WildFly and its sub projects. Here is the link to the documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="installation"><a class="anchor" href="#installation"></a>2. Installation</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Installing Keycloak is as simple as downloading it and unzipping it. This chapter reviews system requirements
as well as the directory structure of the distribution.</p>
</div>
<div class="sect2">
<h3 id="system-requirements"><a class="anchor" href="#system-requirements"></a>2.1. System Requirements</h3>
<div class="paragraph">
<p>These are the requirements to run the Keycloak authentication server:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Can run on any operating system that runs Java</p>
</li>
<li>
<p>Java 8 JDK</p>
</li>
<li>
<p>zip or gzip and tar</p>
</li>
<li>
<p>At least 512M of RAM</p>
</li>
<li>
<p>At least 1G of diskspace</p>
</li>
<li>
<p>A shared external database like Postgres, MySql, Oracle, etc.  Keycloak requires an external shared
database if you want to run in a cluster.   Please see the <a href="#_database">database configuration</a> section of this guide for more information.</p>
</li>
<li>
<p>Network multicast support on your machine if you want to run in a cluster.  Keycloak can
be clustered without multicast, but this requires a bunch of configuration changes.  Please see
the <a href="#_clustering">clustering</a> section of this guide for more information.</p>
</li>
<li>
<p>On Linux, it is recommended to use <code>/dev/urandom</code> as a source of random data to prevent Keycloak hanging due to lack of available
entropy, unless <code>/dev/random</code> usage is mandated by your security policy. To achieve that on Oracle JDK 8 and OpenJDK 8, set the <code>java.security.egd</code>
system property on startup to <code>file:/dev/urandom</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="installing-distribution-files"><a class="anchor" href="#installing-distribution-files"></a>2.2. Installing Distribution Files</h3>
<div class="paragraph">
<p>The Keycloak Server has three downloadable distributions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>'keycloak-3.4.0.CR1.[zip|tar.gz]'</p>
</li>
<li>
<p>'keycloak-overlay-3.4.0.CR1.[zip|tar.gz]'</p>
</li>
<li>
<p>'keycloak-demo-3.4.0.CR1.[zip|tar.gz]'</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The 'keycloak-3.4.0.CR1.[zip|tar.gz]' file is the server only distribution.  It contains nothing other than the scripts and binaries
to run the Keycloak Server.  To unpack this file just run your operating system&#8217;s <code>unzip</code> or <code>gunzip</code> and <code>tar</code> utilities.</p>
</div>
<div class="paragraph">
<p>The 'keycloak-overlay-3.4.0.CR1.[zip|tar.gz]' file is a Wildfly add-on that allows you to install Keycloak Server on top of an existing
WildFly distribution.  We do not support users that want to run their applications and Keycloak on the same server instance.  To install the Keycloak Service Pack, just unzip it in the root directory
of your WildFly distribution, open the bin directory in a shell and run <code>./jboss-cli.[sh|bat] --file=keycloak-install.cli</code>.</p>
</div>
<div class="paragraph">
<p>The 'keycloak-demo-3.4.0.CR1.[zip|tar.gz]' contains the server binaries, all documentation and all examples.  It is preconfigured with both the
OIDC and SAML client application adapters and can deploy any of the distribution examples out of the box with no configuration.  This distribution is only
recommended for those that want to test drive Keycloak.  We do not support users that run the demo distribution in production.</p>
</div>
<div class="paragraph">
<p>To unpack of these files run the <code>unzip</code> or <code>gunzip</code> and <code>tar</code> utilities.</p>
</div>
</div>
<div class="sect2">
<h3 id="distribution-directory-structure"><a class="anchor" href="#distribution-directory-structure"></a>2.3. Distribution Directory Structure</h3>
<div class="paragraph">
<p>This chapter walks you through the directory structure of the server distribution.</p>
</div>
<div class="paragraph">
<div class="title">distribution directory structure</div>
<p><span class="image"><img src="./keycloak-images/files.png" alt="distribution"></span></p>
</div>
<div class="paragraph">
<p>Let&#8217;s examine the purpose of some of the directories:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><em>bin/</em></dt>
<dd>
<p>This contains various scripts to either boot the server or perform some other management action on the server.</p>
</dd>
<dt class="hdlist1"><em>domain/</em></dt>
<dd>
<p>This contains configuration files and working directory when running Keycloak in <a href="#_domain-mode">domain mode</a>.</p>
</dd>
<dt class="hdlist1"><em>modules/</em></dt>
<dd>
<p>These are all the Java libraries used by the server.</p>
</dd>
<dt class="hdlist1"><em>providers/</em></dt>
<dd>
<p>If you are writing extensions to keycloak, you can put your extensions here.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more information on this.</p>
</dd>
<dt class="hdlist1"><em>standalone/</em></dt>
<dd>
<p>This contains configuration files and working directory when running Keycloak in <a href="#_standalone-mode">standalone mode</a>.</p>
</dd>
<dt class="hdlist1"><em>themes/</em></dt>
<dd>
<p>This directory contains all the html, style sheets, javascript files, and images used to display any UI screen displayed by the server.
Here you can modify an existing theme or create your own.  See the <a href="http://www.keycloak.org/docs/3.4/server_development/">Server Developer Guide</a> for more information on this.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_operating-mode"><a class="anchor" href="#_operating-mode"></a>3. Choosing an Operating Mode</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before deploying Keycloak in a production environment you need to decide which type of operating mode
you are going to use.  Will you run Keycloak within a cluster?  Do you want a centralized way to manage
your server configurations?  Your choice of operating mode effects how you configure databases, configure caching and even how you boot the server.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The Keycloak is built on top of the WildFly Application Server.  This guide will only
     go over the basics for deployment within a specific mode.  If you want specific information on this, a better place
     to go would be the <a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_standalone-mode"><a class="anchor" href="#_standalone-mode"></a>3.1. Standalone Mode</h3>
<div class="paragraph">
<p>Standalone operating mode is only useful when you want to run one, and only one Keycloak server instance.
It is not usable for clustered deployments and all caches are non-distributed and local-only.  It is not recommended that
you use standalone mode in production as you will have a single point of failure.  If your standalone mode server goes down,
users will not be able to log in.  This mode is really only useful to test drive and play with the features of Keycloak</p>
</div>
<div class="sect3">
<h4 id="standalone-boot-script"><a class="anchor" href="#standalone-boot-script"></a>3.1.1. Standalone Boot Script</h4>
<div class="paragraph">
<p>When running the server in standalone mode, there is a specific script you need to run to boot the server depending on your
operating system.  These scripts live in the <em>bin/</em> directory of the server distribution.</p>
</div>
<div class="paragraph">
<div class="title">Standalone Boot Scripts</div>
<p><span class="image"><img src="./keycloak-images/standalone-boot-files.png" alt="standalone boot files"></span></p>
</div>
<div class="paragraph">
<p>To boot the server:</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/standalone.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\standalone.bat</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="standalone-configuration"><a class="anchor" href="#standalone-configuration"></a>3.1.2. Standalone Configuration</h4>
<div class="paragraph">
<p>The bulk of this guide walks you through how to configure infrastructure level aspects of Keycloak.  These
aspects are configured in a configuration file that is specific to the application server that Keycloak is a
derivative of.  In the standalone operation mode, this file lives in <em>&#8230;&#8203;/standalone/configuration/standalone.xml</em>.  This file
is also used to configure non-infrastructure level things that are specific to Keycloak components.</p>
</div>
<div class="paragraph">
<div class="title">Standalone Config File</div>
<p><span class="image"><img src="./keycloak-images/standalone-config-file.png" alt="standalone config file"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any changes you make to this file while the server is running will not take effect and may even be overwritten
      by the server.  Instead use the the command line scripting or the web console of WildFly.  See
      the <a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a> for more information.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_standalone-ha-mode"><a class="anchor" href="#_standalone-ha-mode"></a>3.2. Standalone Clustered Mode</h3>
<div class="paragraph">
<p>Standalone clustered operation mode is for when you want to run Keycloak within a cluster.  This mode
requires that you have a copy of the Keycloak distribution on each machine you want to run a server instance.
This mode can be very easy to deploy initially, but can become quite cumbersome. To make a configuration change
you&#8217;ll have to modify each distribution on each machine.  For a large cluster this can become time consuming and error prone.</p>
</div>
<div class="sect3">
<h4 id="standalone-clustered-configuration"><a class="anchor" href="#standalone-clustered-configuration"></a>3.2.1. Standalone Clustered Configuration</h4>
<div class="paragraph">
<p>The distribution has a mostly pre-configured app server configuration file for running within a cluster.  It has all the specific
infrastructure settings for networking, databases, caches, and discovery.  This file resides
in <em>&#8230;&#8203;/standalone/configuration/standalone-ha.xml</em>.  There&#8217;s a few things missing from this configuration.
You can&#8217;t run Keycloak in a cluster without a configuring a shared database connection.  You also need to
deploy some type of load balancer in front of the cluster.  The <a href="#_clustering">clustering</a> and
<a href="#_database">database</a> sections of this guide walk you though these things.</p>
</div>
<div class="paragraph">
<div class="title">Standalone HA Config</div>
<p><span class="image"><img src="./keycloak-images/standalone-ha-config-file.png" alt="standalone ha config file"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any changes you make to this file while the server is running will not take effect and may even be overwritten
      by the server.  Instead use the the command line scripting or the web console of WildFly.  See
      the <a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a> for more information.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="standalone-clustered-boot-script"><a class="anchor" href="#standalone-clustered-boot-script"></a>3.2.2. Standalone Clustered Boot Script</h4>
<div class="paragraph">
<p>You use the same boot scripts to start Keycloak as you do in standalone mode.  The difference is that
you pass in an additional flag to point to the HA config file.</p>
</div>
<div class="paragraph">
<div class="title">Standalone Clustered Boot Scripts</div>
<p><span class="image"><img src="./keycloak-images/standalone-boot-files.png" alt="standalone boot files"></span></p>
</div>
<div class="paragraph">
<p>To boot the server:</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/standalone.sh --server-config=standalone-ha.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\standalone.bat --server-config=standalone-ha.xml</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_domain-mode"><a class="anchor" href="#_domain-mode"></a>3.3. Domain Clustered Mode</h3>
<div class="paragraph">
<p>Domain mode is a way to centrally manage and publish the configuration for your servers.</p>
</div>
<div class="paragraph">
<p>Running a cluster in standard mode can quickly become aggravating as the cluster grows in size.  Every time you need
to make a configuration change, you have perform it on each node in the cluster.  Domain mode solves this problem by providing
a central place to store and publish configuration.  It can be quite complex to set up, but it is worth it in the end.
This capability is built into the WildFly Application Server which Keycloak derives from.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The guide will go over the very basics of domain mode.  Detailed steps on how to set up domain mode in a cluster should be obtained from the
       <a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here are some of the basic concepts of running in domain mode.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">domain controller</dt>
<dd>
<p>The domain controller is a process that is responsible for storing, managing, and publishing the general configuration
for each node in the cluster.  This process is the central point from which nodes in a cluster obtain their configuration.</p>
</dd>
<dt class="hdlist1">host controller</dt>
<dd>
<p>The host controller is responsible for managing server instances on a specific machine.  You configure it to run
one or more server instances.  The domain controller can also interact with the host controllers on each machine to
manage the cluster.  To reduce the number of running process, a domain controller also acts as a host controller on
the machine it runs on.</p>
</dd>
<dt class="hdlist1">domain profile</dt>
<dd>
<p>A domain profile is a named set of configuration that can be used by a server to boot from.  A domain controller
can define multiple domain profiles that are consumed by different servers.</p>
</dd>
<dt class="hdlist1">server group</dt>
<dd>
<p>A server group is a collection of servers.  They are managed and configured as one.  You can assign a domain profile to a server group and every service in that
group will use that domain profile as their configuration.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>In domain mode, a domain controller is started on a master node.  The configuration for the cluster resides in the domain controller.
Next a host controller is started on each machine in the cluster.  Each host controller deployment configuration specifies how
many Keycloak server instances will be started on that machine.  When the host controller boots up, it starts
as many Keycloak server instances as it was configured to do.  These server instances pull their configuration
from the domain controller.</p>
</div>
<div class="sect3">
<h4 id="domain-configuration"><a class="anchor" href="#domain-configuration"></a>3.3.1. Domain Configuration</h4>
<div class="paragraph">
<p>Various other chapters in this guide walk you through configuring various aspects like databases,
HTTP network connections, caches, and other infrastructure related things.  While standalone mode uses the <em>standalone.xml</em> file to configure these things,
domain mode uses the <em>&#8230;&#8203;/domain/configuration/domain.xml</em> configuration file.  This is
where the domain profile and server group for the Keycloak server are defined.</p>
</div>
<div class="paragraph">
<div class="title">domain.xml</div>
<p><span class="image"><img src="./keycloak-images/domain-file.png" alt="domain file"></span></p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Any changes you make to this file while the domain controller is running will not take effect and may even be overwritten
      by the server.  Instead use the the command line scripting or the web console of WildFly.  See
      the <a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a> for more information.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s look at some aspects of this <em>domain.xml</em> file.  The <code>auth-server-standalone</code> and <code>auth-server-clustered</code> <code>profile</code> XML blocks are where you are going to make the bulk of your configuration decisions.
You&#8217;ll be configuring things here like network connections, caches, and database connections.</p>
</div>
<div class="listingblock">
<div class="title">auth-server profile</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;profiles&gt;</span>
        <span class="tag">&lt;profile</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-standalone</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
         <span class="tag">&lt;/profile&gt;</span>
       <span class="tag">&lt;profile</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/profile&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>auth-server-standalone</code> profile is a non-clustered setup.  The <code>auth-server-clustered</code> profile is the clustered setup.</p>
</div>
<div class="paragraph">
<p>If you scroll down further, you&#8217;ll see various <code>socket-binding-groups</code> defined.</p>
</div>
<div class="listingblock">
<div class="title">socket-binding-groups</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;socket-binding-groups&gt;</span>
        <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/socket-binding-group&gt;</span>
        <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/socket-binding-group&gt;</span>
        <span class="comment">&lt;!-- load-balancer-sockets should be removed in production systems and replaced with a better softare or hardare based one --&gt;</span>
        <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           ...
        <span class="tag">&lt;/socket-binding-group&gt;</span>
    <span class="tag">&lt;/socket-binding-groups&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This config defines the default port mappings for various connectors that are opened with each
Keycloak server instance.  Any value that contains <code>${&#8230;&#8203;}</code> is a value that can be overriden on the command line
with the <code>-D</code> switch, i.e.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ domain.sh -Djboss.http.port=80</pre>
</div>
</div>
<div class="paragraph">
<p>The definition of the server group for Keycloak resides in the <code>server-groups</code> XML block.  It specifies the domain profile
that is used (<code>default</code>) and also some default boot arguments for the Java VM when the host controller boots an instance.  It also
binds a <code>socket-binding-group</code> to the server group.</p>
</div>
<div class="listingblock">
<div class="title">server group</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;server-groups&gt;</span>
        <span class="comment">&lt;!-- load-balancer-group should be removed in production systems and replaced with a better softare or hardare based one --&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;jvm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;heap</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">64m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512m</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/jvm&gt;</span>
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;jvm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;heap</span> <span class="attribute-name">size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">64m</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-size</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">512m</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/jvm&gt;</span>
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
    <span class="tag">&lt;/server-groups&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="host-controller-configuration"><a class="anchor" href="#host-controller-configuration"></a>3.3.2. Host Controller Configuration</h4>
<div class="paragraph">
<p>Keycloak comes with two host controller configuration files that reside in the <em>&#8230;&#8203;/domain/configuration/</em> directory:
<em>host-master.xml</em> and <em>host-slave.xml</em>.  <em>host-master.xml</em> is configured to boot up a domain controller, a load balancer, and
one Keycloak server instance.  <em>host-slave.xml</em> is configured to talk to the domain controller and boot up
one Keycloak server instance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The load balancer is not a required service.  It exists so that you can easily test drive clustering on your development
       machine.  While usable in production, you have the option of replacing it if you have a different hardware or software
       based load balancer you want to use.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<div class="title">Host Controller Config</div>
<p><span class="image"><img src="./keycloak-images/host-files.png" alt="host files"></span></p>
</div>
<div class="paragraph">
<p>To disable the load balancer server instance, edit <em>host-master.xml</em> and comment out or remove the <code>"load-balancer"</code> entry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;servers&gt;</span>
        <span class="comment">&lt;!-- remove or comment out next line --&gt;</span>
        <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loadbalancer-group</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        ...
    <span class="tag">&lt;/servers&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Another interesting thing to note about this file is the declaration of the authentication server instance.  It has
a <code>port-offset</code> setting.  Any network port defined in the <em>domain.xml</em> <code>socket-binding-group</code> or the server group
will have the value of <code>port-offset</code> added to it.  For this example domain setup we do this so that ports opened by
the load balancer server don&#8217;t conflict with the authentication server instance that is started.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;servers&gt;</span>
        ...
        <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">server-one</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">group</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">auto-start</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             <span class="tag">&lt;socket-bindings</span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">150</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server&gt;</span>
    <span class="tag">&lt;/servers&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="server-instance-working-directories"><a class="anchor" href="#server-instance-working-directories"></a>3.3.3. Server Instance Working Directories</h4>
<div class="paragraph">
<p>Each Keycloak server instance defined in your host files creates a working directory under <em>&#8230;&#8203;/domain/servers/{SERVER NAME}</em>.
Additional configuration can be put there, and any temporary, log, or data files the server instance needs or creates go there too.
The structure of these per server directories ends up looking like any other WildFly booted server.</p>
</div>
<div class="paragraph">
<div class="title">Working Directories</div>
<p><span class="image"><img src="./keycloak-images/domain-server-dir.png" alt="domain server dir"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="domain-boot-script"><a class="anchor" href="#domain-boot-script"></a>3.3.4. Domain Boot Script</h4>
<div class="paragraph">
<p>When running the server in domain mode, there is a specific script you need to run to boot the server depending on your
operating system.  These scripts live in the <em>bin/</em> directory of the server distribution.</p>
</div>
<div class="paragraph">
<div class="title">Domain Boot Script</div>
<p><span class="image"><img src="./keycloak-images/domain-boot-files.png" alt="domain boot files"></span></p>
</div>
<div class="paragraph">
<p>To boot the server:</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/domain.sh --host-config=host-master.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\domain.bat --host-config=host-slave.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>When running the boot script you will need pass in the host controlling configuration file you are going to use via the
<code>--host-config</code> switch.</p>
</div>
</div>
<div class="sect3">
<h4 id="_clustered-domain-example"><a class="anchor" href="#_clustered-domain-example"></a>3.3.5. Clustered Domain Example</h4>
<div class="paragraph">
<p>You can test drive clustering using the out-of-the-box <em>domain.xml</em> configuration.  This example
domain is meant to run on one machine and boots up:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a domain controller</p>
</li>
<li>
<p>an HTTP load balancer</p>
</li>
<li>
<p>2 Keycloak server instances</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To simulate running a cluster on two machines, you&#8217;ll run the <code>domain.sh</code> script twice to start two separate
host controllers.  The first will be the master host controller which will start a domain controller, an HTTP load balancer, and one
Keycloak authentication server instance.  The second will be a slave host controller that only starts
up an authentication server instance.</p>
</div>
<div class="sect4">
<h5 id="setup-slave-connection-to-domain-controller"><a class="anchor" href="#setup-slave-connection-to-domain-controller"></a>Setup Slave Connection to Domain Controller</h5>
<div class="paragraph">
<p>Before you can boot things up though, you have to configure the slave host controller so that it can talk securely to the domain
controller.  If you do not do this, then the slave host will not be able to obtain the centralized configuration from the domain controller.
To set up a secure connection, you have to create a server admin user and a secret that
will be shared between the master and the slave.  You do this by running the <code>&#8230;&#8203;/bin/add-user.sh</code> script.</p>
</div>
<div class="paragraph">
<p>When you run the script select <code>Management User</code> and answer <code>yes</code> when it asks you if the new user is going to be used
for one AS process to connect to another.  This will generate a secret that you&#8217;ll need to cut and paste into the
<em>&#8230;&#8203;/domain/configuration/host-slave.xml</em> file.</p>
</div>
<div class="listingblock">
<div class="title">Add App Server Admin</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ add-user.sh
 What type of user do you wish to add?
  a) Management User (mgmt-users.properties)
  b) Application User (application-users.properties)
 (a): a
 Enter the details of the new user to add.
 Using realm 'ManagementRealm' as discovered from the existing property files.
 Username : admin
 Password recommendations are listed below. To modify these restrictions edit the add-user.properties configuration file.
  - The password should not be one of the following restricted values {root, admin, administrator}
  - The password should contain at least 8 characters, 1 alphabetic character(s), 1 digit(s), 1 non-alphanumeric symbol(s)
  - The password should be different from the username
 Password :
 Re-enter Password :
 What groups do you want this user to belong to? (Please enter a comma separated list, or leave blank for none)[ ]:
 About to add user 'admin' for realm 'ManagementRealm'
 Is this correct yes/no? yes
 Added user 'admin' to file '/.../standalone/configuration/mgmt-users.properties'
 Added user 'admin' to file '/.../domain/configuration/mgmt-users.properties'
 Added user 'admin' with groups to file '/.../standalone/configuration/mgmt-groups.properties'
 Added user 'admin' with groups to file '/.../domain/configuration/mgmt-groups.properties'
 Is this new user going to be used for one AS process to connect to another AS process?
 e.g. for a slave host controller connecting to the master or for a Remoting connection for server to server EJB calls.
 yes/no? yes
 To represent the user add the following to the server-identities definition &lt;secret value="bWdtdDEyMyE=" /&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The add-user.sh does not add user to Keycloak server but to the underlying JBoss Enterprise Application Platform. The credentials used and generated in the above script are only for example purpose. Please use the ones generated on your system.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now cut and paste the secret value into the <em>&#8230;&#8203;/domain/configuration/host-slave.xml</em> file as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">     <span class="tag">&lt;management&gt;</span>
         <span class="tag">&lt;security-realms&gt;</span>
             <span class="tag">&lt;security-realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ManagementRealm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                 <span class="tag">&lt;server-identities&gt;</span>
                     <span class="tag">&lt;secret</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bWdtdDEyMyE=</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
                 <span class="tag">&lt;/server-identities&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="run-the-boot-scripts"><a class="anchor" href="#run-the-boot-scripts"></a>Run the Boot Scripts</h5>
<div class="paragraph">
<p>Since we&#8217;re simulating a two node cluster on one development machine, you&#8217;ll run the boot script twice:</p>
</div>
<div class="listingblock">
<div class="title">Boot up master</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ domain.sh --host-config=host-master.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Boot up slave</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="shell">$ domain.sh --host-config=host-slave.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>To try it out, open your browser and go to <a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_manage_config"><a class="anchor" href="#_manage_config"></a>4. Manage Subsystem Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Low-level configuration of Keycloak is done by editing the
 <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file
in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="paragraph">
<p>While there are endless settings you can configure here, this section will focus on
configuration of the <em>keycloak-server</em> subsystem.  No matter which configuration file
you are using, configuration of the <em>keycloak-server</em> subsystem is the same.</p>
</div>
<div class="paragraph">
<p>The keycloak-server subsystem is typically declared toward the end of the file like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;web-context&gt;</span>auth<span class="tag">&lt;/web-context&gt;</span>
   ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that anything changed in this subsystem will not take effect until the server is rebooted.</p>
</div>
<div class="sect2">
<h3 id="_config_spi_providers"><a class="anchor" href="#_config_spi_providers"></a>4.1. Configure SPI Providers</h3>
<div class="paragraph">
<p>The specifics of each configuration setting is discussed elsewhere in
context with that setting.  However, it is useful to understand the format used
to declare settings on SPI providers.</p>
</div>
<div class="paragraph">
<p>Keycloak is a highly modular system that allows great
flexibility.  There are more than 50 service provider interfaces (SPIs), and
you are allowed to swap out implementations of each SPI.  An implementation of
an SPI is known as a <em>provider</em>.</p>
</div>
<div class="paragraph">
<p>All elements in an SPI declaration are optional, but a full SPI declaration
 looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myspi</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;default-provider&gt;</span>myprovider<span class="tag">&lt;/default-provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myprovider</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">bar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mysecondprovider</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">foo</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have two providers defined for the SPI <code>myspi</code>.  The <code>default-provider</code>
is listed as <code>myprovider</code>.  However it is up to the SPI to decide how it will treat
this setting.  Some SPIs allow more than one provider and some do not.  So
<code>default-provider</code> can help the SPI to choose.</p>
</div>
<div class="paragraph">
<p>Also notice that each provider defines its own set of configuration properties.
The fact that both providers above have a property called <code>foo</code> is just a
coincidence.</p>
</div>
<div class="paragraph">
<p>The type of each property value is interpreted by the provider.  However, there
is one exception.  Consider the <code>jpa</code> provider for the <code>eventStore</code> API:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eventsStore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exclude-events</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">[</span><span class="entity">&amp;quot;</span><span class="content">EVENT1</span><span class="entity">&amp;quot;</span><span class="content">,</span>
                                                    <span class="entity">&amp;quot;</span><span class="content">EVENT2</span><span class="entity">&amp;quot;</span><span class="content">]</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We see that the value begins and ends with square brackets.  That means that
the value will be passed to the provider as a list.  In this example, the system will pass the
provider a list with two element values <em>EVENT1</em> and <em>EVENT2</em>. To add more values
to the list, just separate each list element with a comma. Unfortunately,
you do need to escape the quotes surrounding each list element with <code>&amp;quot;</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_start_cli"><a class="anchor" href="#_start_cli"></a>4.2. Start the WildFly CLI</h3>
<div class="paragraph">
<p>Besides editing the configuration by hand, you also have the option of changing
the configuration by issuing commands via the <em>jboss-cli</em> tool.  CLI allows
you to configure servers locally or remotely.  And it is especially useful when
combined with scripting.</p>
</div>
<div class="paragraph">
<p>To start the WildFly CLI, you need to run <code>jboss-cli</code>.</p>
</div>
<div class="listingblock">
<div class="title">Linux/Unix</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/jboss-cli.sh</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Windows</div>
<div class="content">
<pre class="CodeRay highlight"><code>&gt; ...\bin\jboss-cli.bat</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will bring you to a prompt like this:</p>
</div>
<div class="listingblock">
<div class="title">Prompt</div>
<div class="content">
<pre class="CodeRay highlight"><code>[disconnected /]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you wish to execute commands on a running server, you will first
execute the <code>connect</code> command.</p>
</div>
<div class="listingblock">
<div class="title">connect</div>
<div class="content">
<pre class="CodeRay highlight"><code>[disconnected /] connect
connect
[standalone@localhost:9990 /]</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be thinking to yourself, "I didn&#8217;t enter in any username or password!".  If you run <code>jboss-cli</code> on the same machine
as your running standalone server or domain controller and your account has appropriate file permissions, you do not have
to setup or enter in a admin username and password.  See the <a href="https://docs.jboss.org/author/display/WFLY10/Documentation"><em>WildFly 10 Documentation</em></a>
for more details on how to make things more secure if you are uncomfortable with that setup.</p>
</div>
</div>
<div class="sect2">
<h3 id="cli-embedded-mode"><a class="anchor" href="#cli-embedded-mode"></a>4.3. CLI Embedded Mode</h3>
<div class="paragraph">
<p>If you do happen to be on the same machine as your standalone server and you want to
issue commands while the server is not active, you can embed the server into CLI and make
changes in a special mode that disallows incoming requests.  To do this, first
execute the <code>embed</code> command with the config file you wish to change.</p>
</div>
<div class="listingblock">
<div class="title">embed</div>
<div class="content">
<pre class="CodeRay highlight"><code>[disconnected /] embed-server --server-config=standalone.xml
[standalone@embedded /]</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cli-gui-mode"><a class="anchor" href="#cli-gui-mode"></a>4.4. CLI GUI Mode</h3>
<div class="paragraph">
<p>The CLI can also run in GUI mode.  GUI mode launches a Swing application that
allows you to graphically view and edit the entire management model of a <em>running</em> server.
GUI mode is especially useful when you need help formatting your CLI commands and learning
about the options available.  The GUI can also retrieve server logs from a local or
remote server.</p>
</div>
<div class="listingblock">
<div class="title">Start in GUI mode</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/jboss-cli.sh --gui</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Note: to connect to a remote server, you pass the <code>--connect</code> option as well.
Use the --help option for more details.</em></p>
</div>
<div class="paragraph">
<p>After launching GUI mode, you will probably want to scroll down to find the node,
<code>subsystem=keycloak-server</code>.  If you right-click on the node and click
<code>Explore subsystem=keycloak-server</code>, you will get a new tab that shows only
the keycloak-server subsystem.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/cli-gui.png" alt="cli gui"></span></p>
</div>
</div>
<div class="sect2">
<h3 id="cli-scripting"><a class="anchor" href="#cli-scripting"></a>4.5. CLI Scripting</h3>
<div class="paragraph">
<p>The CLI has extensive scripting capabilities.  A script is just a text
file with CLI commands in it.  Consider a simple script that turns off theme
and template caching.</p>
</div>
<div class="listingblock">
<div class="title">turn-off-caching.cli</div>
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=keycloak-server/theme=defaults/:write-attribute(name=cacheThemes,value=false)
/subsystem=keycloak-server/theme=defaults/:write-attribute(name=cacheTemplates,value=false)</code></pre>
</div>
</div>
<div class="paragraph">
<p>To execute the script, I can follow the <code>Scripts</code> menu in CLI GUI, or execute the
script from the command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ .../bin/jboss-cli.sh --file=turn-off-caching.cli</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cli_recipes"><a class="anchor" href="#_cli_recipes"></a>4.6. CLI Recipes</h3>
<div class="paragraph">
<p>Here are some configuration tasks and how to perform them with CLI commands.
Note that in all but the first example, we use the wildcard path <code>**</code> to mean
you should substitute or the path to the keycloak-server subsystem.</p>
</div>
<div class="paragraph">
<p>For standalone, this just means:</p>
</div>
<div class="paragraph">
<p><code>**</code> = <code>/subsystem=keycloak-server</code></p>
</div>
<div class="paragraph">
<p>For domain mode, this would mean something like:</p>
</div>
<div class="paragraph">
<p><code>**</code> = <code>/profile=auth-server-clustered/subsystem=keycloak-server</code></p>
</div>
<div class="sect3">
<h4 id="change-the-web-context-of-the-server"><a class="anchor" href="#change-the-web-context-of-the-server"></a>4.6.1. Change the web context of the server</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>/subsystem=keycloak-server/:write-attribute(name=web-context,value=myContext)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="set-the-global-default-theme"><a class="anchor" href="#set-the-global-default-theme"></a>4.6.2. Set the global default theme</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/theme=defaults/:write-attribute(name=default,value=myTheme)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-a-new-spi-and-a-provider"><a class="anchor" href="#add-a-new-spi-and-a-provider"></a>4.6.3. Add a new SPI and a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=mySPI/:add
**/spi=mySPI/provider=myProvider/:add(enabled=true)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="disable-a-provider"><a class="anchor" href="#disable-a-provider"></a>4.6.4. Disable a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=mySPI/provider=myProvider/:write-attribute(name=enabled,value=false)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="change-the-default-provider-for-an-spi"><a class="anchor" href="#change-the-default-provider-for-an-spi"></a>4.6.5. Change the default provider for an SPI</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=mySPI/:write-attribute(name=default-provider,value=myProvider)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configure-the-dblock-spi"><a class="anchor" href="#configure-the-dblock-spi"></a>4.6.6. Configure the dblock SPI</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=dblock/:add(default-provider=jpa)
**/spi=dblock/provider=jpa/:add(properties={lockWaitTimeout =&gt; "900"},enabled=true)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="add-or-change-a-single-property-value-for-a-provider"><a class="anchor" href="#add-or-change-a-single-property-value-for-a-provider"></a>4.6.7. Add or change a single property value for a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=dblock/provider=jpa/:map-put(name=properties,key=lockWaitTimeout,value=3)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="remove-a-single-property-from-a-provider"><a class="anchor" href="#remove-a-single-property-from-a-provider"></a>4.6.8. Remove a single property from a provider</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=dblock/provider=jpa/:map-remove(name=properties,key=lockRecheckTime)</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="set-values-on-a-provider-property-of-type-code-list-code"><a class="anchor" href="#set-values-on-a-provider-property-of-type-code-list-code"></a>4.6.9. Set values on a provider property of type <code>List</code></h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>**/spi=eventsStore/provider=jpa/:map-put(name=properties,key=exclude-events,value=[EVENT1,EVENT2])</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_profiles"><a class="anchor" href="#_profiles"></a>5. Profiles</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak has a single profile, community, that enables most features by default, including features that
are considered less mature. It is however possible to disable individual features.</p>
</div>
<div class="paragraph">
<p>The features that can be enabled and disabled are:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Name</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Enabled by default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">authorization</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authorization Services</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">docker</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Docker Registry protocol</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">impersonation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Ability for admins to impersonate users</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">script</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Write custom authenticators using JavaScript</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To enable a specific feature start the server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=enabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example to enable Docker use <code>-Dkeycloak.profile.feature.docker=enabled</code>.</p>
</div>
<div class="paragraph">
<p>To disable a specific feature start the server with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>bin/standalone.sh|bat -Dkeycloak.profile.feature.&lt;feature name&gt;=disabled</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example to disable Impersonation use <code>-Dkeycloak.profile.feature.impersonation=disabled</code>.</p>
</div>
<div class="paragraph">
<p>You can set this permanently in the <code>profile.properties</code> file by adding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>feature.impersonation=disabled</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_database"><a class="anchor" href="#_database"></a>6. Relational Database Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak comes with its own embedded Java-based relational database called H2.
This is the default database that Keycloak will use to persist data and really only exists so that you can run the authentication
server out of the box.  We highly recommend that you replace it with a more production ready external database.  The H2 database
is not very viable in high concurrency situations and should not be used in a cluster either.  The purpose of this chapter is to
show you how to connect Keycloak to a more mature database.</p>
</div>
<div class="paragraph">
<p>Keycloak uses two layered technologies to persist its relational data.  The bottom layered technology is JDBC.  JDBC
is a Java API that is used to connect to a RDBMS.  There are different JDBC drivers per database type that are provided
by your database vendor.  This chapter discusses how to configure Keycloak to use one of these vendor-specific drivers.</p>
</div>
<div class="paragraph">
<p>The top layered technology for persistence is Hibernate JPA.  This is a object to relational mapping API that maps Java
Objects to relational data.  Most deployments of Keycloak will never have to touch the configuration aspects
of Hibernate, but we will discuss how that is done if you run into that rare circumstance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Datasource configuration is covered much more thoroughly in <a href="https://docs.jboss.org/author/display/WFLY10/DataSource+configuration">the datasource configuration chapter</a>
       in the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_rdbms-setup-checklist"><a class="anchor" href="#_rdbms-setup-checklist"></a>6.1. RDBMS Setup Checklist</h3>
<div class="paragraph">
<p>These are the steps you will need to perform to get an RDBMS configured for Keycloak.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Locate and download a JDBC driver for your database</p>
</li>
<li>
<p>Package the driver JAR into a module and install this module into the server</p>
</li>
<li>
<p>Declare the JDBC driver in the configuration profile of the server</p>
</li>
<li>
<p>Modify the datasource configuration to use your database&#8217;s JDBC driver</p>
</li>
<li>
<p>Modify the datasource configuration to define the connection parameters to your database</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This chapter will use PostgresSQL for all its examples.  Other databases follow the same steps for installation.</p>
</div>
</div>
<div class="sect2">
<h3 id="package-the-jdbc-driver"><a class="anchor" href="#package-the-jdbc-driver"></a>6.2. Package the JDBC Driver</h3>
<div class="paragraph">
<p>Find and download the JDBC driver JAR for your RDBMS. Before you can use this driver, you must package it up into a module and install it into the server. Modules define JARs that are loaded into the Keycloak classpath and the dependencies those JARs have on other modules. They are pretty simple to set up.</p>
</div>
<div class="paragraph">
<p>Within the <em>&#8230;&#8203;/modules/</em> directory of your Keycloak distribution, you need to create a directory structure to hold your module definition.  The convention is use the Java package name of the JDBC driver for the name of the directory structure. For PostgreSQL, create the directory <em>org/postgresql/main</em>. Copy your database driver JAR into this directory and create an empty <em>module.xml</em> file within it too.</p>
</div>
<div class="paragraph">
<div class="title">Module Directory</div>
<p><span class="image"><img src="./keycloak-images/db-module.png" alt="db module"></span></p>
</div>
<div class="paragraph">
<p>After you have done this, open up the <em>module.xml</em> file and create the following XML:</p>
</div>
<div class="listingblock">
<div class="title">Module XML</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="tag">&lt;module</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:module:1.3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.postgresql</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

    <span class="tag">&lt;resources&gt;</span>
        <span class="tag">&lt;resource-root</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postgresql-9.4.1212.jar</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/resources&gt;</span>

    <span class="tag">&lt;dependencies&gt;</span>
        <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.api</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;module</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.transaction.api</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/dependencies&gt;</span>
<span class="tag">&lt;/module&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The module name should match the directory structure of your module. So, <em>org/postgresql</em> maps to <code>org.postgresql</code>. The <code>resource-root path</code> attribute should specify the JAR filename of the driver.  The rest are just the normal dependencies that any JDBC driver JAR would have.</p>
</div>
</div>
<div class="sect2">
<h3 id="declare-and-load-jdbc-driver"><a class="anchor" href="#declare-and-load-jdbc-driver"></a>6.3. Declare and Load JDBC Driver</h3>
<div class="paragraph">
<p>The next thing you have to do is declare your newly packaged JDBC driver into your deployment profile so that it loads and becomes available when the server boots up. Where you perform this action depends on your <a href="#_operating-mode">operating mode</a>. If you&#8217;re deploying in standard mode, edit <em>&#8230;&#8203;/standalone/configuration/standalone.xml</em>.  If you&#8217;re deploying in standard clustering mode, edit <em>&#8230;&#8203;/standalone/configuration/standalone-ha.xml</em>.  If you&#8217;re deploying in domain mode, edit <em>&#8230;&#8203;/domain/configuration/domain.xml</em>. In domain mode, you&#8217;ll need to make sure you edit the profile you are using: either <code>auth-server-standalone</code> or <code>auth-server-clustered</code></p>
</div>
<div class="paragraph">
<p>Within the profile, search for the <code>drivers</code> XML block within the <code>datasources</code> subsystem. You should see a pre-defined driver declared for the H2 JDBC driver. This is where you&#8217;ll declare the JDBC driver for your external database.</p>
</div>
<div class="listingblock">
<div class="title">JDBC Drivers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;datasources&gt;</span>
       ...
       <span class="tag">&lt;drivers&gt;</span>
          <span class="tag">&lt;driver</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">h2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.h2database.h2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xa-datasource-class&gt;</span>org.h2.jdbcx.JdbcDataSource<span class="tag">&lt;/xa-datasource-class&gt;</span>
          <span class="tag">&lt;/driver&gt;</span>
       <span class="tag">&lt;/drivers&gt;</span>
     <span class="tag">&lt;/datasources&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Within the <code>drivers</code> XML block you&#8217;ll need to declare an additional JDBC driver.  It needs to have a <code>name</code> which you can choose to be anything you want.  You specify the <code>module</code> attribute which points to the <code>module</code> package you created earlier for the driver JAR.  Finally you have to specify the driver&#8217;s Java class.  Here&#8217;s an example of installing PostgreSQL driver that lives in the module example defined earlier in this chapter.</p>
</div>
<div class="listingblock">
<div class="title">Declare Your JDBC Drivers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;datasources&gt;</span>
       ...
       <span class="tag">&lt;drivers&gt;</span>
          <span class="tag">&lt;driver</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">postgresql</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">org.postgresql</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xa-datasource-class&gt;</span>org.postgresql.xa.PGXADataSource<span class="tag">&lt;/xa-datasource-class&gt;</span>
          <span class="tag">&lt;/driver&gt;</span>
          <span class="tag">&lt;driver</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">h2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">com.h2database.h2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xa-datasource-class&gt;</span>org.h2.jdbcx.JdbcDataSource<span class="tag">&lt;/xa-datasource-class&gt;</span>
          <span class="tag">&lt;/driver&gt;</span>
       <span class="tag">&lt;/drivers&gt;</span>
     <span class="tag">&lt;/datasources&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="modify-the-keycloak-datasource"><a class="anchor" href="#modify-the-keycloak-datasource"></a>6.4. Modify the Keycloak Datasource</h3>
<div class="paragraph">
<p>After declaring your JDBC driver, you  have to modify the existing datasource configuration that Keycloak uses
to connect it to your new external database.  You&#8217;ll do
this within the same configuration file and XML block that you registered your JDBC driver in.  Here&#8217;s an example
that sets up the connection to your new database:</p>
</div>
<div class="listingblock">
<div class="title">Declare Your JDBC Drivers</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">  <span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:datasources:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;datasources&gt;</span>
       ...
       <span class="tag">&lt;datasource</span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datasources/KeycloakDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">pool-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">KeycloakDS</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">use-java-context</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           <span class="tag">&lt;connection-url&gt;</span>jdbc:postgresql://localhost/keycloak<span class="tag">&lt;/connection-url&gt;</span>
           <span class="tag">&lt;driver&gt;</span>postgresql<span class="tag">&lt;/driver&gt;</span>
           <span class="tag">&lt;pool&gt;</span>
               <span class="tag">&lt;max-pool-size&gt;</span>20<span class="tag">&lt;/max-pool-size&gt;</span>
           <span class="tag">&lt;/pool&gt;</span>
           <span class="tag">&lt;security&gt;</span>
               <span class="tag">&lt;user-name&gt;</span>William<span class="tag">&lt;/user-name&gt;</span>
               <span class="tag">&lt;password&gt;</span>password<span class="tag">&lt;/password&gt;</span>
           <span class="tag">&lt;/security&gt;</span>
       <span class="tag">&lt;/datasource&gt;</span>
        ...
     <span class="tag">&lt;/datasources&gt;</span>
  <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Search for the <code>datasource</code> definition for <code>KeycloakDS</code>.  You&#8217;ll first need to modify the <code>connection-url</code>.  The
documentation for your vendor&#8217;s JDBC implementation should specify the format for this connection URL value.</p>
</div>
<div class="paragraph">
<p>Next define the <code>driver</code> you will use.  This is the logical name of the JDBC driver you declared in the previous section of this
chapter.</p>
</div>
<div class="paragraph">
<p>It is expensive to open a new connection to a database every time you want to perform a transaction.  To compensate, the datasource
implementation maintains a pool of open connections.  The <code>max-pool-size</code> specifies the maximum number of connections it will pool.
You may want to change the value of this depending on the load of your system.</p>
</div>
<div class="paragraph">
<p>Finally, with PostgreSQL at least, you need to define the database username and password that is needed to connect to the database.  You
may be worried that this is in clear text in the example.  There are methods to obfuscate this, but this is beyond the
scope of this guide.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
For more information about datasource features, see <a href="https://docs.jboss.org/author/display/WFLY10/DataSource+configuration">the datasource configuration chapter</a> in the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="database-configuration"><a class="anchor" href="#database-configuration"></a>6.5. Database Configuration</h3>
<div class="paragraph">
<p>The configuration for this component is found in the <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file in your distribution. The location of this file depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="title">Database Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:keycloak-server:1.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsJpa</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;properties&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dataSource</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:jboss/datasources/KeycloakDS</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">initializeEmpty</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrationStrategy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">manual</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
             <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrationExport</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.home.dir}/keycloak-database-update.sql</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/properties&gt;</span>
     <span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;/spi&gt;</span>
    ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">dataSource</dt>
<dd>
<p>JNDI name of the dataSource</p>
</dd>
<dt class="hdlist1">jta</dt>
<dd>
<p>boolean property to specify if datasource is JTA capable</p>
</dd>
<dt class="hdlist1">driverDialect</dt>
<dd>
<p>Value of database dialect.
In most cases you don&#8217;t need to specify this property as dialect will be autodetected by Hibernate.</p>
</dd>
<dt class="hdlist1">initializeEmpty</dt>
<dd>
<p>Initialize database if empty. If set to false the database has to be manually initialized. If you want to manually initialize the database set migrationStrategy to <code>manual</code> which will create a file with SQL commands to initialize the database. Defaults to true.</p>
</dd>
<dt class="hdlist1">migrationStrategy</dt>
<dd>
<p>Strategy to use to migrate database. Valid values are <code>update</code>, <code>manual</code> and <code>validate</code>. Update will automatically migrate the database schema. Manual will export the required changes to a file with SQL commands that you can manually execute on the database. Validate will simply check if the database is up-to-date.</p>
</dd>
<dt class="hdlist1">migrationExport</dt>
<dd>
<p>Path for where to write manual database initialization/migration file.</p>
</dd>
<dt class="hdlist1">showSql</dt>
<dd>
<p>Specify whether Hibernate should show all SQL commands in the console (false by default).  This is very verbose!</p>
</dd>
<dt class="hdlist1">formatSql</dt>
<dd>
<p>Specify whether Hibernate should format SQL commands (true by default)</p>
</dd>
<dt class="hdlist1">globalStatsInterval</dt>
<dd>
<p>Will log global statistics from Hibernate about executed DB queries and other things.
Statistics are always reported to server log at specified interval (in seconds) and are cleared after each report.</p>
</dd>
<dt class="hdlist1">schema</dt>
<dd>
<p>Specify the database schema to use</p>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
These configuration switches and more are described in the <a href="https://docs.jboss.org/author/display/WFLY10/JPA+Reference+Guide#JPAReferenceGuide-Hibernateproperties"><em>JBoss EAP Development Guide</em></a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="unicode-considerations-for-databases"><a class="anchor" href="#unicode-considerations-for-databases"></a>6.6. Unicode Considerations for Databases</h3>
<div class="paragraph">
<p>Database schema in Keycloak only accounts for Unicode strings in the following special fields:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Realms: display name, HTML display name</p>
</li>
<li>
<p>Federation Providers: display name</p>
</li>
<li>
<p>Users: username, given name, last name, attribute names and values</p>
</li>
<li>
<p>Groups: name, attribute names and values</p>
</li>
<li>
<p>Roles: name</p>
</li>
<li>
<p>Descriptions of objects</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Otherwise, characters are limited to those contained in database encoding which is often 8-bit. However, for some
database systems, it is possible to enable UTF-8 encoding of Unicode characters and use full Unicode character set in all
text fields. Often, this is counterbalanced by shorter maximum length of the strings than in case of 8-bit encodings.</p>
</div>
<div class="paragraph">
<p>Some of the databases require special settings to database and/or JDBC driver to be able to handle Unicode characters.
Please find the settings for your database below. Note that if a database is listed here, it can still work properly
provided it handles UTF-8 encoding properly both on the level of database and JDBC driver.</p>
</div>
<div class="paragraph">
<p>Technically, the key criterion for Unicode support for all fields is whether the database allows setting of Unicode
character set for <code>VARCHAR</code> and <code>CHAR</code> fields. If yes, there is a high chance that Unicode will be plausible, usually at
the expense of field length. If it only supports Unicode in <code>NVARCHAR</code> and <code>NCHAR</code> fields, Unicode support for all text
fields is unlikely as Keycloak schema uses <code>VARCHAR</code> and <code>CHAR</code> fields extensively.</p>
</div>
<div class="sect3">
<h4 id="oracle-database"><a class="anchor" href="#oracle-database"></a>6.6.1. Oracle Database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled provided the database was created with Unicode support in <code>VARCHAR</code> and <code>CHAR</code>
fields (e.g. by using <code>AL32UTF8</code> character set as the database character set). No special settings is needed for JDBC
driver.</p>
</div>
<div class="paragraph">
<p>If the database character set is not Unicode, then to use Unicode characters in the special fields, the JDBC driver needs
to be configured with the connection property <code>oracle.jdbc.defaultNChar</code> set to <code>true</code>. It might be wise, though not
strictly necessary, to also set the <code>oracle.jdbc.convertNcharLiterals</code> connection property to <code>true</code>. These properties
can be set either as system properties or as connection properties. Please note that setting <code>oracle.jdbc.defaultNChar</code>
may have negative impact on performance. For details, please refer to Oracle JDBC driver configuration documentation.</p>
</div>
</div>
<div class="sect3">
<h4 id="microsoft-sql-server-database"><a class="anchor" href="#microsoft-sql-server-database"></a>6.6.2. Microsoft SQL Server Database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled only for the special fields. No special settings of JDBC driver or database is
necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="ibm-db2-database"><a class="anchor" href="#ibm-db2-database"></a>6.6.3. IBM DB2 Database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled for all fields, length reduction applies to non-special fields. No special
settings of JDBC driver or database is necessary.</p>
</div>
</div>
<div class="sect3">
<h4 id="mysql-database"><a class="anchor" href="#mysql-database"></a>6.6.4. MySQL Database</h4>
<div class="paragraph">
<p>Unicode characters are properly handled provided the database was created with Unicode support in <code>VARCHAR</code> and <code>CHAR</code>
fields in the <code>CREATE DATABASE</code> command (e.g. by using <code>utf8</code> character set as the default database character set in
MySQL 5.5. Please note that <code>utf8mb4</code> character set does not work due to different storage requirements to <code>utf8</code>
character set <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnote_1" title="View footnote.">1</a>]</sup>). Note that in this case, length
restriction to non-special fields does not apply because columns are created to accomodate given amount of characters,
not bytes. If the database default character set does not allow storing Unicode, only the special fields allow storing
Unicode values.</p>
</div>
<div class="paragraph">
<p>At the side of JDBC driver settings, it is necessary to add a connection property <code>characterEncoding=UTF-8</code> to the JDBC
connection settings.</p>
</div>
</div>
<div class="sect3">
<h4 id="postgresql-database"><a class="anchor" href="#postgresql-database"></a>6.6.5. PostgreSQL Database</h4>
<div class="paragraph">
<p>Unicode is supported when the database character set is <code>UTF8</code>. In that case, Unicode characters can be used in any
field, there is no reduction of field length for non-special fields. No special settings of JDBC driver is necessary.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_network"><a class="anchor" href="#_network"></a>7. Network Setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak can run out of the box with some networking limitations.  For one, all network endpoints bind to <code>localhost</code>
so the auth server is really only usable on one local machine.  For HTTP based connections, it does not use default ports
like 80 and 443.  HTTPS/SSL is not configured out of the box and without it, Keycloak has many security
vulnerabilities.
Finally, Keycloak
may often need to make secure SSL and HTTPS connections to external servers and thus need a trust store set up so that endpoints can
be validated correctly.  This chapter discusses all of these things.</p>
</div>
<div class="sect2">
<h3 id="_bind-address"><a class="anchor" href="#_bind-address"></a>7.1. Bind Addresses</h3>
<div class="paragraph">
<p>By default Keycloak binds to the localhost loopback address <code>127.0.0.1</code>.  That&#8217;s not a very useful default if
you want the authentication server available on your network.  Generally, what we recommend is that you deploy a reverse proxy
or load balancer on a public network and route traffic to individual Keycloak server instances on a private network.
In either case though, you still need to set up your network interfaces to bind to something other than <code>localhost</code>.</p>
</div>
<div class="paragraph">
<p>Setting the bind address is quite easy and can be done on the command line with either the <em>standalone.sh</em> or
<em>domain.sh</em> boot scripts discussed in the <a href="#_operating-mode">Choosing an Operating Mode</a> chapter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ standalone.sh -b 192.168.0.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-b</code> switch sets the IP bind address for any public interfaces.</p>
</div>
<div class="paragraph">
<p>Alternatively, if you don&#8217;t want to set the bind address at the command line, you can edit the profile configuration of your deployment.
Open up the profile configuration file (<em>standalone.xml</em> or <em>domain.xml</em> depending on your
<a href="#_operating-mode">operating mode</a>) and look for the <code>interfaces</code> XML block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;interfaces&gt;</span>
        <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.management:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/interface&gt;</span>
        <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;/interfaces&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>public</code> interface corresponds to subsystems creating sockets that are available publicly.  An example of one
of these subsystems is the web layer which serves up the authentication endpoints of Keycloak.  The <code>management</code>
interface corresponds to sockets opened up by the management layer of the WildFly.  Specifically the sockets
which allow you to use the <code>jboss-cli.sh</code> command line interface and the WildFly web console.</p>
</div>
<div class="paragraph">
<p>In looking at the <code>public</code> interface you see that it has a special string <code>${jboss.bind.address:127.0.0.1}</code>.  This string
denotes a value <code>127.0.0.1</code> that can be overriden on the command line by setting a Java system property, i.e.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ domain.sh -Djboss.bind.address=192.168.0.5</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>-b</code> is just a shorthand notation for this command.  So, you can either change the bind address value directly in the profile config, or change it on the command line when
you boot up.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are many more options available when setting up <code>interface</code> definitions. For more information, see <a href="https://docs.jboss.org/author/display/WFLY10/Interfaces+and+ports">the network interface</a> in the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_ports"><a class="anchor" href="#_ports"></a>7.2. Socket Port Bindings</h3>
<div class="paragraph">
<p>The ports opened for each socket have a pre-defined default that can be overriden at the command line or within configuration.
To illustrate this configuration, let&#8217;s pretend you are running in <a href="#_standalone-mode">standalone mode</a> and
open up the <em>&#8230;&#8203;/standalone/configuration/standalone.xml</em>.  Search for <code>socket-binding-group</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management-http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.management.http.port:9990}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management-https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">management</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.management.https.port:9993}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.ajp.port:8009}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.http.port:8080}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.https.port:8443}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txn-recovery-environment</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4712</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">txn-status-manager</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">4713</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mail-smtp</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">25</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/outbound-socket-binding&gt;</span>
    <span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>socket-bindings</code> define socket connections that will be opened by the server.  These bindings specify the
<code>interface</code> (bind address) they use as well as what port number they will open.   The ones you will be most interested in are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">http</dt>
<dd>
<p>Defines the port used for Keycloak HTTP connections</p>
</dd>
<dt class="hdlist1">https</dt>
<dd>
<p>Defines the port used for Keycloak HTTPS connections</p>
</dd>
<dt class="hdlist1">ajp</dt>
<dd>
<p>This socket binding defines the port used for the AJP protocol.  This protocol is used by Apache HTTPD server
in conjunction <code>mod-cluster</code> when you are using Apache HTTPD as a load balancer.</p>
</dd>
<dt class="hdlist1">management-http</dt>
<dd>
<p>Defines the HTTP connection used by WildFly CLI and web console.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>When running in <a href="#_domain-mode">domain mode</a> setting the socket configurations
is a bit trickier as the example <em>domain.xml</em> file has multiple <code>socket-binding-groups</code> defined.  If you scroll down
to the <code>server-group</code> definitions you can see what <code>socket-binding-group</code> is used for each <code>server-group</code>.</p>
</div>
<div class="listingblock">
<div class="title">domain socket bindings</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;server-groups&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
        <span class="tag">&lt;server-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-group</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">profile</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">auth-server-clustered</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            ...
            <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ha-sockets</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/server-group&gt;</span>
    <span class="tag">&lt;/server-groups&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are many more options available when setting up <code>socket-binding-group</code> definitions.  For more information, see <a href="https://docs.jboss.org/author/display/WFLY10/Interfaces+and+ports">the socket binding group</a> in the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="setting-up-https-ssl"><a class="anchor" href="#setting-up-https-ssl"></a>7.3. Setting up HTTPS/SSL</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Keycloak is not set up by default to handle SSL/HTTPS.
          It is highly recommended that you either enable SSL on the Keycloak server itself or on a reverse proxy in front of the Keycloak server.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This default behavior is defined by the SSL/HTTPS mode of each Keycloak realm.  This is discussed in more detail in the
<a href="http://www.keycloak.org/docs/3.4/server_admin/">Server Administration Guide</a>, but let&#8217;s give some context and a brief overview of these modes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">external requests</dt>
<dd>
<p>Keycloak can run out of the box without SSL so long as you stick to private IP addresses like <code>localhost</code>, <code>127.0.0.1</code>, <code>10.0.x.x</code>, <code>192.168.x.x</code>, and <code>172..16.x.x</code>.
If you don’t have SSL/HTTPS configured on the server or you try to access Keycloak over HTTP from a non-private IP adress you will get an error.</p>
</dd>
<dt class="hdlist1">none</dt>
<dd>
<p>Keycloak does not require SSL.  This should really only be used in development when you are playing around with things.</p>
</dd>
<dt class="hdlist1">all requests</dt>
<dd>
<p>Keycloak requires SSL for all IP addresses.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>The SSL mode for each realm can be configured in the Keycloak admin console.</p>
</div>
<div class="sect3">
<h4 id="enabling-ssl-https-for-the-keycloak-server"><a class="anchor" href="#enabling-ssl-https-for-the-keycloak-server"></a>7.3.1. Enabling SSL/HTTPS for the Keycloak Server</h4>
<div class="paragraph">
<p>If you are not using a reverse proxy or load balancer to handle HTTPS traffic for you, you&#8217;ll need to enable HTTPS
for the Keycloak server.  This involves</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Obtaining or generating a keystore that contains the private key and certificate for SSL/HTTP traffic</p>
</li>
<li>
<p>Configuring the Keycloak server to use this keypair and certificate.</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="creating-the-certificate-and-java-keystore"><a class="anchor" href="#creating-the-certificate-and-java-keystore"></a>Creating the Certificate and Java Keystore</h5>
<div class="paragraph">
<p>In order to allow HTTPS connections, you need to obtain a self signed or third-party signed certificate and import it into a Java keystore before you can enable HTTPS in the web container you are deploying the Keycloak Server to.</p>
</div>
<div class="sect5">
<h6 id="self-signed-certificate"><a class="anchor" href="#self-signed-certificate"></a>Self Signed Certificate</h6>
<div class="paragraph">
<p>In development, you will probably not have a third party signed certificate available to test a Keycloak deployment so you&#8217;ll need to generate a self-signed one
using the <code>keytool</code> utility that comes with the Java JDK.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -genkey -alias localhost -keyalg RSA -keystore keycloak.jks -validity 10950
    Enter keystore password: secret
    Re-enter new password: secret
    What is your first and last name?
    [Unknown]:  localhost
    What is the name of your organizational unit?
    [Unknown]:  Keycloak
    What is the name of your organization?
    [Unknown]:  Red Hat
    What is the name of your City or Locality?
    [Unknown]:  Westford
    What is the name of your State or Province?
    [Unknown]:  MA
    What is the two-letter country code for this unit?
    [Unknown]:  US
    Is CN=localhost, OU=Keycloak, O=Test, L=Westford, ST=MA, C=US correct?
    [no]:  yes</code></pre>
</div>
</div>
<div class="paragraph">
<p>You should answer <code>What is your first and last name ?</code> question with the DNS name of the machine you&#8217;re installing the server on.
For testing purposes, <code>localhost</code> should be used.
After executing this command, the <code>keycloak.jks</code> file will be generated in the same directory as you executed the <code>keytool</code> command in.</p>
</div>
<div class="paragraph">
<p>If you want a third-party signed certificate, but don&#8217;t have one, you can obtain one for free at <a href="http://www.cacert.org">cacert.org</a>.
You&#8217;ll have to do a little set up first before doing this though.</p>
</div>
<div class="paragraph">
<p>The first thing to do is generate a Certificate Request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -certreq -alias yourdomain -keystore keycloak.jks &gt; keycloak.careq</code></pre>
</div>
</div>
<div class="paragraph">
<p>Where <code>yourdomain</code> is a DNS name for which this certificate is generated for.
Keytool generates the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>-----BEGIN NEW CERTIFICATE REQUEST-----
MIIC2jCCAcICAQAwZTELMAkGA1UEBhMCVVMxCzAJBgNVBAgTAk1BMREwDwYDVQQHEwhXZXN0Zm9y
ZDEQMA4GA1UEChMHUmVkIEhhdDEQMA4GA1UECxMHUmVkIEhhdDESMBAGA1UEAxMJbG9jYWxob3N0
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAr7kck2TaavlEOGbcpi9c0rncY4HhdzmY
Ax2nZfq1eZEaIPqI5aTxwQZzzLDK9qbeAd8Ji79HzSqnRDxNYaZu7mAYhFKHgixsolE3o5Yfzbw1
29RvyeUVe+WZxv5oo9wolVVpdSINIMEL2LaFhtX/c1dqiqYVpfnvFshZQaIg2nL8juzZcBjj4as
H98gIS7khql/dkZKsw9NLvyxgJvp7PaXurX29fNf3ihG+oFrL22oFyV54BWWxXCKU/GPn61EGZGw
Ft2qSIGLdctpMD1aJR2bcnlhEjZKDksjQZoQ5YMXaAGkcYkG6QkgrocDE2YXDbi7GIdf9MegVJ35
2DQMpwIDAQABoDAwLgYJKoZIhvcNAQkOMSEwHzAdBgNVHQ4EFgQUQwlZJBA+fjiDdiVzaO9vrE/i
n2swDQYJKoZIhvcNAQELBQADggEBAC5FRvMkhal3q86tHPBYWBuTtmcSjs4qUm6V6f63frhveWHf
PzRrI1xH272XUIeBk0gtzWo0nNZnf0mMCtUBbHhhDcG82xolikfqibZijoQZCiGiedVjHJFtniDQ
9bMDUOXEMQ7gHZg5q6mJfNG9MbMpQaUVEEFvfGEQQxbiFK7hRWU8S23/d80e8nExgQxdJWJ6vd0X
MzzFK6j4Dj55bJVuM7GFmfdNC52pNOD5vYe47Aqh8oajHX9XTycVtPXl45rrWAH33ftbrS8SrZ2S
vqIFQeuLL3BaHwpl3t7j2lMWcK1p80laAxEASib/fAwrRHpLHBXRcq6uALUOZl4Alt8=
-----END NEW CERTIFICATE REQUEST-----</code></pre>
</div>
</div>
<div class="paragraph">
<p>Send this ca request to your CA.
The CA will issue you a signed certificate and send it to you.
Before you import your new cert, you must obtain and import the root certificate of the CA.
You can download the cert from CA (ie.: root.crt) and import as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -import -keystore keycloak.jks -file root.crt -alias root</code></pre>
</div>
</div>
<div class="paragraph">
<p>Last step is to import your new CA generated certificate to your keystore:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -import -alias yourdomain -keystore keycloak.jks -file your-certificate.cer</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="configure-keycloak-to-use-the-keystore"><a class="anchor" href="#configure-keycloak-to-use-the-keystore"></a>Configure Keycloak to Use the Keystore</h5>
<div class="paragraph">
<p>Now that you have a Java keystore with the appropriate certificates, you need to configure your Keycloak installation to use it.
First step is to move the keystore file to the <em>configuration/</em> directory of your deployment and to edit the <em>standalone.xml</em>, <em>standalone-ha.xml</em> or <em>domain.xml</em> file to use
the keystore and enable HTTPS.  (See <a href="#_operating-mode">operating mode</a>).</p>
</div>
<div class="paragraph">
<p>In the standalone or domain configuration file, search for the <code>security-realms</code> element and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;security-realm</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UndertowRealm</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;server-identities&gt;</span>
        <span class="tag">&lt;ssl&gt;</span>
            <span class="tag">&lt;keystore</span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak.jks</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">relative-to</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jboss.server.config.dir</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">keystore-password</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;/ssl&gt;</span>
    <span class="tag">&lt;/server-identities&gt;</span>
<span class="tag">&lt;/security-realm&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Find the element <code>server name="default-server"</code> (it&#8217;s a child element of <code>subsystem xmlns="urn:jboss:domain:undertow:3.1"</code>) and add:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:3.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;buffer-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;https-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">security-realm</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">UndertowRealm</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="outgoing-http-requests"><a class="anchor" href="#outgoing-http-requests"></a>7.4. Outgoing HTTP Requests</h3>
<div class="paragraph">
<p>The Keycloak server often needs to make non-browser HTTP requests to the applications and services it secures.
The auth server manages these outgoing connections by maintaining an HTTP client connection pool.  There are some things
you&#8217;ll need to configure in <code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code>.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="title">HTTP client Config example</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connectionsHttpClient</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">connection-pool-size</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">256</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">establish-connection-timeout-millis</dt>
<dd>
<p>Timeout for establishing a socket connection.</p>
</dd>
<dt class="hdlist1">socket-timeout-millis</dt>
<dd>
<p>If an outgoing request does not receive data for this amount of time, timeout the connection.</p>
</dd>
<dt class="hdlist1">connection-pool-size</dt>
<dd>
<p>How many connections can be in the pool (128 by default).</p>
</dd>
<dt class="hdlist1">max-pooled-per-route</dt>
<dd>
<p>How many connections can be pooled per host (64 by default).</p>
</dd>
<dt class="hdlist1">connection-ttl-millis</dt>
<dd>
<p>Maximum connection time to live in milliseconds.
Not set by default.</p>
</dd>
<dt class="hdlist1">max-connection-idle-time-millis</dt>
<dd>
<p>Maximum time the connection might stay idle in the connection pool (900 seconds by default). Will start background cleaner thread of Apache HTTP client.
Set to -<code>1</code> to disable this checking and the background thread.</p>
</dd>
<dt class="hdlist1">disable-cookies</dt>
<dd>
<p><code>true</code> by default.
When set to true, this will disable any cookie caching.</p>
</dd>
<dt class="hdlist1">client-keystore</dt>
<dd>
<p>This is the file path to a Java keystore file.
This keystore contains client certificate for two-way SSL.</p>
</dd>
<dt class="hdlist1">client-keystore-password</dt>
<dd>
<p>Password for the client keystore.
This is <em>REQUIRED</em> if <code>client-keystore</code> is set.</p>
</dd>
<dt class="hdlist1">client-key-password</dt>
<dd>
<p>Password for the client&#8217;s key.
This is <em>REQUIRED</em> if <code>client-keystore</code> is set.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="_truststore"><a class="anchor" href="#_truststore"></a>7.4.1. Outgoing HTTPS Request Truststore</h4>
<div class="paragraph">
<p>When Keycloak invokes on remote HTTPS endpoints, it has to validate the remote server&#8217;s certificate in order to ensure it is connecting to a trusted server.
This is necessary in order to prevent man-in-the-middle attacks.  The certificates of these remote server&#8217;s or the CA that signed these
certificates must be put in a truststore.  This truststore is managed by the Keycloak server.</p>
</div>
<div class="paragraph">
<p>The truststore is used when connecting securely to identity brokers, LDAP identity providers, when sending emails, and for backchannel communication with client applications.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
By default, a truststore provider is not configured, and any https connections fall back to standard java truststore configuration as described in
          <a href="https://docs.oracle.com/javase/8/docs/technotes/guides/security/jsse/JSSERefGuide.html">Java&#8217;s JSSE Reference Guide</a>.  If there is no trust
          establised, then these outgoing HTTPS requests will fail.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can use <em>keytool</em> to create a new truststore file or add trusted host certificates to an existing one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ keytool -import -alias HOSTDOMAIN -keystore truststore.jks -file host-certificate.cer</code></pre>
</div>
</div>
<div class="paragraph">
<p>The truststore is configured within the <code>standalone.xml</code>,
<code>standalone-ha.xml</code>, or <code>domain.xml</code> file in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.
You can add your truststore configuration by using the following template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">truststore</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">file</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">path to your .jks file containing public certificates</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">hostname-verification-policy</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">WILDCARD</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">disabled</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Possible configuration options for this setting are:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">file</dt>
<dd>
<p>The path to a Java keystore file.
HTTPS requests need a way to verify the host of the server they are talking to.
This is what the trustore does.
The keystore contains one or more trusted host certificates or certificate authorities.
This truststore file should only contain public certificates of your secured hosts.
This is <em>REQUIRED</em> if <code>disabled</code> is not true.</p>
</dd>
<dt class="hdlist1">password</dt>
<dd>
<p>Password for the truststore.
This is <em>REQUIRED</em> if <code>disabled</code> is not true.</p>
</dd>
<dt class="hdlist1">hostname-verification-policy</dt>
<dd>
<p><code>WILDCARD</code> by default.
For HTTPS requests, this verifies the hostname of the server&#8217;s certificate.
 <code>ANY</code> means that the hostname is not verified. <code>WILDCARD</code> Allows wildcards in subdomain names i.e.
*.foo.com. <code>STRICT</code> CN must match hostname exactly.</p>
</dd>
<dt class="hdlist1">disabled</dt>
<dd>
<p>If true (default value), truststore configuration will be ignored, and certificate checking will fall back to JSSE configuration as described.
If set to false, you must configure <code>file</code>, and <code>password</code> for the truststore.</p>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clustering"><a class="anchor" href="#_clustering"></a>8. Clustering</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This section covers configuring Keycloak to run in a cluster.  There&#8217;s a number
of things you have to do when setting up a cluster, specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#_operating-mode">Pick an operation mode</a></p>
</li>
<li>
<p><a href="#_database">Configure a shared external database</a></p>
</li>
<li>
<p>Set up a load balancer</p>
</li>
<li>
<p>Supplying a private network that supports IP multicast</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Picking an operation mode and configuring a shared database have been discussed earlier in this guide.  In this chapter
we&#8217;ll discuss setting up a load balancer and supplying a private network.  We&#8217;ll also discuss some issues that you need
to be aware of when booting up a host in the cluster.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to cluster Keycloak without IP Multicast, but this topic is beyond the scope of this guide.  For more information, see <a href="https://docs.jboss.org/author/display/WFLY10/JGroups+Subsystem">JGroups</a> chapter of the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="recommended-network-architecture"><a class="anchor" href="#recommended-network-architecture"></a>8.1. Recommended Network Architecture</h3>
<div class="paragraph">
<p>The recommended network architecture for deploying Keycloak is to set up an HTTP/HTTPS load balancer on
a public IP address that routes requests to Keycloak servers sitting on a private network.  This
isolates all clustering connections and provides a nice means of protecting the servers.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, there is nothing to prevent unauthorized nodes from joining the cluster and broadcasting multicast messages.
      This is why cluster nodes should be in a private network, with a firewall protecting them from outside attacks.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="clustering-example"><a class="anchor" href="#clustering-example"></a>8.2. Clustering Example</h3>
<div class="paragraph">
<p>Keycloak does come with an out of the box clustering demo that leverages domain mode.  Review the
<a href="#_clustered-domain-example">Clustered Domain Example</a> chapter for more details.</p>
</div>
</div>
<div class="sect2">
<h3 id="_setting-up-a-load-balancer-or-proxy"><a class="anchor" href="#_setting-up-a-load-balancer-or-proxy"></a>8.3. Setting Up a Load Balancer or Proxy</h3>
<div class="paragraph">
<p>This section discusses a number of things you need to configure before you can put a reverse proxy or load balancer
in front of your clustered Keycloak deployment.  It also covers configuring the built in load balancer that
was <a href="#_clustered-domain-example">Clustered Domain Example</a>.</p>
</div>
<div class="sect3">
<h4 id="identifying-client-ip-addresses"><a class="anchor" href="#identifying-client-ip-addresses"></a>8.3.1. Identifying Client IP Addresses</h4>
<div class="paragraph">
<p>A few features in Keycloak rely on the fact that the remote
address of the HTTP client connecting to the authentication server is the real IP address of the client machine. Examples include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Event logs - a failed login attempt would be logged with the wrong source IP address</p>
</li>
<li>
<p>SSL required - if the SSL required is set to external (the default) it should require SSL for all external requests</p>
</li>
<li>
<p>Authentication flows - a custom authentication flow that uses the IP address to for example show OTP only for external requests</p>
</li>
<li>
<p>Dynamic Client Registration</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This can be problematic when you have a reverse proxy or loadbalancer in front of your Keycloak authentication server.
The usual setup is that you have a frontend proxy sitting on a public network that load balances and forwards requests
to backend Keycloak server instances located in a private network.  There is some extra configuration you have to do in this scenario
so that the actual client IP address is forwarded to and processed by the Keycloak server instances.  Specifically:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure your reverse proxy or loadbalancer to properly set <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code> HTTP headers.</p>
</li>
<li>
<p>Configure your reverse proxy or loadbalancer to preserve the original 'Host' HTTP header.</p>
</li>
<li>
<p>Configure the authentication server to read the client&#8217;s IP address from <code>X-Forwarded-For header</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Configuring your proxy to generate the <code>X-Forwarded-For</code> and <code>X-Forwarded-Proto</code> HTTP headers and preserving the
 original <code>Host</code> HTTP header is beyond the scope of this guide.  Take extra precautions to ensure that the
<code>X-Forwared-For</code> header is set by your proxy.  If your proxy isn&#8217;t configured correctly, then <em>rogue</em> clients can set this header themselves and trick Keycloak
into thinking the client is connecting from a different IP address than it actually is.  This becomes really important if you are doing
any black or white listing of IP addresses.</p>
</div>
<div class="paragraph">
<p>Beyond the proxy itself, there are a few things you need to configure on the Keycloak side of things.
If your proxy is forwarding requests via the HTTP protocol, then you need to configure Keycloak to pull the client&#8217;s
IP address from the <code>X-Forwarded-For</code> header rather than from the network packet.
To do this, open up the profile configuration file (<em>standalone.xml</em>, <em>standalone-ha.xml</em>, or <em>domain.xml</em> depending on your
<a href="#_operating-mode">operating mode</a>) and look for the <code>urn:jboss:domain:undertow:3.1</code> XML block.</p>
</div>
<div class="listingblock">
<div class="title"><code>X-Forwarded-For</code> HTTP Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:3.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;buffer-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
   <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;ajp-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;http-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">redirect-socket</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">proxy-address-forwarding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      ...
   <span class="tag">&lt;/server&gt;</span>
   ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the <code>proxy-address-forwarding</code> attribute to the <code>http-listener</code> element.  Set the value to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>If your proxy is using the AJP protocol instead of HTTP to forward requests (i.e. Apache HTTPD + mod-cluster), then you have
to configure things a little differently.  Instead of modifying the <code>http-listener</code>, you need to add a filter to
pull this information from the AJP packets.</p>
</div>
<div class="listingblock">
<div class="title"><code>X-Forwarded-For</code> AJP Config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:3.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
     <span class="tag">&lt;buffer-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
     <span class="tag">&lt;server</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-server</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;ajp-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;http-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">redirect-socket</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-host</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
             ...
             <span class="tag">&lt;filter-ref</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-peer</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;/host&gt;</span>
     <span class="tag">&lt;/server&gt;</span>
        ...
     <span class="tag">&lt;filters&gt;</span>
         ...
         <span class="tag">&lt;filter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-peer</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">class-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.undertow.server.handlers.ProxyPeerAddressHandler</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">module</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">io.undertow.core</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
     <span class="tag">&lt;/filters&gt;</span>
 <span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="enable-https-ssl-with-a-reverse-proxy"><a class="anchor" href="#enable-https-ssl-with-a-reverse-proxy"></a>8.3.2. Enable HTTPS/SSL with a Reverse Proxy</h4>
<div class="paragraph">
<p>Assuming that your reverse proxy doesn&#8217;t use port 8443 for SSL you also need to configure what port HTTPS traffic is redirected to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:3.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;http-listener</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span>
        <span class="attribute-name">proxy-address-forwarding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">redirect-socket</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-https</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add the <code>redirect-socket</code> attribute to the <code>http-listener</code> element.  The value should be <code>proxy-https</code> which points to a
socket binding you also need to define.</p>
</div>
<div class="paragraph">
<p>Then add a new <code>socket-binding</code> element to the <code>socket-binding-group</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">proxy-https</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">443</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="verify-configuration"><a class="anchor" href="#verify-configuration"></a>8.3.3. Verify Configuration</h4>
<div class="paragraph">
<p>You can verify the reverse proxy or load balancer configuration by opening the path <code>/auth/realms/master/.well-known/openid-configuration</code>
through the reverse proxy. For example if the reverse proxy address is <code>https://acme.com/</code> then open the URL
<code>https://acme.com/auth/realms/master/.well-known/openid-configuration</code>. This will show a JSON document listing a number
of endpoints for Keycloak. Make sure the endpoints starts with the address (scheme, domain and port) of your
reverse proxy or load balancer. By doing this you make sure that Keycloak is using the correct endpoint.</p>
</div>
<div class="paragraph">
<p>You should also verify that Keycloak sees the correct source IP address for requests. Do check this you can
try to login to the admin console with an invalid username and/or password. This should show a warning in the server log
something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>08:14:21,287 WARN  XNIO-1 task-45 [org.keycloak.events] type=LOGIN_ERROR, realmId=master, clientId=security-admin-console, userId=8f20d7ba-4974-4811-a695-242c8fbd1bf8, ipAddress=X.X.X.X, error=invalid_user_credentials, auth_method=openid-connect, auth_type=code, redirect_uri=http://localhost:8080/auth/admin/master/console/?redirect_fragment=%2Frealms%2Fmaster%2Fevents-settings, code_id=a3d48b67-a439-4546-b992-e93311d6493e, username=admin</code></pre>
</div>
</div>
<div class="paragraph">
<p>Check that the value of <code>ipAddress</code> is the IP address of the machine you tried to login with and not the IP address
 of the reverse proxy or load balancer.</p>
</div>
</div>
<div class="sect3">
<h4 id="using-the-built-in-load-balancer"><a class="anchor" href="#using-the-built-in-load-balancer"></a>8.3.4. Using the Built-In Load Balancer</h4>
<div class="paragraph">
<p>This section covers configuring the built in load balancer that is discussed in the
<a href="#_clustered-domain-example">Clustered Domain Example</a>.</p>
</div>
<div class="paragraph">
<p>The <a href="#_clustered-domain-example">Clustered Domain Example</a> is only designed to run
on one machine.  To bring up a slave on another host, you&#8217;ll need to</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Edit the <em>domain.xml</em> file to point to your new host slave</p>
</li>
<li>
<p>Copy the server distribution.  You don&#8217;t need the <em>domain.xml</em>, <em>host.xml</em>, or <em>host-master.xml</em> files.  Nor do you need
the <em>standalone/</em> directory.</p>
</li>
<li>
<p>Edit the <em>host-slave.xml</em> file to change the bind addresses used or override them on the command line</p>
</li>
</ol>
</div>
<div class="sect4">
<h5 id="register-a-new-host-with-load-balancer"><a class="anchor" href="#register-a-new-host-with-load-balancer"></a>Register a New Host With Load Balancer</h5>
<div class="paragraph">
<p>Let&#8217;s look first at registering the new host slave with the load balancer configuration in <em>domain.xml</em>.  Open this
file and go to the undertow configuration in the <code>load-balancer</code> profile.  Add a new <code>host</code> definition called
<code>remote-host3</code> within the <code>reverse-proxy</code> XML block.</p>
</div>
<div class="listingblock">
<div class="title">domain.xml reverse-proxy config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:3.1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  ...
  <span class="tag">&lt;handlers&gt;</span>
      <span class="tag">&lt;reverse-proxy</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lb-handler</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">host1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">instance-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myroute1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">host2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host2</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">instance-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myroute2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
         <span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">outbound-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">scheme</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ajp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">path</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">/</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">instance-id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">myroute3</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/reverse-proxy&gt;</span>
  <span class="tag">&lt;/handlers&gt;</span>
  ...
<span class="tag">&lt;/subsystem&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>output-socket-binding</code> is a logical name pointing to a <code>socket-binding</code> configured later in the <em>domain.xml</em> file.
the <code>instance-id</code> attribute must also be unique to the new host as this value is used by a cookie to enable sticky
sessions when load balancing.</p>
</div>
<div class="paragraph">
<p>Next go down to the <code>load-balancer-sockets</code> <code>socket-binding-group</code> and add the <code>outbound-socket-binding</code> for <code>remote-host3</code>.  This new
binding needs to point to the host and port of the new host.</p>
</div>
<div class="listingblock">
<div class="title">domain.xml outbound-socket-binding</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">load-balancer-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host1</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8159</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/outbound-socket-binding&gt;</span>
    <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host2</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8259</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/outbound-socket-binding&gt;</span>
    <span class="tag">&lt;outbound-socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">remote-host3</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;remote-destination</span> <span class="attribute-name">host</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">192.168.0.5</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">8259</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/outbound-socket-binding&gt;</span>
<span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="master-bind-addresses"><a class="anchor" href="#master-bind-addresses"></a>Master Bind Addresses</h5>
<div class="paragraph">
<p>Next thing you&#8217;ll have to do is to change the <code>public</code> and <code>management</code> bind addresses for the master host.  Either
edit the <em>domain.xml</em> file as discussed in the <a href="#_bind-address">Bind Addresses</a> chapter
or specify these bind addresses on the command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ domain.sh --host-config=host-master.xml -Djboss.bind.address=192.168.0.2 -Djboss.bind.address.management=192.168.0.2</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="host-slave-bind-addresses"><a class="anchor" href="#host-slave-bind-addresses"></a>Host Slave Bind Addresses</h5>
<div class="paragraph">
<p>Next you&#8217;ll have to change the <code>public</code>, <code>management</code>, and domain controller bind addresses (<code>jboss.domain.master-address</code>).  Either edit the
<em>host-slave.xml</em> file or specify them on the command line as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ domain.sh --host-config=host-slave.xml
     -Djboss.bind.address=192.168.0.5
      -Djboss.bind.address.management=192.168.0.5
       -Djboss.domain.master.address=192.168.0.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>The values of <code>jboss.bind.address</code> and <code>jboss.bind.addres.management</code> pertain to the host slave&#8217;s IP address.
The value of <code>jboss.domain.master.address</code> need to be the IP address of the domain controller which is the management address
of the master host.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="configuring-other-load-balancers"><a class="anchor" href="#configuring-other-load-balancers"></a>8.3.5. Configuring Other Load Balancers</h4>
<div class="paragraph">
<p>See <a href="https://docs.jboss.org/author/display/WFLY10/High+Availability+Guide">the load balancing</a> section in the <em>WildFly 10 Documentation</em> for information how to use other software-based load balancers.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="sticky-sessions"><a class="anchor" href="#sticky-sessions"></a>8.4. Sticky sessions</h3>
<div class="paragraph">
<p>Typical cluster deployment consists of the load balancer (reverse proxy) and 2 or more Keycloak servers on private network. For performance purposes,
it may be useful if load balancer forwards all requests related to particular browser session to the same Keycloak backend node.</p>
</div>
<div class="paragraph">
<p>The reason is, that Keycloak is using infinispan distributed cache under the covers for save data related to current authentication session and user session.
The Infinispan distributed caches are configured with one owner by default. That means that particular session is saved just on one cluster node and the other nodes need
to lookup the session remotely if they want to access it.</p>
</div>
<div class="paragraph">
<p>For example if authentication session with ID <code>123</code> is saved in the infinispan cache on <code>node1</code>, and then <code>node2</code> needs to lookup this session,
it needs to send the request to <code>node1</code> over the network to return the particular session entity.</p>
</div>
<div class="paragraph">
<p>It is beneficial if particular session entity is always available locally, which can be done with the help of sticky sessions.
The workflow in the cluster environment with the public frontend load balancer and two backend Keycloak nodes can be like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>User sends initial request to see the Keycloak login screen</p>
</li>
<li>
<p>This request is served by the frontend load balancer, which forwards it to some random node (eg. node1). Strictly said, the node doesn&#8217;t need to be random,
but can be chosen according to some other criterias (client IP address etc). It all depends on the implementation and configuration of underlying load balancer (reverse proxy).</p>
</li>
<li>
<p>Keycloak creates authentication session with random ID (eg. 123) and saves it to the Infinispan cache.</p>
</li>
<li>
<p>Infinispan distributed cache assigns the primary owner of the session based on the hash of session ID.
See <a href="http://infinispan.org/docs/8.2.x/user_guide/user_guide.html#distribution_mode">Infinispan documentation</a> for more details around this.
Let&#8217;s assume that infinispan assigned <code>node2</code> to be the owner of this session.</p>
</li>
<li>
<p>Keycloak creates the cookie <code>AUTH_SESSION_ID</code> with the format like <code>&lt;session-id&gt;.&lt;owner-node-id&gt;</code> . In our example case, it will be <code>123.node2</code> .</p>
</li>
<li>
<p>Response is returned to the user with the Keycloak login screen and the AUTH_SESSION_ID cookie in the browser</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From this point, it is beneficial if load balancer forwards all the next requests to the <code>node2</code> as this is the node, who is owner of the authentication session with ID <code>123</code>
and hence Infinispan can lookup this session locally. After authentication is finished, the authentication session is converted to user session, which will be also saved on
<code>node2</code> because it has same ID <code>123</code> .</p>
</div>
<div class="paragraph">
<p>The sticky session is not mandatory for the cluster setup, however it is good for performance for the reasons mentioned above. You need to configure your loadbalancer to sticky
over the <code>AUTH_SESSION_ID</code> cookie. How exactly do this is dependent on your loadbalancer.</p>
</div>
<div class="paragraph">
<p>Some loadbalancers can be configured to add the route information by themselves instead of rely on the backend Keycloak node. However adding the route by
the Keycloak is more clever as Keycloak knows, who is the owner of particular session entity and can route it to that node, which is not necessarily the local node.
We plan to support the setup where the route info won&#8217;t be added to AUTH_SESSION_ID cookie by the Keycloak server, but instead by the load balancer. However
adding the cookie by Keycloak would be still the preferred option.</p>
</div>
<div class="sect3">
<h4 id="example-cluster-setup-with-mod_cluster"><a class="anchor" href="#example-cluster-setup-with-mod_cluster"></a>8.4.1. Example cluster setup with mod_cluster</h4>
<div class="paragraph">
<p>In the example, we will use <a href="http://mod-cluster.jboss.org/">Mod Cluster</a> as load balancer. One of the key features of mod cluster is, that there is not much
configuration on the load balancer side. Instead it requires support on the backend node side. Backend nodes communicate with the load balancer through the
dedicated protocol called MCMP and they notify loadbalancer about various events (eg. node joined or left cluster, new application was deployed etc).</p>
</div>
<div class="paragraph">
<p>Example setup will consist of the one WildFly 10 load balancer node and two Keycloak nodes.</p>
</div>
<div class="paragraph">
<p>Clustering example require MULTICAST to be enabled on machine&#8217;s loopback network interface. This can be done by running the following commands under root privileges (on linux):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>route add -net 224.0.0.0 netmask 240.0.0.0 dev lo
ifconfig lo multicast</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="load-balancer-configuration"><a class="anchor" href="#load-balancer-configuration"></a>Load Balancer Configuration</h5>
<div class="paragraph">
<p>Unzip the WildFly 10 server somewhere. Assumption is location <code>EAP_LB</code></p>
</div>
<div class="paragraph">
<p>Edit <code>EAP_LB/standalone/configuration/standalone.xml</code> file. In the undertow subsystem add the mod_cluster configuration under filters like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:undertow:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
 ...
 <span class="tag">&lt;filters&gt;</span>
  ...
  <span class="tag">&lt;mod-cluster</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">modcluster</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">advertise-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">modcluster</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">advertise-frequency</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${modcluster.advertise-frequency:2000}</span><span class="delimiter">&quot;</span></span>
      <span class="attribute-name">management-socket-binding</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enable-http2</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
 <span class="tag">&lt;/filters&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and <code>filter-ref</code> under <code>default-host</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;host</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default-host</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alias</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">localhost</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    ...
    <span class="tag">&lt;filter-ref</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">modcluster</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/host&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then under <code>socket-binding-group</code> add this group:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">modcluster</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.modcluster.multicast.address:224.0.1.105}</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23364</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Save the file and run the server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd $WILDFLY_LB/bin
./standalone.sh</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="backend-node-configuration"><a class="anchor" href="#backend-node-configuration"></a>Backend node configuration</h5>
<div class="paragraph">
<p>Unzip the Keycloak server distribution to some location. Assuming location is <code>RHSSO_NODE1</code> .</p>
</div>
<div class="paragraph">
<p>Edit <code>RHSSO_NODE1/standalone/configuration/standalone-ha.xml</code> and configure datasource against the shared database.
See <a href="#_rdbms-setup-checklist">Database chapter</a> for more details.</p>
</div>
<div class="paragraph">
<p>In the undertow subsystem, add the <code>session-config</code> under the <code>servlet-container</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;servlet-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;session-cookie</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">AUTH_SESSION_ID</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">http-only</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    ...
<span class="tag">&lt;/servlet-container&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can configure <code>proxy-address-forwarding</code> as described in the chapter <a href="#_setting-up-a-load-balancer-or-proxy">Load Balancer</a> .
Note that mod_cluster uses AJP connector by default, so you need to configure that one.</p>
</div>
<div class="paragraph">
<p>That&#8217;s all as mod_cluster is already configured.</p>
</div>
<div class="paragraph">
<p>The node name of the Keycloak can be detected automatically based on the hostname of current server. However for more fine grained control,
it is recommended to use system property <code>jboss.node.name</code> to specify the node name directly. It is especially useful in case that you test with 2 backend nodes on
same physical server etc. So you can run the startup command like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd $RHSSO_NODE1
./standalone.sh -c standalone-ha.xml -Djboss.socket.binding.port-offset=100 -Djboss.node.name=node1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the second backend server in same way and run with different port offset and node name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>cd $RHSSO_NODE2
./standalone.sh -c standalone-ha.xml -Djboss.socket.binding.port-offset=200 -Djboss.node.name=node2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Access the server on <code><a href="http://localhost:8080/auth" class="bare">http://localhost:8080/auth</a></code> . Creation of admin user is possible just from local address and without load balancer (proxy) access,
so you first need to access backend node directly on <code><a href="http://localhost:8180/auth" class="bare">http://localhost:8180/auth</a></code> to create admin user.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="multicast-network-setup"><a class="anchor" href="#multicast-network-setup"></a>8.5. Multicast Network Setup</h3>
<div class="paragraph">
<p>Out of the box clustering support needs IP Multicast. Multicast is a network broadcast protocol. This protocol is used at boot time to discover and join the cluster. It is also used to broadcast messages for the replication and invalidation of distributed caches used by Keycloak.</p>
</div>
<div class="paragraph">
<p>The clustering subsystem for Keycloak runs on the JGroups stack. Out of the box, the bind addresses for clustering are bound to a private network interface with 127.0.0.1 as default IP address.
You have to edit your the <em>standalone-ha.xml</em> or <em>domain.xml</em> sections discussed in the <a href="#_bind-address">Bind Address</a> chapter.</p>
</div>
<div class="listingblock">
<div class="title">private network config</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;interfaces&gt;</span>
        ...
        <span class="tag">&lt;interface</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;inet-address</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.bind.address.private:127.0.0.1}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/interface&gt;</span>
    <span class="tag">&lt;/interfaces&gt;</span>
    <span class="tag">&lt;socket-binding-group</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">standard-sockets</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default-interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">public</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port-offset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.socket.binding.port-offset:0}</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        ...
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-mping</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.default.multicast.address:230.0.0.4}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">45700</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">7600</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-tcp-fd</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">57600</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">55200</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">${jboss.default.multicast.address:230.0.0.4}</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">45688</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jgroups-udp-fd</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">interface</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">54200</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;socket-binding</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">modcluster</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-address</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">224.0.1.105</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">multicast-port</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">23364</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        ...
    <span class="tag">&lt;/socket-binding-group&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Things you&#8217;ll want to configure are the <code>jboss.bind.address.private</code> and <code>jboss.default.multicast.address</code> as well as the ports of the services on the clustering stack.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is possible to cluster Keycloak without IP Multicast, but this topic is beyond the scope of this guide. For more information, see <a href="https://docs.jboss.org/author/display/WFLY10/JGroups+Subsystem">JGroups</a> in the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="securing-cluster-communication"><a class="anchor" href="#securing-cluster-communication"></a>8.6. Securing Cluster Communication</h3>
<div class="paragraph">
<p>When cluster nodes are isolated on a private network it requires access to the private network to be able to join a cluster or to view communication in the cluster. In addition you can also enable authentication and encryption for cluster communication. As long as your private network is secure it is not necessary to enable authentication and encryption. Keycloak does not send very sensitive information on the cluster in either case.</p>
</div>
<div class="paragraph">
<p>If you want to enable authentication and encryption for clustering communication see <a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_enterprise_application_platform/7.0/html/configuration_guide/configuring_high_availability#securing_cluster">Securing a Cluster</a> in the <em>JBoss EAP Configuration Guide</em>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_clustering_db_lock"><a class="anchor" href="#_clustering_db_lock"></a>8.7. Serialized Cluster Startup</h3>
<div class="paragraph">
<p>Keycloak cluster nodes are allowed to boot concurrenty.
When Keycloak server instance boots up it may do some database migration, importing, or first time initializations.
A DB lock is used to prevent start actions from conflicting with one another when cluster nodes boot up concurrently.</p>
</div>
<div class="paragraph">
<p>By default, the maximum timeout for this lock is 900 seconds.  If a node is waiting on this lock for more than the timeout
it will fail to boot.
Typically you won&#8217;t need to increase/decrease the default value, but just in case it&#8217;s possible to configure it in
<code>standalone.xml</code>, <code>standalone-ha.xml</code>, or <code>domain.xml</code> file in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dblock</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">jpa</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
            <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lockWaitTimeout</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">900</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/provider&gt;</span>
<span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="booting-the-cluster"><a class="anchor" href="#booting-the-cluster"></a>8.8. Booting the Cluster</h3>
<div class="paragraph">
<p>Booting Keycloak in a cluster depends on your <a href="#_operating-mode">operating mode</a></p>
</div>
<div class="listingblock">
<div class="title">Standalone Mode</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ bin/standalone.sh --server-config=standalone-ha.xml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Domain Mode</div>
<div class="content">
<pre class="CodeRay highlight"><code>$ bin/domain.sh --host-config=host-master.xml
$ bin/domain.sh --host-config=host-slave.xml</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="troubleshooting"><a class="anchor" href="#troubleshooting"></a>8.9. Troubleshooting</h3>
<div class="paragraph">
<p>Note that when you run cluster, you should see message similar to this in the log of both cluster nodes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>INFO  [org.infinispan.remoting.transport.jgroups.JGroupsTransport] (Incoming-10,shared=udp)
ISPN000094: Received new cluster view: [node1/keycloak|1] (2) [node1/keycloak, node2/keycloak]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you see just one node mentioned, it&#8217;s possible that your cluster hosts are not joined together.</p>
</div>
<div class="paragraph">
<p>Usually it&#8217;s best practice to have your cluster nodes on private network without firewall for communication among them.
Firewall could be enabled just on public access point to your network instead.
If for some reason you still need to have firewall enabled on cluster nodes, you will need to open some ports.
Default values are UDP port 55200 and multicast port 45688 with multicast address 230.0.0.4.
Note that you may need more ports opened if you want to enable additional features like diagnostics for your JGroups stack.
Keycloak delegates most of the clustering work to Infinispan/JGroups.
For more information, see <a href="https://docs.jboss.org/author/display/WFLY10/JGroups+Subsystem">JGroups</a> in the <em>WildFly 10 Documentation</em>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-cache-configuration"><a class="anchor" href="#server-cache-configuration"></a>9. Server Cache Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak has two types of caches.  One type of cache sits in front of the database to decrease load on the DB
and to increase overall response times by keeping data in memory.  Realm, client, role, and user metadata is kept in this type of cache.
This cache is a local cache.  Local caches do not use replication even if you are in the cluster with more Keycloak servers.
Instead, they only keep copies locally and if the entry is updated an invalidation message is sent to the rest of the cluster
and the entry is evicted. There is separate replicated cache <code>work</code>, which task is to send the invalidation messages to the whole cluster about what entries
 should be evicted from local caches. This greatly reduces network traffic, makes things efficient, and avoids transmitting sensitive
metadata over the wire.</p>
</div>
<div class="paragraph">
<p>The second type of cache handles managing user sessions, offline tokens, and keeping track of login failures so that the
server can detect password phishing and other attacks.  The data held in these caches is temporary, in memory only,
but is possibly replicated across the cluster.</p>
</div>
<div class="paragraph">
<p>This chapter discusses some configuration options for these caches for both clustered a non-clustered deployments.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
More advanced configuration of these caches can be found in the  <a href="https://docs.jboss.org/author/display/WFLY10/Infinispan+Subsystem">Infinispan</a> section of the <em>WildFly 10 Documentation</em>.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="eviction-and-expiration"><a class="anchor" href="#eviction-and-expiration"></a>9.1. Eviction and Expiration</h3>
<div class="paragraph">
<p>There are multiple different caches configured for Keycloak.
There is a realm cache that holds information about secured applications, general security data, and configuration options.
There is also a user cache that contains user metadata.  Both caches default to a maximum of 10000 entries and use a least recently used eviction strategy.
Each of them is also tied to an object revisions cache that controls eviction in a clustered setup.
This cache is created implicitely and has twice the configured size.
There are also separate caches for user sessions, offline tokens, and login failures.  These caches are unbounded in size as well.</p>
</div>
<div class="paragraph">
<p>The eviction policy and max entries for these caches can be configured in the <em>standalone.xml</em>, <em>standalone-ha.xml</em>, or
<em>domain.xml</em> depending on your <a href="#_operating-mode">operating mode</a>.</p>
</div>
<div class="listingblock">
<div class="title">non-clustered</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:infinispan:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan/Keycloak</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realms</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;eviction</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;eviction</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineSessions</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginFailures</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authorization</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
           <span class="tag">&lt;eviction</span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">100</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;eviction</span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;expiration</span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3600000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">clustered</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:infinispan:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan/Keycloak</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;transport</span> <span class="attribute-name">lock-timeout</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">60000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realms</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;eviction</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">users</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;eviction</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">10000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">offlineSessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">loginFailures</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">authorization</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;replicated-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">work</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;local-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keys</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;eviction</span> <span class="attribute-name">max-entries</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">1000</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">strategy</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LRU</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;expiration</span> <span class="attribute-name">max-idle</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3600000</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/local-cache&gt;</span>
    <span class="tag">&lt;/cache-container&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To limit or expand the number of allowed entries simply add or edit the <code>eviction</code> element or the <code>expiration</code> element of particular cache
configuration.</p>
</div>
</div>
<div class="sect2">
<h3 id="replication-and-failover"><a class="anchor" href="#replication-and-failover"></a>9.2. Replication and Failover</h3>
<div class="paragraph">
<p>The <code>sessions</code>, <code>authenticationSessions</code>, <code>offlineSessions</code> and <code>loginFailures</code> caches are the only caches that may perform replication.  Entries are
not replicated to every single node, but instead one or more nodes is chosen as an owner of that data.  If a node is not the owner of a specific cache entry it queries
the cluster to obtain it.  What this means for failover is that if all the nodes that own a piece of data go down, that data
is lost forever.  By default, Keycloak only specifies one owner for data.  So if that one node goes down
that data is lost.  This usually means that users will be logged out and will have to login again.</p>
</div>
<div class="paragraph">
<p>You can change the number of nodes that replicate a piece of data by change the <code>owners</code> attribute in the <code>distributed-cache</code> declaration.</p>
</div>
<div class="listingblock">
<div class="title">owners</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;subsystem</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">urn:jboss:domain:infinispan:4.0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
   <span class="tag">&lt;cache-container</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">keycloak</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">jndi-name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">infinispan/Keycloak</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
       <span class="tag">&lt;distributed-cache</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sessions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">mode</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">SYNC</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">owners</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we&#8217;ve changed it so at least two nodes will replicate one specific user login session.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The number of owners recommended is really dependent on your deployment.  If you do not care if users are logged
      out when a node goes down, then one owner is good enough and you will avoid replication.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="disabling-caching"><a class="anchor" href="#disabling-caching"></a>9.3. Disabling Caching</h3>
<div class="paragraph">
<p>To disable the realm or user cache, you must edit the <code>standalone.xml</code>, <code>standalone-ha.xml</code>,
 or <code>domain.xml</code> file in your distribution.  The location of this file
depends on your <a href="#_operating-mode">operating mode</a>.
Here&#8217;s what the config looks like initially.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml">    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">userCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/spi&gt;</span>

    <span class="tag">&lt;spi</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">realmCache</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;provider</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">default</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">enabled</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/spi&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To disable the cache set the <code>enabled</code> attribute to false for the cache you want to disable.  You must reboot your
server for this change to take effect.</p>
</div>
</div>
<div class="sect2">
<h3 id="clearing-caches-at-runtime"><a class="anchor" href="#clearing-caches-at-runtime"></a>9.4. Clearing Caches at Runtime</h3>
<div class="paragraph">
<p>To clear the realm or user cache, go to the Keycloak admin console Realm Settings&#8594;Cache Config page.
On this page you can clear the realm cache, the user cache or cache of external public keys.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The cache will be cleared for all realms!
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_proxy"><a class="anchor" href="#_proxy"></a>10. Keycloak Security Proxy</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Keycloak has an HTTP(S) proxy that you can put in front of web applications and services where it is not possible to install the Keycloak adapter.
You can set up URL filters so that certain URLs are secured either by browser login and/or bearer token authentication.
You can also define role constraints for URL patterns within your applications.</p>
</div>
<div class="sect2">
<h3 id="proxy-install-and-run"><a class="anchor" href="#proxy-install-and-run"></a>10.1. Proxy Install and Run</h3>
<div class="paragraph">
<p>Download the Keycloak proxy distribution from the Keycloak download pages and unzip it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ unzip keycloak-proxy-dist.zip</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run it you must have a proxy config file (which we&#8217;ll discuss in a moment).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>$ java -jar bin/launcher.jar [your-config.json]</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do not specify a path to the proxy config file, the launcher will look in the current working directory for the file named <code>proxy.json</code></p>
</div>
</div>
<div class="sect2">
<h3 id="proxy-configuration"><a class="anchor" href="#proxy-configuration"></a>10.2. Proxy Configuration</h3>
<div class="paragraph">
<p>Here&#8217;s an example configuration file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
    "target-url": "http://localhost:8082",
    "send-access-token": true,
    "bind-address": "localhost",
    "http-port": "8080",
    "https-port": "8443",
    "keystore": "classpath:ssl.jks",
    "keystore-password": "password",
    "key-password": "password",
    "applications": [
        {
            "base-path": "/customer-portal",
            "error-page": "/error.html",
            "adapter-config": {
                "realm": "demo",
                "resource": "customer-portal",
                "realm-public-key": "MIGfMA0GCSqGSIb",
                "auth-server-url": "http://localhost:8081/auth",
                "ssl-required" : "external",
                "principal-attribute": "name",
                "credentials": {
                    "secret": "password"
                }
            }
            ,
            "constraints": [
                {
                    "pattern": "/users/*",
                    "roles-allowed": [
                        "user"
                    ]
                },
                {
                    "pattern": "/admins/*",
                    "roles-allowed": [
                        "admin"
                    ]
                },
                {
                    "pattern": "/users/permit",
                    "permit": true
                },
                {
                    "pattern": "/users/deny",
                    "deny": true
                }
            ]
        }
    ]
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="basic-config"><a class="anchor" href="#basic-config"></a>10.2.1. Basic Config</h4>
<div class="paragraph">
<p>The basic configuration options for the server are as follows:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">target-url</dt>
<dd>
<p>The URL this server is proxying <em>REQUIRED.</em>.</p>
</dd>
<dt class="hdlist1">send-access-token</dt>
<dd>
<p>Boolean flag.
If true, this will send the access token via the KEYCLOAK_ACCESS_TOKEN header to the proxied server. <em>OPTIONAL.</em>.
Default is false.</p>
</dd>
<dt class="hdlist1">bind-address</dt>
<dd>
<p>DNS name or IP address to bind the proxy server&#8217;s sockets to. <em>OPTIONAL.</em>.
The default value is <em>localhost</em></p>
</dd>
<dt class="hdlist1">http-port</dt>
<dd>
<p>Port to listen for HTTP requests.
If you do not specify this value, then the proxy will not listen for regular HTTP requests. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">https-port</dt>
<dd>
<p>Port to listen for HTTPS requests.
If you do not specify this value, then the proxy will not listen for HTTPS requests. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">keystore</dt>
<dd>
<p>Path to a Java keystore file that contains private key and certificate for the server to be able to handle HTTPS requests.
Can be a file path, or, if you prefix it with <code>classpath:</code>                            it will look for this file in the classpath. <em>OPTIONAL.</em>.
If you have enabled HTTPS, but have not defined a keystore, the proxy will auto-generate a self-signed certificate and use that.</p>
</dd>
<dt class="hdlist1">buffer-size</dt>
<dd>
<p>HTTP server socket buffer size.
Usually the default is good enough. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">buffers-per-region</dt>
<dd>
<p>HTTP server socket buffers per region.
Usually the default is good enough. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">io-threads</dt>
<dd>
<p>Number of threads to handle IO.
Usually default is good enough.
 <em>OPTIONAL.</em>.
The default is the number of available processors * 2.</p>
</dd>
<dt class="hdlist1">worker-threads</dt>
<dd>
<p>Number of threads to handle requests.
Usually the default is good enough. <em>OPTIONAL.</em>.
The default is the number of available processors * 16.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="application-config"><a class="anchor" href="#application-config"></a>10.3. Application Config</h3>
<div class="paragraph">
<p>Next under the <code>applications</code> array attribute, you can define one or more applications per host you are proxying.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">base-path</dt>
<dd>
<p>The base context root for the application.
Must start with '/' <em>REQUIRED.</em>.</p>
</dd>
<dt class="hdlist1">error-page</dt>
<dd>
<p>If the proxy has an error, it will display the target application&#8217;s error page relative URL <em>OPTIONAL.</em>.
This is a relative path to the base-path.
In the example above it would be <code>/customer-portal/error.html</code>.</p>
</dd>
<dt class="hdlist1">adapter-config</dt>
<dd>
<p><em>REQUIRED.</em>.
Same configuration as any other Keycloak adapter.</p>
</dd>
</dl>
</div>
<div class="sect3">
<h4 id="constraint-config"><a class="anchor" href="#constraint-config"></a>10.3.1. Constraint Config</h4>
<div class="paragraph">
<p>Next under each application you can define one or more constraints in the <code>constraints</code> array attribute.
A constraint defines a URL pattern relative to the base-path.
You can deny, permit, or require authentication for a specific URL pattern.
You can specify roles allowed for that path as well.
More specific constraints will take precedence over more general ones.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">pattern</dt>
<dd>
<p>URL pattern to match relative to the base-path of the application.
Must start with '/' <em>REQUIRED.</em>
You may only have one wildcard and it must come at the end of the pattern.</p>
<div class="ulist">
<ul>
<li>
<p>Valid: <code>/foo/bar/*</code> and  <code>/foo/*.txt</code></p>
</li>
<li>
<p>Not valid: <code>/*/foo/*</code>.</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1">roles-allowed</dt>
<dd>
<p>Array of strings of roles allowed to access this url pattern. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">methods</dt>
<dd>
<p>Array of strings of HTTP methods that will exclusively match this pattern and HTTP request. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">excluded-methods</dt>
<dd>
<p>Array of strings of HTTP methods that will be ignored when match this pattern. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">deny</dt>
<dd>
<p>Deny all access to this URL pattern. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">permit</dt>
<dd>
<p>Permit all access without requiring authentication or a role mapping. <em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">permit-and-inject</dt>
<dd>
<p>Permit all access, but inject the headers, if user is already authenticated.<em>OPTIONAL.</em>.</p>
</dd>
<dt class="hdlist1">authenticate</dt>
<dd>
<p>Require authentication for this pattern, but no role mapping. <em>OPTIONAL.</em>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="header-names-config"><a class="anchor" href="#header-names-config"></a>10.3.2. Header Names Config</h4>
<div class="paragraph">
<p>Next under the list of applications you can override the defaults for the names of the header fields injected by the proxy (see Keycloak Identity Headers). This mapping is optional.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">keycloak-subject</dt>
<dd>
<p>e.g.
MYAPP_USER_ID</p>
</dd>
<dt class="hdlist1">keycloak-username</dt>
<dd>
<p>e.g.
MYAPP_USER_NAME</p>
</dd>
<dt class="hdlist1">keycloak-email</dt>
<dd>
<p>e.g.
MYAPP_USER_EMAIL</p>
</dd>
<dt class="hdlist1">keycloak-name</dt>
<dd>
<p>e.g.
MYAPP_USER_ID</p>
</dd>
<dt class="hdlist1">keycloak-access-token</dt>
<dd>
<p>e.g.
MYAPP_ACCESS_TOKEN</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="keycloak-identity-headers"><a class="anchor" href="#keycloak-identity-headers"></a>10.4. Keycloak Identity Headers</h3>
<div class="paragraph">
<p>When forwarding requests to the proxied server, Keycloak Proxy will set some additional headers with values from the OIDC identity token it received for authentication.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">KEYCLOAK_SUBJECT</dt>
<dd>
<p>User id.
Corresponds to JWT <code>sub</code> and will be the user id Keycloak uses to store this user.</p>
</dd>
<dt class="hdlist1">KEYCLOAK_USERNAME</dt>
<dd>
<p>Username.
Corresponds to JWT <code>preferred_username</code></p>
</dd>
<dt class="hdlist1">KEYCLOAK_EMAIL</dt>
<dd>
<p>Email address of user if set.</p>
</dd>
<dt class="hdlist1">KEYCLOAK_NAME</dt>
<dd>
<p>Full name of user if set.</p>
</dd>
<dt class="hdlist1">KEYCLOAK_ACCESS_TOKEN</dt>
<dd>
<p>Send the access token in this header if the proxy was configured to send it.
This token can be used to make bearer token requests.             Header field names can be configured using a map of <code>header-names</code> in configuration file:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code>{
    "header-names" {
        "keycloak-subject": "MY_SUBJECT"
    }
}</code></pre>
</div>
</div>
</dd>
</dl>
</div>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnote_1">
<a href="#_footnoteref_1">1</a>. Tracked as <a href="https://issues.jboss.org/browse/KEYCLOAK-3873" class="bare">https://issues.jboss.org/browse/KEYCLOAK-3873</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2017-11-16 12:20:11 UTC
</div>
</div>
<ul id="globalnav">
    <li><a href="../getting_started/index.html">Getting Started</a></li>
    <li><a href="../server_installation/index.html">Server Installation</a></li>
    <li><a href="../securing_apps/index.html">Securing Apps</a></li>
    <li><a href="../server_admin/index.html">Server Admin</a></li>
    <li><a href="../server_development/index.html">Server Development</a></li>
    <li><a href="../authorization_services/index.html">Authorization Services</a></li>
    <li><a href="../upgrading/index.html">Upgrading</a></li>
</ul>
</body>
</html>